{"version":3,"sources":["bliss.shy.min.js","jsep.min.js","stretchy.min.js","mavo.js","util.js","locale.js","locale.en.js","plugins.js","ui.bar.js","ui.message.js","permissions.js","backend.js","formats.js","node.js","group.js","primitive.js","ui.popup.js","elements.js","collection.js","ui.itembar.js","expression.js","domexpression.js","expressions.js","mv-if.js","functions.js","mavoscript.js","backend.dropbox.js","backend.github.js"],"names":[],"mappings":"AAAA;ACAA;AACA;AACA;ACFA;AACA;AACA;AACA;AACA;ACJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5wBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5OA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7TA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpuBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACt1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxmBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/oBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACphBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"../mavo.js","sourcesContent":["!function(){\"use strict\";function t(e,n,i){return n=void 0===n?1:n,i=i||n+1,i-n<=1?function(){if(arguments.length<=n||\"string\"===r.type(arguments[n]))return e.apply(this,arguments);var t,i=arguments[n];for(var o in i){var s=Array.prototype.slice.call(arguments);s.splice(n,1,o,i[o]),t=e.apply(this,s)}return t}:t(t(e,n+1,i),n,i-1)}function e(t,r,i){var o=n(i);if(\"string\"===o){var s=Object.getOwnPropertyDescriptor(r,i);!s||s.writable&&s.configurable&&s.enumerable&&!s.get&&!s.set?t[i]=r[i]:(delete t[i],Object.defineProperty(t,i,s))}else if(\"array\"===o)i.forEach(function(n){n in r&&e(t,r,n)});else for(var a in r)i&&(\"regexp\"===o&&!i.test(a)||\"function\"===o&&!i.call(r,a))||e(t,r,a);return t}function n(t){if(null===t)return\"null\";if(void 0===t)return\"undefined\";var e=(Object.prototype.toString.call(t).match(/^\\[object\\s+(.*?)\\]$/)[1]||\"\").toLowerCase();return\"number\"==e&&isNaN(t)?\"nan\":e}var r=self.Bliss=e(function(t,e){return 2==arguments.length&&!e||!t?null:\"string\"===r.type(t)?(e||document).querySelector(t):t||null},self.Bliss);e(r,{extend:e,overload:t,type:n,property:r.property||\"_\",listeners:self.WeakMap?new WeakMap:new Map,original:{addEventListener:(self.EventTarget||Node).prototype.addEventListener,removeEventListener:(self.EventTarget||Node).prototype.removeEventListener},sources:{},noop:function(){},$:function(t,e){return t instanceof Node||t instanceof Window?[t]:2!=arguments.length||e?Array.prototype.slice.call(\"string\"==typeof t?(e||document).querySelectorAll(t):t||[]):[]},defined:function(){for(var t=0;t<arguments.length;t++)if(void 0!==arguments[t])return arguments[t]},create:function(t,e){return t instanceof Node?r.set(t,e):(1===arguments.length&&(\"string\"===r.type(t)?e={}:(e=t,t=e.tag,e=r.extend({},e,function(t){return\"tag\"!==t}))),r.set(document.createElement(t||\"div\"),e))},each:function(t,e,n){n=n||{};for(var r in t)n[r]=e.call(t,r,t[r]);return n},ready:function(t,e,n){if(\"function\"!=typeof t||e||(e=t,t=void 0),t=t||document,e&&(\"loading\"!==t.readyState?e():r.once(t,\"DOMContentLoaded\",function(){e()})),!n)return new Promise(function(e){r.ready(t,e,!0)})},Class:function(t){var e,n=[\"constructor\",\"extends\",\"abstract\",\"static\"].concat(Object.keys(r.classProps)),i=t.hasOwnProperty(\"constructor\")?t.constructor:r.noop;2==arguments.length?(e=arguments[0],t=arguments[1]):(e=function(){if(this.constructor.__abstract&&this.constructor===e)throw new Error(\"Abstract classes cannot be directly instantiated.\");e[\"super\"]&&e[\"super\"].apply(this,arguments),i.apply(this,arguments)},e[\"super\"]=t[\"extends\"]||null,e.prototype=r.extend(Object.create(e[\"super\"]?e[\"super\"].prototype:Object),{constructor:e}),e.prototype[\"super\"]=e[\"super\"]?e[\"super\"].prototype:null,e.__abstract=!!t[\"abstract\"]);var o=function(t){return this.hasOwnProperty(t)&&n.indexOf(t)===-1};if(t[\"static\"]){r.extend(e,t[\"static\"],o);for(var s in r.classProps)s in t[\"static\"]&&r.classProps[s](e,t[\"static\"][s])}r.extend(e.prototype,t,o);for(var s in r.classProps)s in t&&r.classProps[s](e.prototype,t[s]);return e},classProps:{lazy:t(function(t,e,n){return Object.defineProperty(t,e,{get:function(){var t=n.call(this);return Object.defineProperty(this,e,{value:t,configurable:!0,enumerable:!0,writable:!0}),t},set:function(t){Object.defineProperty(this,e,{value:t,configurable:!0,enumerable:!0,writable:!0})},configurable:!0,enumerable:!0}),t}),live:t(function(t,e,n){return\"function\"===r.type(n)&&(n={set:n}),Object.defineProperty(t,e,{get:function(){var t=this[\"_\"+e],r=n.get&&n.get.call(this,t);return void 0!==r?r:t},set:function(t){var r=this[\"_\"+e],i=n.set&&n.set.call(this,t,r);this[\"_\"+e]=void 0!==i?i:t},configurable:n.configurable,enumerable:n.enumerable}),t})},include:function(){var t=arguments[arguments.length-1],e=2===arguments.length&&arguments[0],n=document.createElement(\"script\");return e?Promise.resolve():new Promise(function(e,i){r.set(n,{async:!0,onload:function(){e(),n.parentNode&&n.parentNode.removeChild(n)},onerror:function(){i()},src:t,inside:document.head})})},fetch:function(t,n){if(!t)throw new TypeError(\"URL parameter is mandatory and cannot be \"+t);var i=e({url:new URL(t,location),data:\"\",method:\"GET\",headers:{},xhr:new XMLHttpRequest},n);i.method=i.method.toUpperCase(),r.hooks.run(\"fetch-args\",i),\"GET\"===i.method&&i.data&&(i.url.search+=i.data),document.body.setAttribute(\"data-loading\",i.url),i.xhr.open(i.method,i.url.href,i.async!==!1,i.user,i.password);for(var o in n)if(\"upload\"===o)i.xhr.upload&&\"object\"==typeof n[o]&&r.extend(i.xhr.upload,n[o]);else if(o in i.xhr)try{i.xhr[o]=n[o]}catch(s){self.console&&console.error(s)}var a=Object.keys(i.headers).map(function(t){return t.toLowerCase()});\"GET\"!==i.method&&a.indexOf(\"content-type\")===-1&&i.xhr.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\");for(var c in i.headers)void 0!==i.headers[c]&&i.xhr.setRequestHeader(c,i.headers[c]);var u=new Promise(function(t,e){i.xhr.onload=function(){document.body.removeAttribute(\"data-loading\"),0===i.xhr.status||i.xhr.status>=200&&i.xhr.status<300||304===i.xhr.status?t(i.xhr):e(r.extend(Error(i.xhr.statusText),{xhr:i.xhr,get status(){return this.xhr.status}}))},i.xhr.onerror=function(){document.body.removeAttribute(\"data-loading\"),e(r.extend(Error(\"Network Error\"),{xhr:i.xhr}))},i.xhr.ontimeout=function(){document.body.removeAttribute(\"data-loading\"),e(r.extend(Error(\"Network Timeout\"),{xhr:i.xhr}))},i.xhr.send(\"GET\"===i.method?null:i.data)});return u.xhr=i.xhr,u},value:function(t){var e=\"string\"!==r.type(t);return r.$(arguments).slice(+e).reduce(function(t,e){return t&&t[e]},e?t:self)}}),r.Hooks=new r.Class({add:function(t,e,n){if(\"string\"==typeof arguments[0])(Array.isArray(t)?t:[t]).forEach(function(t){this[t]=this[t]||[],e&&this[t][n?\"unshift\":\"push\"](e)},this);else for(var t in arguments[0])this.add(t,arguments[0][t],arguments[1])},run:function(t,e){this[t]=this[t]||[],this[t].forEach(function(t){t.call(e&&e.context?e.context:e,e)})}}),r.hooks=new r.Hooks;r.property;r.Element=function(t){this.subject=t,this.data={},this.bliss={}},r.Element.prototype={set:t(function(t,e){t in r.setProps?r.setProps[t].call(this,e):t in this?this[t]=e:this.setAttribute(t,e)},0),transition:function(t,e){return e=+e||400,new Promise(function(n,i){if(\"transition\"in this.style){var o=r.extend({},this.style,/^transition(Duration|Property)$/);r.style(this,{transitionDuration:(e||400)+\"ms\",transitionProperty:Object.keys(t).join(\", \")}),r.once(this,\"transitionend\",function(){clearTimeout(s),r.style(this,o),n(this)});var s=setTimeout(n,e+50,this);r.style(this,t)}else r.style(this,t),n(this)}.bind(this))},fire:function(t,e){var n=document.createEvent(\"HTMLEvents\");return n.initEvent(t,!0,!0),this.dispatchEvent(r.extend(n,e))},bind:t(function(t,e){if(arguments.length>1&&(\"function\"===r.type(e)||e.handleEvent)){var n=e;e=\"object\"===r.type(arguments[2])?arguments[2]:{capture:!!arguments[2]},e.callback=n}var i=r.listeners.get(this)||{};t.trim().split(/\\s+/).forEach(function(t){if(t.indexOf(\".\")>-1){t=t.split(\".\");var n=t[1];t=t[0]}i[t]=i[t]||[],0===i[t].filter(function(t){return t.callback===e.callback&&t.capture==e.capture}).length&&i[t].push(r.extend({className:n},e)),r.original.addEventListener.call(this,t,e.callback,e)},this),r.listeners.set(this,i)},0),unbind:t(function(t,e){if(e&&(\"function\"===r.type(e)||e.handleEvent)){var n=e;e=arguments[2]}\"boolean\"==r.type(e)&&(e={capture:e}),e=e||{},e.callback=e.callback||n;var i=r.listeners.get(this);(t||\"\").trim().split(/\\s+/).forEach(function(t){if(t.indexOf(\".\")>-1){t=t.split(\".\");var n=t[1];t=t[0]}if(t&&e.callback)return r.original.removeEventListener.call(this,t,e.callback,e.capture);if(i)for(var o in i)if(!t||o===t)for(var s,a=0;s=i[o][a];a++)n&&n!==s.className||e.callback&&e.callback!==s.callback||!!e.capture!=!!s.capture||(i[o].splice(a,1),r.original.removeEventListener.call(this,o,s.callback,s.capture),a--)},this)},0)},r.setProps={style:function(t){for(var e in t)e in this.style?this.style[e]=t[e]:this.style.setProperty(e,t[e])},attributes:function(t){for(var e in t)this.setAttribute(e,t[e])},properties:function(t){r.extend(this,t)},events:function(t){if(1!=arguments.length||!t||!t.addEventListener)return r.bind.apply(this,[this].concat(r.$(arguments)));var e=this;if(r.listeners){var n=r.listeners.get(t);for(var i in n)n[i].forEach(function(t){r.bind(e,i,t.callback,t.capture)})}for(var o in t)0===o.indexOf(\"on\")&&(this[o]=t[o])},once:t(function(t,e){var n=this,i=function(){return r.unbind(n,t,i),e.apply(n,arguments)};r.bind(this,t,i,{once:!0})},0),delegate:t(function(t,e,n){r.bind(this,t,function(t){t.target.closest(e)&&n.call(this,t)})},0,2),contents:function(t){(t||0===t)&&(Array.isArray(t)?t:[t]).forEach(function(t){var e=r.type(t);/^(string|number)$/.test(e)?t=document.createTextNode(t+\"\"):\"object\"===e&&(t=r.create(t)),t instanceof Node&&this.appendChild(t)},this)},inside:function(t){t&&t.appendChild(this)},before:function(t){t&&t.parentNode.insertBefore(this,t)},after:function(t){t&&t.parentNode.insertBefore(this,t.nextSibling)},start:function(t){t&&t.insertBefore(this,t.firstChild)},around:function(t){t&&t.parentNode&&r.before(this,t),this.appendChild(t)}},r.Array=function(t){this.subject=t},r.Array.prototype={all:function(t){var e=r.$(arguments).slice(1);return this[t].apply(this,e)}},r.add=t(function(t,e,n,i){n=r.extend({$:!0,element:!0,array:!0},n),\"function\"==r.type(e)&&(!n.element||t in r.Element.prototype&&i||(r.Element.prototype[t]=function(){return this.subject&&r.defined(e.apply(this.subject,arguments),this.subject)}),!n.array||t in r.Array.prototype&&i||(r.Array.prototype[t]=function(){var t=arguments;return this.subject.map(function(n){return n&&r.defined(e.apply(n,t),n)})}),n.$&&(r.sources[t]=r[t]=e,(n.array||n.element)&&(r[t]=function(){var e=[].slice.apply(arguments),i=e.shift(),o=n.array&&Array.isArray(i)?\"Array\":\"Element\";return r[o].prototype[t].apply({subject:i},e)})))},0),r.add(r.Array.prototype,{element:!1}),r.add(r.Element.prototype),r.add(r.setProps),r.add(r.classProps,{element:!1,array:!1});var i=document.createElement(\"_\");r.add(r.extend({},HTMLElement.prototype,function(t){return\"function\"===r.type(i[t])}),null,!0)}();","/* jsep v0.3.2 (http://jsep.from.so/) */\n!function(e){\"use strict\";var r=function(e,r){var t=new Error(e+\" at character \"+r);throw t.index=r,t.description=e,t},t={\"-\":!0,\"!\":!0,\"~\":!0,\"+\":!0},n={\"||\":1,\"&&\":2,\"|\":3,\"^\":4,\"&\":5,\"==\":6,\"!=\":6,\"===\":6,\"!==\":6,\"<\":7,\">\":7,\"<=\":7,\">=\":7,\"<<\":8,\">>\":8,\">>>\":8,\"+\":9,\"-\":9,\"*\":10,\"/\":10,\"%\":10},o=function(e){var r,t=0;for(var n in e)(r=n.length)>t&&e.hasOwnProperty(n)&&(t=r);return t},i=o(t),a=o(n),u={true:!0,false:!1,null:null},s=function(e){return n[e]||0},p=function(e,r,t){return{type:\"||\"===e||\"&&\"===e?\"LogicalExpression\":\"BinaryExpression\",operator:e,left:r,right:t}},f=function(e){return e>=48&&e<=57},c=function(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=128&&!n[String.fromCharCode(e)]},l=function(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=48&&e<=57||e>=128&&!n[String.fromCharCode(e)]},d=function(e){for(var o,d,h=0,v=e.charAt,x=e.charCodeAt,y=function(r){return v.call(e,r)},m=function(r){return x.call(e,r)},b=e.length,E=function(){for(var e=m(h);32===e||9===e||10===e||13===e;)e=m(++h)},g=function(){var e,t,n=w();return E(),63!==m(h)?n:(h++,(e=g())||r(\"Expected expression\",h),E(),58===m(h)?(h++,(t=g())||r(\"Expected expression\",h),{type:\"ConditionalExpression\",test:n,consequent:e,alternate:t}):void r(\"Expected :\",h))},C=function(){E();for(var r=e.substr(h,a),t=r.length;t>0;){if(n.hasOwnProperty(r))return h+=t,r;r=r.substr(0,--t)}return!1},w=function(){var e,t,n,o,i,a,u,f;if(a=O(),!(t=C()))return a;for(i={value:t,prec:s(t)},(u=O())||r(\"Expected expression after \"+t,h),o=[a,i,u];(t=C())&&0!==(n=s(t));){for(i={value:t,prec:n};o.length>2&&n<=o[o.length-2].prec;)u=o.pop(),t=o.pop().value,a=o.pop(),e=p(t,a,u),o.push(e);(e=O())||r(\"Expected expression after \"+t,h),o.push(i,e)}for(e=o[f=o.length-1];f>1;)e=p(o[f-1].value,o[f-2],e),f-=2;return e},O=function(){var r,n,o;if(E(),r=m(h),f(r)||46===r)return U();if(39===r||34===r)return k();if(91===r)return S();for(o=(n=e.substr(h,i)).length;o>0;){if(t.hasOwnProperty(n))return h+=o,{type:\"UnaryExpression\",operator:n,argument:O(),prefix:!0};n=n.substr(0,--o)}return!(!c(r)&&40!==r)&&A()},U=function(){for(var e,t,n=\"\";f(m(h));)n+=y(h++);if(46===m(h))for(n+=y(h++);f(m(h));)n+=y(h++);if(\"e\"===(e=y(h))||\"E\"===e){for(n+=y(h++),\"+\"!==(e=y(h))&&\"-\"!==e||(n+=y(h++));f(m(h));)n+=y(h++);f(m(h-1))||r(\"Expected exponent (\"+n+y(h)+\")\",h)}return t=m(h),c(t)?r(\"Variable names cannot start with a number (\"+n+y(h)+\")\",h):46===t&&r(\"Unexpected period\",h),{type:\"Literal\",value:parseFloat(n),raw:n}},k=function(){for(var e,t=\"\",n=y(h++),o=!1;h<b;){if((e=y(h++))===n){o=!0;break}if(\"\\\\\"===e)switch(e=y(h++)){case\"n\":t+=\"\\n\";break;case\"r\":t+=\"\\r\";break;case\"t\":t+=\"\\t\";break;case\"b\":t+=\"\\b\";break;case\"f\":t+=\"\\f\";break;case\"v\":t+=\"\\v\";break;default:t+=e}else t+=e}return o||r('Unclosed quote after \"'+t+'\"',h),{type:\"Literal\",value:t,raw:n+t+n}},L=function(){var t,n=m(h),o=h;for(c(n)?h++:r(\"Unexpected \"+y(h),h);h<b&&(n=m(h),l(n));)h++;return t=e.slice(o,h),u.hasOwnProperty(t)?{type:\"Literal\",value:u[t],raw:t}:\"this\"===t?{type:\"ThisExpression\"}:{type:\"Identifier\",name:t}},j=function(e){for(var t,n,o=[],i=!1;h<b;){if(E(),(t=m(h))===e){i=!0,h++;break}44===t?h++:((n=g())&&\"Compound\"!==n.type||r(\"Expected comma\",h),o.push(n))}return i||r(\"Expected \"+String.fromCharCode(e),h),o},A=function(){var e,t;for(t=40===(e=m(h))?P():L(),E(),e=m(h);46===e||91===e||40===e;)h++,46===e?(E(),t={type:\"MemberExpression\",computed:!1,object:t,property:L()}):91===e?(t={type:\"MemberExpression\",computed:!0,object:t,property:g()},E(),93!==(e=m(h))&&r(\"Unclosed [\",h),h++):40===e&&(t={type:\"CallExpression\",arguments:j(41),callee:t}),E(),e=m(h);return t},P=function(){h++;var e=g();if(E(),41===m(h))return h++,e;r(\"Unclosed (\",h)},S=function(){return h++,{type:\"ArrayExpression\",elements:j(93)}},B=[];h<b;)59===(o=m(h))||44===o?h++:(d=g())?B.push(d):h<b&&r('Unexpected \"'+y(h)+'\"',h);return 1===B.length?B[0]:{type:\"Compound\",body:B}};if(d.version=\"0.3.2\",d.toString=function(){return\"JavaScript Expression Parser (JSEP) v\"+d.version},d.addUnaryOp=function(e){return i=Math.max(e.length,i),t[e]=!0,this},d.addBinaryOp=function(e,r){return a=Math.max(e.length,a),n[e]=r,this},d.addLiteral=function(e,r){return u[e]=r,this},d.removeUnaryOp=function(e){return delete t[e],e.length===i&&(i=o(t)),this},d.removeAllUnaryOps=function(){return t={},i=0,this},d.removeBinaryOp=function(e){return delete n[e],e.length===a&&(a=o(n)),this},d.removeAllBinaryOps=function(){return n={},a=0,this},d.removeLiteral=function(e){return delete u[e],this},d.removeAllLiterals=function(){return u={},this},\"undefined\"==typeof exports){var h=e.jsep;e.jsep=d,d.noConflict=function(){return e.jsep===d&&(e.jsep=h),d}}else\"undefined\"!=typeof module&&module.exports?exports=module.exports=d:exports.parse=d}(this);\n//# sourceMappingURL=jsep.min.js.map","!function(){function e(e,t){return e instanceof Node||e instanceof Window?[e]:[].slice.call(\"string\"==typeof e?(t||document).querySelectorAll(e):e||[])}if(self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null),Element.prototype.matches)){var t=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type=\"'+\"text number url email tel\".split(\" \").join('\"], input[type=\"')+'\"]',filter:\"*\"},script:document.currentScript||e(\"script\").pop(),resize:function(e){if(t.resizes(e)){var i,n=getComputedStyle(e),o=0;!e.value&&e.placeholder&&(i=!0,e.value=e.placeholder);var l=e.nodeName.toLowerCase();if(\"textarea\"==l)e.style.height=\"0\",\"border-box\"==n.boxSizing?o=e.offsetHeight:\"content-box\"==n.boxSizing&&(o=-e.clientHeight+parseFloat(n.minHeight)),\ne.style.height=e.scrollHeight+o+\"px\";else if(\"input\"==l)if(e.style.width=\"1000px\",e.offsetWidth){e.style.width=\"0\",\"border-box\"==n.boxSizing?o=e.offsetWidth:\"padding-box\"==n.boxSizing?o=e.clientWidth:\"content-box\"==n.boxSizing&&(o=parseFloat(n.minWidth));var r=Math.max(o,e.scrollWidth-e.clientWidth);e.style.width=r+\"px\";for(var s=0;s<10&&(e.scrollLeft=1e10,0!=e.scrollLeft);s++)r+=e.scrollLeft,e.style.width=r+\"px\"}else e.style.width=e.value.length+1+\"ch\";else if(\"select\"==l){var c=e.selectedIndex>0?e.selectedIndex:0,a=document.createElement(\"_\");a.textContent=e.options[c].textContent,e.parentNode.insertBefore(a,e.nextSibling);var d;for(var h in n){var p=n[h];/^(width|webkitLogicalWidth|length)$/.test(h)||\"string\"!=typeof p||(a.style[h]=p,/appearance$/i.test(h)&&(d=h))}a.style.width=\"\",a.offsetWidth>0&&(e.style.width=a.offsetWidth+\"px\",n[d]&&\"none\"===n[d]||(e.style.width=\"calc(\"+e.style.width+\" + 2em)\")),a.parentNode.removeChild(a),a=null}i&&(e.value=\"\")}},resizeAll:function(i){\ne(i||t.selectors.base).forEach(function(e){t.resize(e)})},active:!0,resizes:function(e){return e&&e.parentNode&&e.matches&&e.matches(t.selectors.base)&&e.matches(t.selectors.filter)},init:function(){t.selectors.filter=t.script.getAttribute(\"data-filter\")||(e(\"[data-stretchy-filter]\").pop()||document.body).getAttribute(\"data-stretchy-filter\")||Stretchy.selectors.filter||\"*\",t.resizeAll()},$$:e};\"loading\"!==document.readyState?t.init():document.addEventListener(\"DOMContentLoaded\",t.init);var i=function(e){t.active&&t.resize(e.target)};document.documentElement.addEventListener(\"input\",i),document.documentElement.addEventListener(\"change\",i),self.MutationObserver&&new MutationObserver(function(e){t.active&&e.forEach(function(e){\"childList\"==e.type&&Stretchy.resizeAll(e.addedNodes)})}).observe(document.documentElement,{childList:!0,subtree:!0})}}();\n//# sourceMappingURL=stretchy.min.js.map\n","/**\n * Mavo: Create web applications by writing HTML and CSS!\n * @author Lea Verou and contributors\n * @version %%VERSION%%\n */\n(function ($, $$) {\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\t\tthis.dataLoaded = Mavo.defer();\n\n\t\tthis.element = element;\n\n\t\tthis.inProgress = false;\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = Object.keys(_.all).length + 1;\n\t\tObject.defineProperty(_.all, this.index - 1, {value: this});\n\n\t\t// Convert any data-mv-* attributes to mv-*\n\t\tvar selector = _.attributes.map(attribute => `[data-${attribute}]`).join(\", \");\n\n\t\t[this.element, ...$$(selector, this.element)].forEach(element => {\n\t\t\t_.attributes.forEach(attribute => {\n\t\t\t\tvar value = element.getAttribute(\"data-\" + attribute);\n\n\t\t\t\tif (value !== null) {\n\t\t\t\t\telement.setAttribute(attribute, value);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = Mavo.getAttribute(this.element, \"mv-app\", \"id\") || `mavo${this.index}`;\n\n\t\tif (this.id in _.all) {\n\t\t\t// Duplicate app name\n\t\t\tfor (var i=2; this.id + i in _.all; i++) {}\n\t\t\tthis.id = this.id + i;\n\t\t}\n\n\t\t_.all[this.id] = this;\n\t\tthis.element.setAttribute(\"mv-app\", this.id);\n\n\t\tvar lang = $.value(this.element.closest(\"[lang]\"), \"lang\") || Mavo.locale;\n\t\tthis.locale = Mavo.Locale.get(lang);\n\n\t\t// Should we start in edit mode?\n\t\tthis.autoEdit = this.element.classList.contains(\"mv-autoedit\");\n\n\t\t// Should we save automatically?\n\t\tthis.autoSave = this.element.hasAttribute(\"mv-autosave\");\n\t\tthis.autoSaveDelay = (this.element.getAttribute(\"mv-autosave\") || 3) * 1000;\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\tMavo.hooks.run(\"init-start\", this);\n\n\t\t// Apply heuristic for groups\n\t\t$$(_.selectors.primitive + \",\" + _.selectors.multiple, this.element).forEach(element => {\n\t\t\tvar hasChildren = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element);\n\n\t\t\tif (hasChildren) {\n\t\t\t\tvar config = Mavo.Primitive.getConfig(element);\n\t\t\t\tvar isCollection = Mavo.is(\"multiple\", element);\n\n\t\t\t\tif (isCollection || !config.attribute && !config.hasChildren) {\n\t\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.expressions = new Mavo.Expressions(this);\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.permissions = new Mavo.Permissions();\n\n\t\tvar backendTypes = [\"source\", \"storage\", \"init\"]; // order is significant!\n\n\t\t// Figure out backends for storage, data reads, and initialization respectively\n\t\tbackendTypes.forEach(role => this.updateBackend(role));\n\n\t\tthis.backendObserver = new Mavo.Observer(this.element, backendTypes.map(role => \"mv-\" + role), records => {\n\t\t\tvar changed = {};\n\n\t\t\tvar roles = records.map(record => {\n\t\t\t\tvar role = record.attributeName.replace(/^mv-/, \"\");\n\t\t\t\tchanged[role] = this.updateBackend(role);\n\n\t\t\t\treturn role;\n\t\t\t});\n\n\t\t\t// Do we need to re-load data?\n\t\t\tif (changed.source) {  // if source changes, always reload\n\t\t\t\tthis.load();\n\t\t\t}\n\t\t\telse if (!this.source) {\n\t\t\t\tif (changed.storage || changed.init && !this.root.data) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.permissions.can(\"login\", () => {\n\t\t\t// We also support a URL param to trigger login, in case the user doesn't want visible login UI\n\t\t\tif (Mavo.Functions.url(\"login\") !== null && this.index == 1 || Mavo.Functions.url(this.id + \"-login\") !== null) {\n\t\t\t\tthis.primaryBackend.login();\n\t\t\t}\n\t\t});\n\n\t\t// Update login status\n\t\t$.bind(this.element, \"mv-login.mavo\", evt => {\n\t\t\tif (evt.backend == (this.source || this.storage)) {\n\t\t\t\t// If last time we rendered we got nothing, maybe now we'll have better luck?\n\t\t\t\tif (!this.root.data && !this.unsavedChanges) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.bar = new Mavo.UI.Bar(this);\n\n\t\t// Prevent editing properties inside <summary> to open and close the summary (fix bug #82)\n\t\tif ($(\"summary [property]:not([typeof])\")) {\n\t\t\tthis.element.addEventListener(\"click\", evt => {\n\t\t\t\tif (evt.target != document.activeElement) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = this.calculateNeedsEdit();\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tvar permissions = this.element.getAttribute(\"mv-permissions\") || \"\";\n\t\t\tpermissions = permissions.trim().split(/\\s+/).filter(a => a != action);\n\n\t\t\tif (value) {\n\t\t\t\tpermissions.push(action);\n\t\t\t}\n\n\t\t\tthis.element.setAttribute(\"mv-permissions\", permissions.join(\" \"));\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\t\t// Observe entire tree for mv-mode changes\n\t\t\t\tthis.modeObserver = new Mavo.Observer(this.element, \"mv-mode\", records => {\n\t\t\t\t\trecords.forEach(record => {\n\t\t\t\t\t\tlet element = record.target;\n\t\t\t\t\t\tlet nodes = _.Node.children(element);\n\n\t\t\t\t\t\tnodeloop: for (let i=0; i<nodes.length; i++) {\n\t\t\t\t\t\t\tlet node = nodes[i];\n\t\t\t\t\t\t\tlet previousMode = node.mode, mode;\n\n\t\t\t\t\t\t\tif (node.element == element) {\n\t\t\t\t\t\t\t\t// If attribute set directly on a Mavo node, then it forces it into that mode\n\t\t\t\t\t\t\t\t// otherwise, descendant nodes still inherit, unless they are also mode-restricted\n\t\t\t\t\t\t\t\tmode = node.element.getAttribute(\"mv-mode\");\n\t\t\t\t\t\t\t\tnode.modes = mode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t// Inherited\n\t\t\t\t\t\t\t\tif (node.modes) {\n\t\t\t\t\t\t\t\t\t// Mode-restricted, we cannot change to the other mode\n\t\t\t\t\t\t\t\t\tcontinue nodeloop;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tmode = _.getStyle(node.element.parentNode, \"--mv-mode\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tnode.mode = mode;\n\n\t\t\t\t\t\t\tif (previousMode != node.mode) {\n\t\t\t\t\t\t\t\tnode[node.mode == \"edit\"? \"edit\" : \"done\"]();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}, {subtree: true});\n\n\t\t\t\tif (this.autoEdit) {\n\t\t\t\t\tthis.edit();\n\t\t\t\t}\n\t\t\t}, () => { // cannot\n\t\t\t\tthis.modeObserver && this.modeObserver.destroy();\n\t\t\t});\n\t\t}\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage or source\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tthis.dataLoaded.resolve();\n\t\t\t\t$.fire(this.element, \"mv-load\");\n\t\t\t});\n\t\t}\n\n\t\t// Dynamic ids\n\t\t$.bind(this.element, \"mv-load.mavo\", evt => {\n\t\t\tif (location.hash) {\n\t\t\t\tvar callback = records => {\n\t\t\t\t\tvar target = document.getElementById(location.hash.slice(1));\n\n\t\t\t\t\tif (target || !location.hash) {\n\t\t\t\t\t\tif (this.element.contains(target)) {\n\t\t\t\t\t\t\trequestAnimationFrame(() => { // Give the browser a chance to render\n\t\t\t\t\t\t\t\tMavo.scrollIntoViewIfNeeded(target);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (observer) {\n\t\t\t\t\t\t\tobserver.destroy();\n\t\t\t\t\t\t\tobserver = null;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn target;\n\t\t\t\t};\n\n\t\t\t\tif (!callback()) {\n\t\t\t\t\t// No target, perhaps not yet?\n\t\t\t\t\tvar observer = new Mavo.Observer(this.element, \"id\", callback, {subtree: true});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\trequestAnimationFrame(() => Stretchy.resizeAll());\n\t\t});\n\n\n\t\tif (this.autoSave) {\n\t\t\tthis.dataLoaded.then(evt => {\n\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\tthis.save();\n\t\t\t\t}, this.autoSaveDelay);\n\n\t\t\t\tvar callback = evt => {\n\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\t$.bind(this.element, \"mv-change.mavo:autosave\", callback);\n\t\t\t\t\t}, () => {\n\t\t\t\t\t\t$.unbind(this.element, \"mv-change.mavo:autosave\", callback);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\t// Keyboard navigation\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\t// Ctrl + S or Cmd + S to save\n\t\t\tif (this.permissions.save && evt.keyCode == 83 && evt[_.superKey] && !evt.altKey) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t\telse if (evt.keyCode == 38 || evt.keyCode == 40) {\n\t\t\t\tvar element = evt.target;\n\n\t\t\t\tif (element.matches(\"textarea, input[type=range], input[type=number]\")) {\n\t\t\t\t\t// Arrow keys are meaningful here\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (element.matches(\".mv-editor\")) {\n\t\t\t\t\tvar editor = true;\n\t\t\t\t\telement = element.parentNode;\n\t\t\t\t}\n\n\t\t\t\tvar node = Mavo.Node.get(element);\n\n\t\t\t\tif (node && node.closestCollection) {\n\t\t\t\t\tvar nextNode = node.getCousin(evt.keyCode == 38? -1 : 1, {wrap: true});\n\n\t\t\t\t\tif (nextNode) {\n\t\t\t\t\t\tif (editor && nextNode.editing) {\n\t\t\t\t\t\t\tnextNode.edit({immediately: true}).then(() => nextNode.editor.focus());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tnextNode.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function() {\n\t\treturn _.toJSON(this.getData());\n\t},\n\n\tmessage: function(message, options) {\n\t\treturn new _.UI.Message(this, message, options);\n\t},\n\n\terror: function(message, ...log) {\n\t\tthis.message(message, {\n\t\t\ttype: \"error\",\n\t\t\tdismiss: [\"button\", \"timeout\"]\n\t\t});\n\n\t\t// Log more info for programmers\n\t\tif (log.length > 0) {\n\t\t\tconsole.log(`%c${this.id}: ${message}`, \"color: red; font-weight: bold\", ...log);\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.expressions.active = false;\n\n\t\tvar env = {context: this, data};\n\t\t_.hooks.run(\"render-start\", env);\n\n\t\tif (env.data) {\n\t\t\tthis.root.render(env.data);\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\n\t\tthis.expressions.active = true;\n\t\trequestAnimationFrame(() => this.expressions.update());\n\n\t\t_.hooks.run(\"render-end\", env);\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.bind(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(_.selectors.multiple)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.multiple);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instances unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * Update the backend for a given role\n\t * @return {Boolean} true if a change occurred, false otherwise\n\t */\n\tupdateBackend: function(role) {\n\t\tvar previous = this[role], backend, changed;\n\n\t\tif (this.index == 1) {\n\t\t\tbackend = _.Functions.url(role);\n\t\t}\n\n\t\tif (!backend) {\n\t\t\tbackend =  _.Functions.url(`${this.id}-${role}`) || this.element.getAttribute(\"mv-\" + role) || null;\n\t\t}\n\n\t\tif (backend) {\n\t\t\tbackend = backend.trim();\n\n\t\t\tif (backend == \"none\") {\n\t\t\t\tbackend = null;\n\t\t\t}\n\t\t}\n\n\t\tif (backend && (!previous || !previous.equals(backend))) {\n\t\t\t// We have a string, convert to a backend object if different than existing\n\t\t\tthis[role] = backend = _.Backend.create(backend, {\n\t\t\t\tmavo: this,\n\t\t\t\tformat: this.element.getAttribute(`mv-${role}-format`) || this.element.getAttribute(\"mv-format\")\n\t\t\t}, this.element.getAttribute(`mv-${role}-type`), this[role]);\n\n\t\t\tchanged = true;\n\t\t}\n\t\telse if (!backend) {\n\t\t\t// We had a backend and now we will un-have it\n\t\t\tthis[role] = null;\n\t\t}\n\n\t\tchanged = changed || (backend? !backend.equals(previous) : !!previous);\n\n\t\tif (changed) {\n\t\t\t// A change occured\n\t\t\tif (!this.storage && !this.source && this.init) {\n\t\t\t\t// If init is present with no storage and no source, init is equivalent to source\n\t\t\t\tthis.source = this.init;\n\t\t\t\tthis.init = null;\n\t\t\t}\n\n\t\t\tvar permissions = this.storage? this.storage.permissions : new Mavo.Permissions({edit: true, save: false});\n\t\t\tpermissions.parent = this.source && this.source.permissions;\n\t\t\tthis.permissions.parent = permissions;\n\n\t\t\tthis.primaryBackend = this.storage || this.source;\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tvar backend = this.source || this.storage;\n\n\t\tif (!backend) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tthis.inProgress = \"Loading\";\n\n\t\treturn backend.ready.then(() => backend.load())\n\t\t.catch(err => {\n\t\t\t// Try again with init\n\t\t\tif (this.init && this.init != backend) {\n\t\t\t\tbackend = this.init;\n\t\t\t\treturn this.init.ready.then(() => this.init.load());\n\t\t\t}\n\n\t\t\t// No init, propagate error\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tvar xhr = err instanceof XMLHttpRequest? err : err.xhr;\n\n\t\t\t\tif (xhr && xhr.status == 404) {\n\t\t\t\t\tthis.render(null);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar message = this._(\"problem-loading\");\n\n\t\t\t\t\tif (xhr) {\n\t\t\t\t\t\tmessage += xhr.status? this._(\"http-error\", err) : \": \" + this._(\"cant-connect\");\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t})\n\t\t.then(data => this.render(data))\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tthis.dataLoaded.resolve();\n\t\t\t\t$.fire(this.element, \"mv-load\");\n\t\t\t});\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\treturn this.storage.store(this.getData())\n\t\t\t.catch(err => {\n\t\t\t\tif (err) {\n\t\t\t\t\tvar message = this._(\"problem-saving\");\n\n\t\t\t\t\tif (err instanceof XMLHttpRequest) {\n\t\t\t\t\t\tmessage += \": \" + (err.status? this._(\"http-error\", err) : this._(\"cant-connect\"));\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t})\n\t\t\t.then(saved => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn saved;\n\t\t\t});\n\t},\n\n\tupload: function(file, path = \"images/\" + file.name) {\n\t\tif (!this.uploadBackend) {\n\t\t\treturn Promise.reject();\n\t\t}\n\n\t\tthis.inProgress = this._(\"uploading\");\n\n\t\treturn this.uploadBackend.upload(file, path)\n\t\t\t.then(url => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn url;\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tthis.error(this._(\"error-uploading\"), err);\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn null;\n\t\t\t});\n\t},\n\n\tsave: function() {\n\t\treturn this.store().then(saved => {\n\t\t\tif (saved) {\n\t\t\t\t$.fire(this.element, \"mv-save\", saved);\n\n\t\t\t\tthis.lastSaved = Date.now();\n\t\t\t\tthis.root.save();\n\t\t\t\tthis.unsavedChanges = false;\n\t\t\t}\n\t\t});\n\t},\n\n\twalk: function() {\n\t\treturn this.root.walk(...arguments);\n\t},\n\n\tcalculateNeedsEdit: function(test) {\n\t\tvar needsEdit = false;\n\n\t\tthis.walk((obj, path) => {\n\t\t\tif (needsEdit) {\n\t\t\t\t// If already true, no need to descend further\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// True if both modes are allowed and node is not group\n\t\t\tneedsEdit = !obj.modes && obj.nodeType != \"Group\";\n\n\t\t\treturn !obj.modes;\n\t\t}, undefined, {descentReturn: true});\n\n\t\treturn needsEdit;\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-progress\", value, value);\n\t\t\t$.toggleAttribute(this.element, \"aria-busy\", !!value, !!value);\n\t\t\tthis.element.style.setProperty(\"--mv-progress-text\", value? `\"${this._(value)}\"` : \"\");\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\tthis.bar.toggle(\"edit\", value && this.permissions.edit);\n\t\t},\n\n\t\tstorage: function(value) {\n\t\t\tif (value !== this._storage && !value) {\n\t\t\t\tvar permissions = new Mavo.Permissions({edit: true, save: false});\n\t\t\t\tpermissions.parent = this.permissions.parent;\n\t\t\t\tthis.permissions.parent = permissions;\n\t\t\t}\n\t\t},\n\n\t\tprimaryBackend: function(value) {\n\t\t\tvalue = value || null;\n\n\t\t\tif (value != this._primaryBackend) {\n\t\t\t\treturn value;\n\t\t\t}\n\t\t},\n\n\t\tuploadBackend: {\n\t\t\tget: function() {\n\t\t\t\tif (this.storage && this.storage.upload) {\n\t\t\t\t\t// Prioritize storage\n\t\t\t\t\treturn this.storage;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tversion: \"%%VERSION%%\",\n\n\t\tall: {},\n\n\t\tget: function(id) {\n\t\t\tif (id instanceof Element) {\n\t\t\t\t// Get by element\n\t\t\t\tfor (var name in _.all) {\n\t\t\t\t\tif (_.all[name].element == id) {\n\t\t\t\t\t\treturn _.all[name];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tvar name = typeof id === \"number\"? Object.keys(_.all)[id] : id;\n\n\t\t\treturn _.all[name] || null;\n\t\t},\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\t\tbase: location.protocol == \"about:\"? (document.currentScript? document.currentScript.src : \"http://mavo.io\") : location,\n\t\tdependencies: [],\n\n\t\tinit: function(container = document) {\n\t\t\tvar mavos = Array.isArray(arguments[0])? arguments[0] : $$(_.selectors.init, container);\n\n\t\t\tvar ret = mavos.filter(element => !_.get(element)) // not already inited\n\t\t\t\t.map(element => new _(element));\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tUI: {},\n\n\t\thooks: new $.Hooks(),\n\n\t\tattributes: [\n\t\t\t\"mv-app\", \"mv-storage\", \"mv-source\", \"mv-init\", \"mv-path\", \"mv-multiple-path\", \"mv-format\",\n\t\t\t\"mv-attribute\", \"mv-default\", \"mv-mode\", \"mv-edit\", \"mv-permisssions\",\n\t\t\t\"mv-rel\", \"mv-value\"\n\t\t],\n\n\t\tlazy: {\n\t\t\tlocale: () => document.documentElement.lang || \"en-GB\",\n\t\t\ttoNode: () => Symbol(\"toNode\"),\n\t\t\ttoProxy: () => Symbol(\"toProxy\")\n\t\t}\n\t}\n});\n\nObject.defineProperty(_.all, \"length\", {\n\tget: function() {\n\t\treturn Object.keys(this).length;\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mv-app, [mv-app], [data-mv-app]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], [mv-group]\",\n\tmultiple: \"[mv-multiple]\",\n\tformControl: \"input, select, option, textarea\",\n\ttextInput: [\"text\", \"email\", \"url\", \"tel\", \"search\"].map(t => `input[type=${t}]`).join(\", \") + \", input:not([type]), textarea\",\n\tui: \".mv-ui\",\n\tcontainer: {\n\t\t// \"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t// \"dt\": \"dl\",\n\t\t// \"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\titem: or(s.multiple, s.group),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output\")\n});\n\n}\n\n// Init mavo. Async to give other scripts a chance to modify stuff.\nrequestAnimationFrame(() => {\n\tvar polyfills = [];\n\n\t$.each({\n\t\t\"blissfuljs\": Array.from && document.documentElement.closest && self.URL && \"searchParams\" in URL.prototype,\n\t\t\"Intl.~locale.en\": self.Intl,\n\t\t\"IntersectionObserver\": self.IntersectionObserver,\n\t\t\"Symbol\": self.Symbol,\n\t\t\"Element.prototype.remove\": Element.prototype.remove\n\t}, (id, supported) => {\n\t\tif (!supported) {\n\t\t\tpolyfills.push(id);\n\t\t}\n\t});\n\n\tvar polyfillURL = \"https://cdn.polyfill.io/v2/polyfill.min.js?unknown=polyfill&features=\" + polyfills.map(a => a + \"|gated\").join(\",\");\n\n\t_.dependencies.push(\n\t\t// Plugins.load() must be run after DOM load to pick up all mv-plugins attributes\n\t\t$.ready().then(() => _.Plugins.load()),\n\t\t$.include(!polyfills.length, polyfillURL)\n\t);\n\n\t_.inited = $.ready().then(() => {\n\t\t$.attributes($$(_.selectors.init), {\"mv-progress\": \"Loading\"});\n\t\treturn _.ready;\n\t})\n\t.catch(console.error)\n\t.then(() => Mavo.init());\n\n\t_.ready = _.thenAll(_.dependencies);\n});\n\nStretchy.selectors.filter = \".mv-editor:not([property]), .mv-autosize\";\n\n// Define $ and $$ if they are not already defined\n// Primarily for backwards compat since we used to use Bliss Full.\nself.$ = self.$ || $;\nself.$$ = self.$$ || $$;\n\n})(Bliss, Bliss.$);\n","(function ($, $$) {\n\nvar _ = $.extend(Mavo, {\n\t/**\n\t * Load a file, only once\n\t */\n\tload: (url, base = document.currentScript? document.currentScript.src : location) => {\n\t\t_.loaded = _.loaded || new Set();\n\n\t\tif (_.loaded.has(url + \"\")) {\n\t\t\treturn;\n\t\t}\n\n\t\turl = new URL(url, base);\n\n\t\tif (/\\.css$/.test(url.pathname)) {\n\t\t\t// CSS file\n\t\t\t$.create(\"link\", {\n\t\t\t\t\"href\": url,\n\t\t\t\t\"rel\": \"stylesheet\",\n\t\t\t\t\"inside\": document.head\n\t\t\t});\n\n\t\t\t// No need to wait for stylesheets\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\t// JS file\n\t\treturn $.include(url);\n\t},\n\n\treadFile: (file, format = \"DataURL\") => {\n\t\tvar reader = new FileReader();\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\treader.onload = f => resolve(reader.result);\n\t\t\treader.onerror = reader.onabort = reject;\n\t\t\treader[\"readAs\" + format](file);\n\t\t});\n\t},\n\n\ttoJSON: data => {\n\t\tif (data === null) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\tif (typeof data === \"string\") {\n\t\t\t// Do not stringify twice!\n\t\t\treturn data;\n\t\t}\n\n\t\treturn JSON.stringify(data, null, \"\\t\");\n\t},\n\n\t/**\n\t * toJSON without cycles\n\t */\n\tsafeToJSON: function(o) {\n\t\tvar cache = self.WeakSet? new WeakSet() : new Set();\n\n\t\treturn JSON.stringify(o, (key, value) => {\n\t\t\tif (typeof value === \"object\" && value !== null) {\n\t\t\t\t// No circular reference found\n\n\t\t\t\tif (cache.has(value)) {\n\t\t\t\t\treturn; // Circular reference found!\n\t\t\t\t}\n\n\t\t\t\tcache.add(value);\n\t\t\t}\n\n\t\t\treturn value;\n\t\t});\n\t},\n\n\tobjectify: (value, properties) => {\n\t\tvar primitive = Mavo.value(value);\n\n\t\tif (typeof value !== \"object\" || value === null) {\n\t\t\tif (value === null) {\n\t\t\t\tvalue = {\n\t\t\t\t\t[Symbol.toStringTag]: \"Null\",\n\t\t\t\t\ttoJSON: () => null\n\t\t\t\t};\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar constructor = value.constructor;\n\t\t\t\tvalue = new constructor(primitive);\n\t\t\t\tvalue[Symbol.toStringTag] = constructor.name;\n\t\t\t}\n\n\t\t\tvalue.valueOf = value[Symbol.toPrimitive] = () => primitive;\n\t\t}\n\n\t\treturn $.extend(value, properties);\n\t},\n\n\tvalue: value => value && value.valueOf? value.valueOf() : value,\n\n\t/**\n\t * Array & set utlities\n\t */\n\n\t// If the passed value is not an array, convert to an array\n\ttoArray: arr => {\n\t\treturn arr === undefined? [] : Array.isArray(arr)? arr : [arr];\n\t},\n\n\t// Delete an element from an array\n\t// @param all {Boolean} Delete more than one?\n\tdelete: (arr, element, all) => {\n\t\tdo {\n\t\t\tvar index = arr && arr.indexOf(element);\n\n\t\t\tif (index > -1) {\n\t\t\t\tarr.splice(index, 1);\n\t\t\t}\n\t\t} while (index > -1 && all);\n\t},\n\n\t// Recursively flatten a multi-dimensional array\n\tflatten: arr => {\n\t\tif (!Array.isArray(arr)) {\n\t\t\treturn [arr];\n\t\t}\n\n\t\treturn arr.reduce((prev, c) => _.toArray(prev).concat(_.flatten(c)), []);\n\t},\n\n\t// Push an item to an array iff it's not already in there\n\tpushUnique: (arr, item) => {\n\t\tif (arr.indexOf(item) === -1) {\n\t\t\tarr.push(item);\n\t\t}\n\t},\n\n\tunion: (set1, set2) => {\n\t\treturn new Set([...(set1 || []), ...(set2 || [])]);\n\t},\n\n\t// Filter an array in place\n\t// TODO add index to callback\n\tfilter: (arr, callback) => {\n\t\tfor (var i=0; i<arr.length; i++) {\n\t\t\tif (!callback(arr[i])) {\n\t\t\t\tarr.splice(i, 1);\n\t\t\t\ti--;\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * DOM element utilities\n\t */\n\n\tis: function(thing, ...elements) {\n\t\tfor (let i=0, element; i < elements.length; i++) {\n\t\t\telement = elements[i];\n\n\t\t\tif (element && element.matches && element.matches(_.selectors[thing])) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t},\n\n\t/**\n\t * Get the current value of a CSS property on an element\n\t */\n\tgetStyle: (element, property) => {\n\t\tif (element) {\n\t\t\tvar value = getComputedStyle(element).getPropertyValue(property);\n\n\t\t\tif (value) {\n\t\t\t\treturn value.trim();\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * Get/set data on an element\n\t */\n\tdata: function(element, name, value) {\n\t\tvar data = _.elementData.get(element) || {}, ret;\n\n\t\tif (arguments.length == 2) {\n\t\t\tret = data[name];\n\t\t}\n\t\telse if (value === undefined) {\n\t\t\tdelete data[name];\n\t\t}\n\t\telse {\n\t\t\tret = data[name] = value;\n\t\t}\n\n\t\t_.elementData.set(element, data);\n\t\treturn ret;\n\t},\n\n\telementData: new WeakMap(),\n\n\t/**\n\t * Get node from path or get path of a node to an ancestor\n\t * For maximum robustness, all but the last path segment refer to elements only.\n\t * The last part of the path is a decimal: the integer part of the decimal is element index,\n\t * the decimal part is node index *after* that element and starts from 1.\n\t * If the node has no previous element sibling, the integer part of the index will be -1.\n\t */\n\telementPath: function (ancestor, element) {\n\t\tif (Array.isArray(element)) {\n\t\t\t// Get element by path\n\t\t\tvar path = element;\n\n\t\t\tvar ret = path.reduce((acc, cur) => {\n\t\t\t\treturn acc.children[cur >> 0] || acc;\n\t\t\t}, ancestor);\n\n\t\t\tvar last = path[path.length - 1];\n\n\t\t\tif (last != (last >> 0)) {\n\t\t\t\t// We are returning a non-element node\n\t\t\t\tvar offset = +(last + \"\").split(\".\")[1];\n\n\t\t\t\tif (last >> 0 < 0) {\n\t\t\t\t\tret = ret.firstChild;\n\t\t\t\t\toffset--;\n\t\t\t\t}\n\n\t\t\t\tfor (var i=0; i<offset; i++) {\n\t\t\t\t\tret = ret.nextSibling;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t}\n\t\telse {\n\t\t\t// Get path\n\t\t\tvar path = [];\n\n\t\t\tfor (var parent = element; parent && parent != ancestor; parent = parent.parentNode) {\n\t\t\t\tvar index = 0;\n\t\t\t\tvar countNonElementSiblings = parent === element && element.nodeType !== 1;\n\t\t\t\tvar offset = countNonElementSiblings? 1 : 0;\n\t\t\t\tvar sibling = parent;\n\n\t\t\t\twhile (sibling = sibling[`previous${countNonElementSiblings? \"\" : \"Element\"}Sibling`]) {\n\t\t\t\t\tif (countNonElementSiblings) {\n\t\t\t\t\t\toffset++;\n\n\t\t\t\t\t\tif (sibling.nodeType == 1) {\n\t\t\t\t\t\t\tcountNonElementSiblings = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tindex++;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (offset > 0) {\n\t\t\t\t\tindex = index - 1 + \".\" + offset;\n\t\t\t\t}\n\n\t\t\t\tpath.unshift(index);\n\t\t\t}\n\n\t\t\treturn parent? path : null;\n\t\t}\n\t},\n\n\t/**\n\t * Revocably add/remove elements from the DOM\n\t */\n\trevocably: {\n\t\tadd: function(element, parent) {\n\t\t\tvar comment = _.revocably.isRemoved(element);\n\n\t\t\tif (comment && comment.parentNode) {\n\t\t\t\tcomment.parentNode.replaceChild(element, comment);\n\t\t\t}\n\t\t\telse if (element && parent && !element.parentNode) {\n\t\t\t\t// Has not been revocably removed because it has never even been added\n\t\t\t\tparent.appendChild(element);\n\t\t\t}\n\n\t\t\treturn comment;\n\t\t},\n\n\t\tremove: function(element, commentText) {\n\t\t\tif (!element) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar comment = _.data(element, \"commentstub\");\n\n\t\t\tif (!comment) {\n\t\t\t\tcommentText = commentText || element.id || element.className || element.nodeName;\n\t\t\t\tcomment = _.data(element, \"commentstub\", document.createComment(commentText));\n\t\t\t}\n\n\t\t\tif (element.parentNode) {\n\t\t\t\t// In DOM, remove\n\t\t\t\telement.parentNode.replaceChild(comment, element);\n\t\t\t}\n\n\t\t\treturn comment;\n\t\t},\n\n\t\tisRemoved: function(element) {\n\t\t\tif (!element || element.parentNode) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar comment = _.data(element, \"commentstub\");\n\n\t\t\tif (comment && comment.parentNode) {\n\t\t\t\treturn comment;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\n\t\tsetAttribute: function(element, attribute, value) {\n\t\t\tvar previousValue = _.data(element, \"attribute-\" + attribute);\n\n\t\t\tif (previousValue === undefined) {\n\t\t\t\t// Only set this when there's no old value stored, otherwise\n\t\t\t\t// if called multiple times, it could result in losing the original value\n\t\t\t\t_.data(element, \"attribute-\" + attribute, element.getAttribute(attribute));\n\t\t\t}\n\n\t\t\telement.setAttribute(attribute, value);\n\t\t},\n\n\t\trestoreAttribute: function(element, attribute) {\n\t\t\tvar previousValue = _.data(element, \"attribute-\" + attribute);\n\n\t\t\tif (previousValue !== undefined) {\n\t\t\t\t$.toggleAttribute(element, attribute, previousValue);\n\t\t\t\t_.data(element, \"attribute-\" + attribute, undefined);\n\t\t\t}\n\t\t}\n\t},\n\n\tinView: {\n\t\tis: element => {\n\t\t\tvar r = element.getBoundingClientRect();\n\n\t\t\treturn (0 <= r.bottom && r.bottom <= innerHeight || 0 <= r.top && r.top <= innerHeight) // vertical\n\t\t\t       && (0 <= r.right && r.right <= innerWidth || 0 <= r.left && r.left <= innerWidth); // horizontal\n\t\t},\n\n\t\twhen: element => {\n\t\t\tvar observer = _.inView.observer = _.inView.observer || new IntersectionObserver(function(entries) {\n\t\t\t\tentries.forEach(entry => {\n\t\t\t\t\tthis.unobserve(entry.target);\n\t\t\t\t\t$.fire(entry.target, \"mv-inview\", {entry});\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn new Promise(resolve => {\n\t\t\t\tif (_.is(element)) {\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\n\t\t\t\tobserver.observe(element);\n\n\t\t\t\tvar callback = evt => {\n\t\t\t\t\telement.removeEventListener(\"mv-inview\", callback);\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\tresolve();\n\t\t\t\t};\n\n\t\t\t\telement.addEventListener(\"mv-inview\", callback);\n\t\t\t});\n\t\t}\n\t},\n\n\tscrollIntoViewIfNeeded: element => {\n\t\tif (element && !Mavo.inView.is(element)) {\n\t\t\telement.scrollIntoView({behavior: \"smooth\"});\n\t\t}\n\t},\n\n\t/**\n\t * Set attribute only if it doesnt exist\n\t */\n\tsetAttributeShy: function(element, attribute, value) {\n\t\tif (!element.hasAttribute(attribute)) {\n\t\t\telement.setAttribute(attribute, value);\n\t\t}\n\t},\n\n\t/**\n\t * Get the value of an attribute, with fallback attributes in priority order.\n\t */\n\tgetAttribute: function(element, ...attributes) {\n\t\tfor (let i=0, attribute; attribute = attributes[i]; i++) {\n\t\t\tlet value = element.getAttribute(attribute);\n\n\t\t\tif (value) {\n\t\t\t\treturn value;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t},\n\n\t/**\n\t * Get the element identified by the URL hash\n\t */\n\tgetTarget: function() {\n\t\tvar id = location.hash.substr(1);\n\t\treturn document.getElementById(id);\n\t},\n\n\t/**\n\t * Object utilities\n\t */\n\n\t/**\n\t * Check if property exists in object. Like the in operator but more robust and does not throw.\n\t * Why not just in? E.g. \"foo\".length is 3 but \"length\" in \"foo\" throws\n\t */\n\tin: function(obj, property) {\n\t\tif (obj) {\n\t\t\treturn (typeof obj === \"object\" && property in obj) || obj[property] !== undefined;\n\t\t}\n\t},\n\n\t/**\n\t * Get real property name from case insensitive property\n\t */\n\tgetCanonicalProperty: function(obj, property) {\n\t\tif (obj && (property || property === 0)) {\n\t\t\t// Property in object?\n\t\t\tif (_.in(obj, property)) {\n\t\t\t\treturn property;\n\t\t\t}\n\n\t\t\tif (property.toLowerCase) {\n\t\t\t\t// Lowercase property in object?\n\t\t\t\tvar propertyL = property.toLowerCase();\n\n\t\t\t\tif (_.in(obj, propertyL)) {\n\t\t\t\t\treturn propertyL;\n\t\t\t\t}\n\n\t\t\t\t// Any case property in object?\n\t\t\t\tvar properties = Object.keys(obj);\n\t\t\t\tvar i = properties.map(p => p.toLowerCase()).indexOf(propertyL);\n\n\t\t\t\tif (i > -1) {\n\t\t\t\t\treturn properties[i];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tsubset: function(obj, path, value) {\n\t\tif (arguments.length == 3) {\n\t\t\t// Put\n\t\t\tif (path.length) {\n\t\t\t\tvar last = path[path.length - 1];\n\t\t\t\tvar parent = $.value(obj, ...path.slice(0, -1));\n\n\t\t\t\tif (Array.isArray(parent) && Array.isArray(value)) {\n\t\t\t\t\t// Merge arrays instead of adding array inside array\n\t\t\t\t\tparent.splice(last, 1, ...value);\n\t\t\t\t}\n\t\t\t\telse if (parent) {\n\t\t\t\t\tparent[path[path.length - 1]] = value;\n\t\t\t\t}\n\n\t\t\t\treturn obj;\n\t\t\t}\n\n\t\t\treturn value;\n\t\t}\n\t\telse if (typeof obj == \"object\" && path && path.length) { // Get\n\t\t\treturn path.reduce((obj, property, i) => {\n\t\t\t\tvar meta = {};\n\t\t\t\tvar ret = Mavo.Functions.get(obj, property, meta);\n\n\t\t\t\t// We don't yet support multiple properties at the same level\n\t\t\t\t// i.e. the path can't be for the 2nd and 3rd item\n\t\t\t\tpath[i] = Array.isArray(meta.property)? meta.property[0] : meta.property;\n\n\t\t\t\tif (ret === undefined && meta.query) {\n\t\t\t\t\t// Not found, return dummy if query\n\t\t\t\t\tret = {[meta.query.property]: meta.query.value};\n\t\t\t\t}\n\n\t\t\t\treturn ret;\n\t\t\t}, obj);\n\t\t}\n\t\telse {\n\t\t\treturn obj;\n\t\t}\n\t},\n\n\tclone: function(o) {\n\t\treturn JSON.parse(_.safeToJSON(o));\n\t},\n\n\t// Credit: https://remysharp.com/2010/07/21/throttling-function-calls\n\tdebounce: function (fn, delay) {\n\t\tif (!delay) {\n\t\t\t// No throttling\n\t\t\treturn fn;\n\t\t}\n\n\t\tvar timer = null, code;\n\n\t\treturn function () {\n\t\t\tvar context = this, args = arguments;\n\n\t\t\tcode = function () {\n\t\t\t\tfn.apply(context, args);\n\t\t\t\tremoveEventListener(\"beforeunload\", code);\n\t\t\t};\n\n\t\t\tclearTimeout(timer);\n\t\t\ttimer = setTimeout(code, delay);\n\t\t\taddEventListener(\"beforeunload\", code);\n\t\t};\n\t},\n\n\ttimeout: delay => new Promise(resolve => setTimeout(resolve, delay)),\n\n\tescapeRegExp: s => s.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, \"\\\\$&\"),\n\n\tmatches: (str, regex) => {\n\t\tvar ret = (str + \"\").match(regex);\n\t\treturn ret? ret : [];\n\t},\n\n\tmatch: (str, regex, i=0) => _.matches(str, regex)[i] || \"\",\n\n\tobserveResize: function(element, callbackOrObserver) {\n\t\tif (!self.ResizeObserver) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar previousRect = null;\n\t\tvar ro = callbackOrObserver instanceof ResizeObserver? callbackOrObserver : new ResizeObserver(entries => {\n\t\t\tvar contentRect = entries[entries.length - 1].contentRect;\n\n\t\t\tif (previousRect\n\t\t\t\t&& previousRect.width == contentRect.width\n\t\t\t\t&& previousRect.height == contentRect.height) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcallbackOrObserver(entries);\n\n\t\t\tpreviousRect = contentRect;\n\t\t});\n\n\t\tro.observe(element);\n\n\t\treturn ro;\n\t},\n\n\tObserver: $.Class({\n\t\tconstructor: function(element, attribute, callback, o = {}) {\n\t\t\tif (callback instanceof MutationObserver) {\n\t\t\t\tthis.observer = callback;\n\t\t\t}\n\n\t\t\tthis.observer = this.observer || new MutationObserver(callback);\n\t\t\tthis.element = element;\n\t\t\tthis.callback = callback;\n\t\t\tthis.attribute = attribute;\n\n\t\t\tthis.options = $.extend({}, o);\n\n\t\t\tif (attribute) {\n\t\t\t\t$.extend(this.options, {\n\t\t\t\t\tattributes: true,\n\t\t\t\t\tattributeFilter: this.attribute == \"all\"? undefined : Mavo.toArray(this.attribute),\n\t\t\t\t\tattributeOldValue: !!o.oldValue\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (!this.attribute || this.attribute == \"all\") {\n\t\t\t\t$.extend(this.options, {\n\t\t\t\t\tcharacterData: true,\n\t\t\t\t\tchildList: true,\n\t\t\t\t\tsubtree: true,\n\t\t\t\t\tcharacterDataOldValue: !!o.oldValue\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.run();\n\t\t},\n\n\t\tstop: function() {\n\t\t\tif (this.observer) {\n\t\t\t\tthis.observer.disconnect();\n\t\t\t}\n\n\t\t\tthis.running = false;\n\n\t\t\treturn this;\n\t\t},\n\n\t\trun: function() {\n\t\t\tif (this.observer) {\n\t\t\t\tthis.observer.observe(this.element, this.options);\n\t\t\t\tthis.running = true;\n\t\t\t}\n\n\t\t\treturn this;\n\t\t},\n\n\t\t/**\n\t\t * Disconnect an observer, run some code, then observe again\n\t\t */\n\t\tsneak: function(callback) {\n\t\t\tif (this.running) {\n\t\t\t\tthis.stop();\n\t\t\t\tvar ret = callback();\n\t\t\t\tthis.run();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar ret = callback();\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tdestroy: function() {\n\t\t\tthis.stop();\n\t\t\tthis.observer = this.element = null;\n\t\t},\n\n\t\tstatic: {\n\t\t\tsneak: function(observer, callback) {\n\t\t\t\treturn observer? observer.sneak(callback) : callback();\n\t\t\t}\n\t\t}\n\t}),\n\n\tdefer: function(constructor) {\n\t\tvar res, rej;\n\n\t\tvar promise = new Promise((resolve, reject) => {\n\t\t\tif (constructor) {\n\t\t\t\tconstructor(resolve, reject);\n\t\t\t}\n\n\t\t\tres = resolve;\n\t\t\trej = reject;\n\t\t});\n\n\t\tpromise.resolve = a => {\n\t\t\tres(a);\n\t\t\treturn promise;\n\t\t};\n\n\t\tpromise.reject = a => {\n\t\t\trej(a);\n\t\t\treturn promise;\n\t\t};\n\n\t\treturn promise;\n\t},\n\n\t/**\n\t * Similar to Promise.all() but can handle post-hoc additions\n\t * and does not reject if one promise rejects.\n\t */\n\tthenAll: function(iterable) {\n\t\t// Turn rejected promises into resolved ones\n\t\t$$(iterable).forEach(promise => {\n\t\t\tif ($.type(promise) == \"promise\") {\n\t\t\t\tpromise = promise.catch(err => err);\n\t\t\t}\n\t\t});\n\n\t\treturn Promise.all(iterable).then(resolved => {\n\t\t\tif (iterable.length != resolved.length) {\n\t\t\t\t// The list of promises or values changed. Return a new Promise.\n\t\t\t\t// The original promise won't resolve until the new one does.\n\t\t\t\treturn _.thenAll(iterable);\n\t\t\t}\n\n\t\t\t// The list of promises or values stayed the same.\n\t\t\t// Return results immediately.\n\t\t\treturn resolved;\n\t\t});\n\t},\n\n\t/**\n\t * Run & Return a function\n\t */\n\trr: function(f) {\n\t\tf();\n\t\treturn f;\n\t},\n\n\t// Get out of bounds array index to wrap around\n\twrap: (index, length) => index < 0? length - 1 : index >= length? 0 : index,\n\n\t/**\n\t * Parses a simple CSS-like text format for declaring key-value options:\n\t * Pairs are comma or semicolon-separated, key and value are colon separated.\n\t * Escapes are supported, via backslash. Useful for attributes.\n\t */\n\toptions: str => {\n\t\tvar ret = {};\n\n\t\t(str.trim().match(/(?:\\\\[,;]|[^,;])+/g) || []).forEach(option => {\n\t\t\tif (option) {\n\t\t\t\toption = option.trim().replace(/\\\\([,;])/g, \"$1\");\n\t\t\t\tvar pair = option.match(/^\\s*((?:\\\\:|[^:])+?)\\s*:\\s*(.+)$/);\n\n\t\t\t\tif (pair) {\n\t\t\t\t\tret[pair[1].replace(/\\\\:/g, \":\")] = pair[2];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// If no value, it's boolean\n\t\t\t\t\tret[option] = true;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn ret;\n\t}\n});\n\n// Bliss plugins\n\n$.add(\"toggleAttribute\", function(name, value, test = value !== null) {\n\tif (test) {\n\t\tthis.setAttribute(name, value);\n\t}\n\telse {\n\t\tthis.removeAttribute(name);\n\t}\n});\n\n// Provide shortcuts to long property chains\n$.proxy = $.classProps.proxy = $.overload(function(obj, property, proxy) {\n\tObject.defineProperty(obj, property, {\n\t\tget: function() {\n\t\t\treturn this[proxy][property];\n\t\t},\n\t\tset: function(value) {\n\t\t\tthis[proxy][property] = value;\n\t\t},\n\t\tconfigurable: true,\n\t\tenumerable: true\n\t});\n\n\treturn obj;\n});\n\n$.classProps.propagated = function(proto, names) {\n\tMavo.toArray(names).forEach(name => {\n\t\tvar existing = proto[name];\n\n\t\tproto[name] = function() {\n\t\t\tvar ret = existing && existing.apply(this, arguments);\n\n\t\t\tif (this.propagate && ret !== false) {\n\t\t\t\tthis.propagate(name);\n\t\t\t}\n\t\t};\n\t});\n};\n\n// :target-within shim\nfunction updateTargetWithin() {\n\tvar element = _.getTarget();\n\tconst cl = \"mv-target-within\";\n\n\t$$(\".\" + cl).forEach(el => el.classList.remove(cl));\n\n\twhile (element && element.classList) {\n\t\telement.classList.add(cl);\n\t\telement = element.parentNode;\n\t}\n};\n\naddEventListener(\"hashchange\", updateTargetWithin);\nvar idObserver = new Mavo.Observer(document.documentElement, \"id\", updateTargetWithin);\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Locale = $.Class({\n\tconstructor: function(lang, phrases) {\n\t\tthis.lang = lang;\n\t\tthis.phrases = {};\n\t\tthis.extend(phrases);\n\t},\n\n\tget fallback() {\n\t\t// TODO should we fallback to other dialects? I.e. should en-US fallback to en-GB if en didn't exist?\n\t\tif (_.all[this.baseLang]) {\n\t\t\treturn _.all[this.baseLang];\n\t\t}\n\n\t\tif (this !== _.default) {\n\t\t\treturn _.default;\n\t\t}\n\t},\n\n\textend: function(phrases) {\n\t\t$.extend(this.phrases, phrases);\n\t},\n\n\tphrase: function(id, vars) {\n\t\tvar key = id.toLowerCase();\n\t\tvar phrase = this.phrases[key];\n\n\t\tif (phrase === undefined && this.fallback) {\n\t\t\tphrase = this.fallback.phrase(key);\n\t\t}\n\n\t\tif (phrase === undefined) {\n\t\t\t// Everything failed, use id\n\t\t\tphrase = Mavo.Functions.readable(key);\n\t\t}\n\t\telse if (vars) {\n\t\t\tvar keys = Mavo.matches(phrase, /\\{\\w+(?=\\})/g).map(v => v.slice(1));\n\t\t\tMavo.Functions.unique(keys).forEach(name => {\n\t\t\t\tif (name in vars) {\n\t\t\t\t\tphrase = phrase.replace(RegExp(`{${name}}`, \"gi\"), vars[name]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn phrase;\n\t},\n\n\tlive: {\n\t\tlang: function(lang) {\n\t\t\tthis.baseLang = _.getBaseLang(lang);\n\n\t\t\tif (lang == this.baseLang) {\n\t\t\t\tthis.baseLang = null;\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: {},\n\n\t\t/**\n\t\t * Register new locale or extend existing locale\n\t\t */\n\t\tregister: function(lang, phrases) {\n\t\t\tif (_.all[lang]) {\n\t\t\t\t_.all[lang].extend(phrases);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t_.all[lang] = new _(lang, phrases);\n\t\t\t}\n\t\t},\n\n\t\tmatch: function(lang = \"\") {\n\t\t\treturn _.all[lang] || _.all[_.getBaseLang(lang)];\n\t\t},\n\n\t\tget: function(lang) {\n\t\t\treturn _.match(lang) || _.default;\n\t\t},\n\n\t\tgetBaseLang: function(lang) {\n\t\t\treturn lang.split(\"-\")[0];\n\t\t},\n\n\t\tlazy: {\n\t\t\tdefault: () => {\n\t\t\t\treturn _.match(Mavo.locale) || _.all.en;\n\t\t\t}\n\t\t}\n\t}\n});\n\n/**\n * Use phrase\n */\nMavo.prototype._ = function(id, vars) {\n\treturn this.locale && id? this.locale.phrase(id, vars) : id;\n};\n\n$.ready().then(() => {\n\t$$(\"datalist.mv-phrases[lang]\").forEach(datalist => {\n\t\tvar phrases = $$(\"option\", datalist).reduce((o, option) => {\n\t\t\to[option.value] = option.textContent.trim();\n\t\t\treturn o;\n\t\t}, {});\n\n\t\tMavo.Locale.register(datalist.lang, phrases);\n\t});\n});\n\n})(Bliss, Bliss.$);\n","Mavo.Locale.register(\"en\", {\n\t\"edit\": \"Edit\",\n\t\"save\": \"Save\",\n\t\"import\": \"Import\",\n\t\"export\": \"Export\",\n\t\"logout\": \"Logout\",\n\t\"login\": \"Login\",\n\t\"loading\": \"Loading\",\n\t\"uploading\": \"Uploading\",\n\t\"saving\": \"Saving\",\n\t\"logged-in-as\": \"Logged in to {id} as \",\n\t\"login-to\": \"Login to {id}\",\n\t\"error-uploading\": \"Error uploading file\",\n\t\"cannot-load-uploaded-file\": \"Cannot load uploaded file\",\n\t\"filename\": \"Filename?\",\n\t\"problem-saving\": \"Problem saving data\",\n\t\"problem-loading\": \"Problem loading data\",\n\t\"cannot-parse\": \"Cant understand this file\",\n\t\"http-error\": \"HTTP error {status}: {statusText}\",\n\t\"cant-connect\": \"Cant connect to the Internet\",\n\t\"add-item\": \"Add {name}\",\n\t\"add-item-before\": \"Add new {name} before\",\n\t\"add-item-after\": \"Add new {name} after\",\n\t\"drag-to-reorder\": \"Drag to reorder {name}\",\n\t\"delete-item\": \"Delete this {name}\",\n\t\"gh-updated-file\": \"Updated {name}\",\n\t\"gh-edit-suggestion-saved-in-profile\": \"Your edits are saved to <a href=\\\"{previewURL}\\\" target=\\\"_blank\\\">your own profile</a>, because you are not allowed to edit this page.\",\n\t\"gh-edit-suggestion-instructions\": \"Write a short description of your edits below to suggest them to the page admins:\",\n\t\"gh-edit-suggestion-notreviewed\": \"You have selected to suggest your edits to the page admins. Your suggestions have not been reviewed yet.\",\n\t\"gh-edit-suggestion-send\": \"Send edit suggestion\",\n\t\"gh-edit-suggestion-revoke\": \"Revoke edit suggestion\",\n\t\"gh-edit-suggestion-reason-placeholder\": \"I added / corrected / deleted ...\",\n\t\"gh-edit-suggestion-cancelled\": \"Edit suggestion cancelled successfully!\",\n\t\"gh-edit-suggestion-title\": \"Suggested edits to data\",\n\t\"gh-edit-suggestion-body\": `Hello there! I used Mavo to suggest the following edits:\n{description}\nPreview my changes here: {previewURL}`,\n\t\"gh-edit-suggestion-sent\": \"Edit suggestion sent successfully!\"\n});\n","(function ($, $$) {\n\nMavo.attributes.push(\"mv-plugins\");\n\nvar _ = Mavo.Plugins = {\n\tloaded: {},\n\n\tload: function() {\n\t\t_.plugins = new Set();\n\n\t\t$$(\"[mv-plugins]\").forEach(element => {\n\t\t\telement\n\t\t\t\t.getAttribute(\"mv-plugins\").trim().split(/\\s+/)\n\t\t\t\t.forEach(plugin => _.plugins.add(plugin));\n\t\t});\n\n\t\tif (!_.plugins.size) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\t// Fetch plugin index\n\t\treturn $.fetch(_.url + \"/plugins.json\", {\n\t\t\tresponseType: \"json\"\n\t\t}).then(xhr => {\n\t\t\t// Fetch plugins\n\t\t\treturn Mavo.thenAll(xhr.response.plugin\n\t\t\t\t.filter(plugin => _.plugins.has(plugin.id))\n\t\t\t\t.map(plugin => {\n\t\t\t\t\t// Load plugin\n\t\t\t\t\tvar filename = `mavo-${plugin.id}.js`;\n\n\t\t\t\t\tif (plugin.repo) {\n\t\t\t\t\t\t// Plugin hosted in a separate repo\n\t\t\t\t\t\tvar url = `https://raw.githubusercontent.com/${plugin.repo}/master/${filename}`;\n\n\t\t\t\t\t\treturn _.loaded[plugin.id]? Promise.resolve() : $.fetch(url).then(xhr => {\n\t\t\t\t\t\t\t$.create(\"script\", {\n\t\t\t\t\t\t\t\ttextContent: xhr.responseText,\n\t\t\t\t\t\t\t\tinside: document.head\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t// Plugin hosted in the mavo-plugins repo\n\t\t\t\t\t\tvar url = `${_.url}/${plugin.id}/${filename}`;\n\n\t\t\t\t\t\treturn $.include(_.loaded[plugin.id], url);\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t});\n\t},\n\n\tregister: function(name, o = {}) {\n\t\tif (_.loaded[name]) {\n\t\t\t// Do not register same plugin twice\n\t\t\treturn;\n\t\t}\n\n\t\tMavo.hooks.add(o.hooks);\n\n\t\tfor (let Class in o.extend) {\n\t\t\tlet existing = Class == \"Mavo\"? Mavo : Mavo[Class];\n\n\t\t\tif ($.type(existing) === \"function\") {\n\t\t\t\t$.Class(existing, o.extend[Class]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$.extend(existing, o.extend[Class]);\n\t\t\t}\n\t\t}\n\n\t\tvar ready = [];\n\n\t\tif (o.ready) {\n\t\t\tready.push(o.ready);\n\t\t}\n\n\t\tif (o.dependencies) {\n\t\t\tvar base = document.currentScript? document.currentScript.src : location;\n\t\t\tvar dependencies = o.dependencies.map(url => Mavo.load(url, base));\n\t\t\tready.push(...dependencies);\n\t\t}\n\n\t\tif (ready.length) {\n\t\t\tMavo.dependencies.push(...ready);\n\t\t}\n\n\t\t_.loaded[name] = o;\n\n\t\tif (o.init) {\n\t\t\tPromise.all(ready).then(() => o.init());\n\t\t}\n\t},\n\n\turl: \"https://plugins.mavo.io\"\n};\n\n})(Bliss, Bliss.$);\n","(function ($, $$) {\n\nMavo.attributes.push(\"mv-bar\");\n\nvar _ = Mavo.UI.Bar = $.Class({\n\tconstructor: function(mavo) {\n\t\tthis.mavo = mavo;\n\n\t\tthis.element = $(\".mv-bar\", this.mavo.element);\n\t\tthis.template = this.mavo.element.getAttribute(\"mv-bar\") || \"\";\n\n\t\tif (this.element) {\n\t\t\tthis.custom = true;\n\t\t\tthis.template += \" \" + (this.element.getAttribute(\"mv-bar\") || \"\");\n\t\t\tthis.template = this.template.trim();\n\n\t\t\tfor (let id in _.controls) {\n\t\t\t\tthis[id] = $(`.mv-${id}`, this.element);\n\n\t\t\t\tif (this[id]) {\n\t\t\t\t\tthis.template = this.template || \"with\";\n\t\t\t\t\tthis.template += ` ${id}`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.element = $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.mavo.element,\n\t\t\t\tinnerHTML: \"<button>&nbsp;</button>\"\n\t\t\t});\n\t\t}\n\n\t\tif (this.element.classList.contains(\"mv-compact\")) {\n\t\t\tthis.noResize = true;\n\t\t}\n\n\t\t// yes- is deprecated and will be removed\n\t\tif (/\\byes-\\w+/.test(this.template)) {\n\t\t\tconsole.warn(`${this.mavo.id}: You used mv-bar=\"${this.template}\". Note that yes-* in mv-bar is deprecated and will be removed in v0.1.6. Please use the new syntax: http://mavo.io/docs/ui/#bar`);\n\t\t}\n\n\t\tthis.controls = _.getControls(this.template);\n\n\t\tif (this.controls.length) {\n\t\t\t// Measure height of 1 row\n\t\t\tthis.targetHeight = this.element.offsetHeight;\n\t\t}\n\n\t\tif (!this.custom) {\n\t\t\tthis.element.innerHTML = \"\";\n\t\t}\n\n\t\tthis.controls.forEach(id => {\n\t\t\tlet o = _.controls[id];\n\n\t\t\tif (this[id]) {\n\t\t\t\t// Custom control, remove to not mess up order\n\t\t\t\tthis[id].remove();\n\t\t\t}\n\n\t\t\tif (o.create) {\n\t\t\t\tthis[id] = o.create.call(this.mavo, this[id]);\n\t\t\t}\n\t\t\telse if (!this[id]) {\n\t\t\t\tthis[id] = $.create(\"button\", {\n\t\t\t\t\tclassName: `mv-${id}`,\n\t\t\t\t\ttextContent: this.mavo._(id)\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// We initially add all of them to retain order,\n\t\t\t// then we remove revocably when/if needed\n\t\t\tthis.add(id);\n\n\t\t\tif (o.permission) {\n\t\t\t\tthis.permissions.can(o.permission, () => {\n\t\t\t\t\tthis.toggle(id, !o.condition || o.condition.call(this.mavo));\n\t\t\t\t}, () => {\n\t\t\t\t\tthis.remove(id);\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (o.condition && !o.condition.call(this.mavo)) {\n\t\t\t\tthis.remove(id);\n\t\t\t}\n\n\t\t\tfor (var events in o.events) {\n\t\t\t\t$.bind(this[id], events, o.events[events].bind(this.mavo));\n\t\t\t}\n\t\t});\n\n\t\tfor (let id in _.controls) {\n\t\t\tlet o = _.controls[id];\n\n\t\t\tif (o.action) {\n\t\t\t\t$.delegate(this.mavo.element, \"click\", \".mv-\" + id, evt => {\n\t\t\t\t\tif (!o.permission || this.permissions.is(o.permission)) {\n\t\t\t\t\t\to.action.call(this.mavo);\n\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (this.controls.length && !this.noResize) {\n\t\t\tthis.resize();\n\n\t\t\tif (self.ResizeObserver) {\n\t\t\t\tthis.resizeObserver = Mavo.observeResize(this.element, entries => {\n\t\t\t\t\tthis.resize();\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tresize: function() {\n\t\tif (!this.targetHeight) {\n\t\t\t// We don't have a correct measurement for target height, abort\n\t\t\tthis.targetHeight = this.element.offsetHeight;\n\t\t\treturn;\n\t\t}\n\n\t\tthis.resizeObserver && this.resizeObserver.disconnect();\n\n\t\tthis.element.classList.remove(\"mv-compact\", \"mv-tiny\");\n\n\t\t// Exceeded single row?\n\t\tif (this.element.offsetHeight > this.targetHeight * 1.6) {\n\t\t\tthis.element.classList.add(\"mv-compact\");\n\n\t\t\tif (this.element.offsetHeight > this.targetHeight * 1.2) {\n\t\t\t\t// Still too tall\n\t\t\t\tthis.element.classList.add(\"mv-tiny\");\n\t\t\t}\n\t\t}\n\n\t\tthis.resizeObserver && this.resizeObserver.observe(this.element);\n\t},\n\n\tadd: function(id) {\n\t\tvar o =_.controls[id];\n\n\t\tif (o.prepare) {\n\t\t\to.prepare.call(this.mavo);\n\t\t}\n\n\t\tMavo.revocably.add(this[id], this.element);\n\n\t\tif (!this.resizeObserver && !this.noResize) {\n\t\t\trequestAnimationFrame(() => this.resize());\n\t\t}\n\t},\n\n\tremove: function(id) {\n\t\tvar o =_.controls[id];\n\n\t\tMavo.revocably.remove(this[id], \"mv-\" + id);\n\n\t\tif (o.cleanup) {\n\t\t\to.cleanup.call(this.mavo);\n\t\t}\n\n\t\tif (!this.resizeObserver && !this.noResize) {\n\t\t\trequestAnimationFrame(() => this.resize());\n\t\t}\n\t},\n\n\ttoggle: function(id, add) {\n\t\treturn this[add? \"add\" : \"remove\"](id);\n\t},\n\n\tproxy: {\n\t\t\"permissions\": \"mavo\"\n\t},\n\n\tstatic: {\n\t\tgetControls: function(template) {\n\t\t\tvar all = Object.keys(_.controls);\n\n\t\t\tif (template && (template = template.trim())) {\n\t\t\t\tif (template == \"none\") {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\tvar relative = /^with\\s|\\b(yes|no)-\\w+\\b/.test(template);\n\t\t\t\ttemplate = template.replace(/\\byes-|^with\\s+/g, \"\");\n\t\t\t\tvar ids = template.split(/\\s+/);\n\n\t\t\t\t// Drop duplicates (last one wins)\n\t\t\t\tids = Mavo.Functions.unique(ids.reverse()).reverse();\n\n\t\t\t\tif (relative) {\n\t\t\t\t\treturn all.filter(id => {\n\t\t\t\t\t\tvar positive = ids.lastIndexOf(id);\n\t\t\t\t\t\tvar negative = ids.lastIndexOf(\"no-\" + id);\n\t\t\t\t\t\tvar keep = positive > Math.max(-1, negative);\n\t\t\t\t\t\tvar drop = negative > Math.max(-1, positive);\n\n\t\t\t\t\t\treturn keep || (!_.controls[id].optional && !drop);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn ids;\n\t\t\t}\n\n\t\t\t// No template, return default set\n\t\t\treturn all.filter(id => !_.controls[id].optional);\n\t\t},\n\n\t\tcontrols: {\n\t\t\tstatus: {\n\t\t\t\tcreate: function(custom) {\n\t\t\t\t\treturn custom || $.create({\n\t\t\t\t\t\tclassName: \"mv-status\"\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tprepare: function() {\n\t\t\t\t\tvar backend = this.primaryBackend;\n\n\t\t\t\t\tif (backend && backend.user) {\n\t\t\t\t\t\tvar user = backend.user;\n\t\t\t\t\t\tvar html = user.name || \"\";\n\n\t\t\t\t\t\tif (user.avatar) {\n\t\t\t\t\t\t\thtml = `<img class=\"mv-avatar\" src=\"${user.avatar}\" /> ${html}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (user.url) {\n\t\t\t\t\t\t\thtml = `<a href=\"${user.url}\" target=\"_blank\">${html}</a>`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.bar.status.innerHTML = `<span>${this._(\"logged-in-as\", backend)}</span> ` + html;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpermission: \"logout\"\n\t\t\t},\n\n\t\t\tedit: {\n\t\t\t\taction: function() {\n\t\t\t\t\tif (this.editing) {\n\t\t\t\t\t\tthis.done();\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis.edit();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpermission: [\"edit\", \"add\", \"delete\"],\n\t\t\t\tcleanup: function() {\n\t\t\t\t\tif (this.editing) {\n\t\t\t\t\t\tthis.done();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcondition: function() {\n\t\t\t\t\treturn this.needsEdit;\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tsave: {\n\t\t\t\taction: function() {\n\t\t\t\t\tthis.save();\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\t\"mouseenter focus\": function() {\n\t\t\t\t\t\tthis.element.classList.add(\"mv-highlight-unsaved\");\n\t\t\t\t\t},\n\t\t\t\t\t\"mouseleave blur\": function() {\n\t\t\t\t\t\tthis.element.classList.remove(\"mv-highlight-unsaved\");\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpermission: \"save\",\n\t\t\t\tcondition: function() {\n\t\t\t\t\treturn !this.autoSave || this.autoSaveDelay > 0;\n\t\t\t\t}\n\t\t\t},\n\n\t\t\texport: {\n\t\t\t\tcreate: function(custom) {\n\t\t\t\t\tvar a;\n\n\t\t\t\t\tif (custom) {\n\t\t\t\t\t\ta = custom.matches(\"a\")? custom : $.create(\"a\", {\n\t\t\t\t\t\t\tclassName: \"mv-button\",\n\t\t\t\t\t\t\taround: custom\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\ta = $.create(\"a\", {\n\t\t\t\t\t\t\tclassName: \"mv-export mv-button\",\n\t\t\t\t\t\t\ttextContent: this._(\"export\")\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\ta.setAttribute(\"download\", this.id + \".json\");\n\n\t\t\t\t\treturn a;\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tmousedown: function() {\n\t\t\t\t\t\tthis.bar.export.href = \"data:application/json;charset=UTF-8,\" + encodeURIComponent(this.toJSON());\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpermission: \"edit\",\n\t\t\t\toptional: true\n\t\t\t},\n\n\t\t\timport: {\n\t\t\t\tcreate: function(custom) {\n\t\t\t\t\tvar button = custom || $.create(\"span\", {\n\t\t\t\t\t\trole: \"button\",\n\t\t\t\t\t\ttabIndex: \"0\",\n\t\t\t\t\t\tclassName: \"mv-import mv-button\",\n\t\t\t\t\t\ttextContent: this._(\"import\"),\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tfocus: evt => {\n\t\t\t\t\t\t\t\tinput.focus();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tvar input = $.create(\"input\", {\n\t\t\t\t\t\ttype: \"file\",\n\t\t\t\t\t\tinside: button,\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tchange: evt => {\n\t\t\t\t\t\t\t\tvar file = evt.target.files[0];\n\n\t\t\t\t\t\t\t\tif (file) {\n\t\t\t\t\t\t\t\t\tvar reader = $.extend(new FileReader(), {\n\t\t\t\t\t\t\t\t\t\tonload: evt => {\n\t\t\t\t\t\t\t\t\t\t\tthis.inProgress = false;\n\n\t\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\t\tvar json = JSON.parse(reader.result);\n\t\t\t\t\t\t\t\t\t\t\t\tthis.render(json);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tcatch (e) {\n\t\t\t\t\t\t\t\t\t\t\t\tthis.error(this._(\"cannot-parse\"));\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tonerror: evt => {\n\t\t\t\t\t\t\t\t\t\t\tthis.error(this._(\"problem-loading\"));\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\tthis.inProgress = this._(\"uploading\");\n\t\t\t\t\t\t\t\t\treader.readAsText(file);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn button;\n\t\t\t\t},\n\t\t\t\toptional: true\n\t\t\t},\n\n\t\t\tlogin: {\n\t\t\t\taction: function() {\n\t\t\t\t\tthis.primaryBackend.login();\n\t\t\t\t},\n\t\t\t\tpermission: \"login\"\n\t\t\t},\n\n\t\t\tlogout: {\n\t\t\t\taction: function() {\n\t\t\t\t\tthis.primaryBackend.logout();\n\t\t\t\t},\n\t\t\t\tpermission: \"logout\"\n\t\t\t}\n\t\t},\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function ($, $$) {\n\nvar _ = Mavo.UI.Message = $.Class({\n\tconstructor: function(mavo, message, o) {\n\t\tthis.mavo = mavo;\n\t\tthis.message = message;\n\t\tthis.closed = Mavo.defer();\n\n\t\tthis.element = $.create({\n\t\t\tclassName: \"mv-ui mv-message\" + (o.type? \" mv-\" + o.type : \"\"),\n\t\t\tinnerHTML: this.message,\n\t\t\tevents: {\n\t\t\t\tclick: e => Mavo.scrollIntoViewIfNeeded(this.mavo.element)\n\t\t\t},\n\t\t\t[this.mavo.bar? \"after\" : \"start\"]: (this.mavo.bar || this.mavo).element\n\t\t});\n\n\t\tif (o.classes) {\n\t\t\tthis.element.classList.add(o.classes);\n\t\t}\n\n\t\tif (o.type == \"error\") {\n\t\t\tthis.element.setAttribute(\"role\", \"alert\");\n\t\t}\n\t\telse {\n\t\t\tthis.element.setAttribute(\"aria-live\", \"polite\");\n\t\t}\n\n\t\to.dismiss = o.dismiss || {};\n\n\t\tif (typeof o.dismiss == \"string\" || Array.isArray(o.dismiss)) {\n\t\t\tvar dismiss = {};\n\n\t\t\tMavo.toArray(o.dismiss).forEach(prop => {\n\t\t\t\tdismiss[prop] = true;\n\t\t\t});\n\t\t\t\n\t\t\to.dismiss = dismiss;\n\t\t}\n\n\t\tif (o.dismiss.button) {\n\t\t\t$.create(\"button\", {\n\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\ttextContent: \"\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": evt => this.close()\n\t\t\t\t},\n\t\t\t\tstart: this.element\n\t\t\t});\n\t\t}\n\n\t\tif (o.dismiss.timeout) {\n\t\t\tvar timeout = typeof o.dismiss.timeout === \"number\"? o.dismiss.timeout : 5000;\n\t\t\tvar closeTimeout;\n\n\t\t\t$.bind(this.element, {\n\t\t\t\tmouseenter: e => clearTimeout(closeTimeout),\n\t\t\t\tmouseleave: Mavo.rr(e => closeTimeout = setTimeout(() => this.close(), timeout)),\n\t\t\t});\n\t\t}\n\n\t\tif (o.dismiss.submit) {\n\t\t\tthis.element.addEventListener(\"submit\", evt => {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.close(evt.target);\n\t\t\t});\n\t\t}\n\t},\n\n\tclose: function(resolve) {\n\t\t$.transition(this.element, {opacity: 0}).then(() => {\n\t\t\t$.remove(this.element);\n\t\t\tthis.closed.resolve(resolve);\n\t\t});\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Permissions = $.Class({\n\tconstructor: function(o) {\n\t\tthis.triggers = [];\n\t\tthis.hooks = new $.Hooks();\n\n\t\t// If we dont do this, there is no way to retrieve this from inside parentChanged\n\t\tthis.parentChanged = _.prototype.parentChanged.bind(this);\n\n\t\tthis.set(o);\n\t},\n\n\t// Set multiple permissions at once\n\tset: function(o) {\n\t\tfor (var action in o) {\n\t\t\tthis[action] = o[action];\n\t\t}\n\t},\n\n\t// Set a bunch of permissions to true. Chainable.\n\ton: function(actions) {\n\t\tMavo.toArray(actions).forEach(action => this[action] = true);\n\n\t\treturn this;\n\t},\n\n\t// Set a bunch of permissions to false. Chainable.\n\toff: function(actions) {\n\t\tactions = Array.isArray(actions)? actions : [actions];\n\n\t\tactions.forEach(action => this[action] = false);\n\n\t\treturn this;\n\t},\n\n\t// Fired once at least one of the actions passed can be performed\n\t// Kind of like a Promise that can be resolved multiple times.\n\tcan: function(actions, callback, cannot) {\n\t\tthis.observe(actions, true, callback);\n\n\t\tif (cannot) {\n\t\t\t// Fired once the action cannot be done anymore, even though it could be done before\n\t\t\tthis.cannot(actions, cannot);\n\t\t}\n\t},\n\n\t// Fired once NONE of the actions can be performed\n\tcannot: function(actions, callback) {\n\t\tthis.observe(actions, false, callback);\n\t},\n\n\t// Schedule a callback for when a set of permissions changes value\n\tobserve: function(actions, value, callback) {\n\t\tactions = Mavo.toArray(actions);\n\n\t\tif (this.is(actions, value)) {\n\t\t\t// Should be fired immediately\n\t\t\tcallback();\n\t\t}\n\n\t\t// For future transitions\n\t\tthis.triggers.push({ actions, value, callback, active: true });\n\t},\n\n\t// Compare a set of permissions with true or false\n\t// If comparing with true, we want at least one to be true, i.e. OR\n\t// If comparing with false, we want ALL to be false, i.e. NOR\n\tis: function(actions, able = true) {\n\t\tvar or = Mavo.toArray(actions).map(action => !!this[action])\n\t\t                .reduce((prev, current) => prev || current);\n\n\t\treturn able? or : !or;\n\t},\n\n\t// Monitor all changes\n\tonchange: function(callback) {\n\t\t// Future changes\n\t\tthis.hooks.add(\"change\", callback);\n\n\t\t// Fire for current values\n\t\t_.actions.forEach(action => {\n\t\t\tcallback.call(this, {action, value: this[action]});\n\t\t});\n\t},\n\n\tparentChanged: function(o = {}) {\n\t\tvar localValue = this[\"_\" + o.action];\n\n\t\tif (localValue !== undefined || o.from == o.value) {\n\t\t\t// We have a local value so we dont care about parent changes OR nothing changed\n\t\t\treturn;\n\t\t}\n\n\t\tthis.fireTriggers(o.action);\n\n\t\tthis.hooks.run(\"change\", $.extend({context: this}, o));\n\t},\n\n\t// A single permission changed value\n\tchanged: function(action, value, from) {\n\t\tfrom = !!from;\n\t\tvalue = !!value;\n\n\t\tif (value == from) {\n\t\t\t// Nothing changed\n\t\t\treturn;\n\t\t}\n\n\t\t// $.live() calls the setter before the actual property is set so we\n\t\t// need to set it manually, otherwise it still has its previous value\n\t\tthis[\"_\" + action] = value;\n\n\t\tthis.fireTriggers(action);\n\n\t\tthis.hooks.run(\"change\", {action, value, from, context: this});\n\t},\n\n\tfireTriggers: function(action) {\n\t\tthis.triggers.forEach(trigger => {\n\t\t\tvar match = this.is(trigger.actions, trigger.value);\n\n\t\t\tif (trigger.active && trigger.actions.indexOf(action) > -1 && match) {\n\n\t\t\t\ttrigger.active = false;\n\t\t\t\ttrigger.callback();\n\t\t\t}\n\t\t\telse if (!match) {\n\t\t\t\t// This is so that triggers can only be executed in an actual transition\n\t\t\t\t// And that if there is a trigger for [a,b] it won't be executed twice\n\t\t\t\t// if a and b are set to true one after the other\n\t\t\t\ttrigger.active = true;\n\t\t\t}\n\t\t});\n\t},\n\n\tor: function(permissions) {\n\t\t_.actions.forEach(action => {\n\t\t\tthis[action] = this[action] || permissions[action];\n\t\t});\n\n\t\treturn this;\n\t},\n\n\tlive: {\n\t\tparent: function(parent) {\n\t\t\tvar oldParent = this._parent;\n\n\t\t\tif (oldParent == parent) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._parent = parent;\n\n\t\t\t// Remove previous trigger, if any\n\t\t\tif (oldParent) {\n\t\t\t\tMavo.delete(oldParent.hooks.change, this.parentChanged);\n\t\t\t}\n\n\t\t\t// What changes does this cause? Fire triggers for them\n\t\t\t_.actions.forEach(action => {\n\t\t\t\tthis.parentChanged({\n\t\t\t\t\taction,\n\t\t\t\t\tvalue: parent? parent[action] : undefined,\n\t\t\t\t\tfrom: oldParent? oldParent[action] : undefined\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tif (parent) {\n\t\t\t\t// Add new trigger\n\t\t\t\tparent.onchange(this.parentChanged);\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tactions: [],\n\n\t\t// Register a new permission type\n\t\tregister: function(action, setter) {\n\t\t\tif (Array.isArray(action)) {\n\t\t\t\taction.forEach(action => _.register(action, setter));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$.live(_.prototype, action, {\n\t\t\t\tget: function() {\n\t\t\t\t\tvar ret = this[\"_\" + action];\n\n\t\t\t\t\tif (ret === undefined && this.parent) {\n\t\t\t\t\t\treturn this.parent[action];\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ret;\n\t\t\t\t},\n\t\t\t\tset: function(able, previous) {\n\t\t\t\t\tif (setter) {\n\t\t\t\t\t\tsetter.call(this, able, previous);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.changed(action, able, previous);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t_.actions.push(action);\n\t\t}\n\t}\n});\n\n_.register([\"read\", \"save\"]);\n\n_.register(\"login\", function(can) {\n\tif (can && this.logout) {\n\t\tthis.logout = false;\n\t}\n});\n\n_.register(\"logout\", function(can) {\n\tif (can && this.login) {\n\t\tthis.login = false;\n\t}\n});\n\n_.register(\"edit\", function(can) {\n\tif (can) {\n\t\tthis.add = this.delete = true;\n\t}\n});\n\n_.register([\"add\", \"delete\"], function(can) {\n\tif (!can) {\n\t\tthis.edit = false;\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\n/**\n * Base class for all backends\n */\nvar _ = Mavo.Backend = $.Class({\n\tconstructor: function(url, o = {}) {\n\t\tthis.update(url, o);\n\n\t\t// Permissions of this particular backend.\n\t\tthis.permissions = new Mavo.Permissions();\n\t},\n\n\tupdate: function(url, o = {}) {\n\t\tthis.source = url;\n\t\tthis.url = new URL(this.source, Mavo.base);\n\t\tthis.mavo = o.mavo;\n\t\tthis.format = Mavo.Formats.create(o.format, this);\n\t},\n\n\tget: function(url = new URL(this.url)) {\n\t\turl.searchParams.set(\"timestamp\", Date.now()); // ensure fresh copy\n\n\t\treturn $.fetch(url.href).then(xhr => Promise.resolve(xhr.responseText), () => Promise.resolve(null));\n\t},\n\n\tload: function() {\n\t\treturn this.ready\n\t\t\t.then(() => this.get())\n\t\t\t.then(response => {\n\t\t\t\tif (typeof response != \"string\") {\n\t\t\t\t\t// Backend did the parsing, we're done here\n\t\t\t\t\treturn response;\n\t\t\t\t}\n\n\t\t\t\tresponse = response.replace(/^\\ufeff/, \"\"); // Remove Unicode BOM\n\n\t\t\t\treturn this.format.parse(response);\n\t\t\t});\n\t},\n\n\tstore: function(data, {path, format = this.format} = {}) {\n\t\treturn this.ready.then(() => {\n\t\t\tvar serialize = typeof data === \"string\"? Promise.resolve(data) : format.stringify(data);\n\n\t\t\treturn serialize.then(serialized => this.put(serialized, path).then(() => {\n\t\t\t\treturn {data, serialized};\n\t\t\t}));\n\t\t});\n\t},\n\n\t// To be be overriden by subclasses\n\tready: Promise.resolve(),\n\tlogin: () => Promise.resolve(),\n\tlogout: () => Promise.resolve(),\n\tput: () => Promise.reject(),\n\n\tisAuthenticated: function() {\n\t\treturn !!this.accessToken;\n\t},\n\n\t// Any extra params to be passed to the oAuth URL.\n\toAuthParams: () => \"\",\n\n\ttoString: function() {\n\t\treturn `${this.id} (${this.url})`;\n\t},\n\n\tequals: function(backend) {\n\t\treturn backend === this || (backend && this.id == backend.id && this.source == backend.source);\n\t},\n\n\t/**\n\t * Helper for making OAuth requests with JSON-based APIs.\n\t */\n\trequest: function(call, data, method = \"GET\", req = {}) {\n\t\treq = $.extend({}, req); // clone\n\t\treq.method = req.method || method;\n\t\treq.responseType = req.responseType || \"json\";\n\n\t\treq.headers = $.extend({\n\t\t\t\"Content-Type\": \"application/json; charset=utf-8\"\n\t\t}, req.headers || {});\n\n\t\treq.data = data;\n\n\t\tif (this.isAuthenticated()) {\n\t\t\treq.headers[\"Authorization\"] = req.headers[\"Authorization\"] || `Bearer ${this.accessToken}`;\n\t\t}\n\n\t\tif ($.type(req.data) === \"object\") {\n\t\t\tif (req.method == \"GET\") {\n\t\t\t\treq.data = Object.keys(req.data).map(p => p + \"=\" + encodeURIComponent(req.data[p])).join(\"&\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\treq.data = JSON.stringify(req.data);\n\t\t\t}\n\t\t}\n\n\t\tcall = new URL(call, this.constructor.apiDomain);\n\n\t\t// Prevent getting a cached response. Cache-control is often not allowed via CORS\n\t\tif (req.method == \"GET\") {\n\t\t\tcall.searchParams.set(\"timestamp\", Date.now());\n\t\t}\n\n\t\treturn $.fetch(call, req)\n\t\t\t.catch(err => {\n\t\t\t\tif (err && err.xhr) {\n\t\t\t\t\treturn Promise.reject(err.xhr);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.mavo.error(\"Something went wrong while connecting to \" + this.id, err);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(xhr => req.method == \"HEAD\"? xhr : xhr.response);\n\t},\n\n\t/**\n\t * Helper method for authenticating in OAuth APIs\n\t */\n\toAuthenticate: function(passive) {\n\t\treturn this.ready.then(() => {\n\t\t\tif (this.isAuthenticated()) {\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tvar id = this.id.toLowerCase();\n\n\t\t\t\tif (passive) {\n\t\t\t\t\tthis.accessToken = localStorage[`mavo:${id}token`];\n\n\t\t\t\t\tif (this.accessToken) {\n\t\t\t\t\t\tresolve(this.accessToken);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Show window\n\t\t\t\t\tvar popup = {\n\t\t\t\t\t\twidth: Math.min(1000, innerWidth - 100),\n\t\t\t\t\t\theight: Math.min(800, innerHeight - 100)\n\t\t\t\t\t};\n\n\t\t\t\t\tpopup.top = (screen.height - popup.height)/2;\n\t\t\t\t\tpopup.left = (screen.width - popup.width)/2;\n\n\t\t\t\t\tvar state = {\n\t\t\t\t\t\turl: location.href,\n\t\t\t\t\t\tbackend: this.id\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.authPopup = open(`${this.constructor.oAuth}?client_id=${this.key}&state=${encodeURIComponent(JSON.stringify(state))}` + this.oAuthParams(),\n\t\t\t\t\t\t\"popup\", `width=${popup.width},height=${popup.height},left=${popup.left},top=${popup.top}`);\n\n\t\t\t\t\tif (!this.authPopup) {\n\t\t\t\t\t\tvar message = \"Login popup was blocked! Please check your popup blocker settings.\";\n\t\t\t\t\t\tthis.mavo.error(message);\n\t\t\t\t\t\treject(Error(message));\n\t\t\t\t\t}\n\n\t\t\t\t\taddEventListener(\"message\", evt => {\n\t\t\t\t\t\tif (evt.source === this.authPopup) {\n\t\t\t\t\t\t\tif (evt.data.backend == this.id) {\n\t\t\t\t\t\t\t\tthis.accessToken = localStorage[`mavo:${id}token`] = evt.data.token;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (!this.accessToken) {\n\t\t\t\t\t\t\t\treject(Error(\"Authentication error\"));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(this.accessToken);\n\n\t\t\t\t\t\t\t// Log in to other similar backends that are logged out\n\t\t\t\t\t\t\tfor (var appid in Mavo.all) {\n\t\t\t\t\t\t\t\tvar storage = Mavo.all[appid].primaryBackend;\n\n\t\t\t\t\t\t\t\tif (storage\n\t\t\t\t\t\t\t\t\t&& storage.id === this.id\n\t\t\t\t\t\t\t\t\t&& storage !== this\n\t\t\t\t\t\t\t\t\t&& !storage.isAuthenticated()) {\n\t\t\t\t\t\t\t\t\t\tstorage.login(true);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\n\t/**\n\t * oAuth logout helper\n\t */\n\toAuthLogout: function() {\n\t\tif (this.isAuthenticated()) {\n\t\t\tvar id = this.id.toLowerCase();\n\n\t\t\tlocalStorage.removeItem(`mavo:${id}token`);\n\t\t\tdelete this.accessToken;\n\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\", \"save\"]).on(\"login\");\n\n\t\t\t$.fire(this.mavo.element, \"mv-logout\", {backend: this});\n\t\t}\n\n\t\treturn Promise.resolve();\n\t},\n\n\tstatic: {\n\t\t// Return the appropriate backend(s) for this url\n\t\tcreate: function(url, o, type, existing) {\n\t\t\tvar Backend;\n\n\t\t\tif (type) {\n\t\t\t\tBackend = Mavo.Functions.get(_, type);\n\t\t\t}\n\n\t\t\tif (url && !Backend) {\n\t\t\t\tBackend = _.types.filter(Backend => Backend.test(url))[0] || _.Remote;\n\t\t\t}\n\n\t\t\t// Can we re-use the existing object perhaps?\n\t\t\tif (Backend && existing && existing.constructor === Backend && existing.constructor.prototype.hasOwnProperty(\"update\")) {\n\t\t\t\texisting.update(url, o);\n\t\t\t\treturn existing;\n\t\t\t}\n\n\t\t\treturn Backend? new Backend(url, o) : null;\n\t\t},\n\n\t\ttypes: [],\n\n\t\tregister: function(Class) {\n\t\t\t_[Class.prototype.id] = Class;\n\t\t\t_.types.push(Class);\n\t\t\treturn Class;\n\t\t}\n\t}\n});\n\n/**\n * Save in an HTML element\n */\n_.register($.Class({\n\tid: \"Element\",\n\textends: _,\n\tconstructor: function () {\n\t\tthis.permissions.on([\"read\", \"edit\", \"save\"]);\n\t},\n\n\tupdate: function(url, o) {\n\t\tthis.super.update.call(this, url, o);\n\n\t\tthis.element = $(this.source) || $.create(\"script\", {\n\t\t\ttype: \"application/json\",\n\t\t\tid: this.source.slice(1),\n\t\t\tinside: document.body\n\t\t});\n\t},\n\n\tget: function() {\n\t\treturn Promise.resolve(this.element.textContent);\n\t},\n\n\tput: function(serialized) {\n\t\treturn Promise.resolve(this.element.textContent = serialized);\n\t},\n\n\tstatic: {\n\t\ttest: url => url.indexOf(\"#\") === 0\n\t}\n}));\n\n// Load from a remote URL, no save\n_.register($.Class({\n\tid: \"Remote\",\n\textends: _,\n\tconstructor: function() {\n\t\tthis.permissions.on(\"read\");\n\t},\n\n\tstatic: {\n\t\ttest: url => false\n\t}\n}));\n\n// Save in localStorage\n_.register($.Class({\n\textends: _,\n\tid: \"Local\",\n\tconstructor: function() {\n\t\tthis.permissions.on([\"read\", \"edit\", \"save\"]);\n\t\tthis.key = this.mavo.id;\n\t},\n\n\tget: function() {\n\t\treturn Promise[this.key in localStorage? \"resolve\" : \"reject\"](localStorage[this.key]);\n\t},\n\n\tput: function(serialized) {\n\t\tif (!serialized) {\n\t\t\tdelete localStorage[this.key];\n\t\t}\n\t\telse {\n\t\t\tlocalStorage[this.key] = serialized;\n\t\t}\n\n\t\treturn Promise.resolve(serialized);\n\t},\n\n\tstatic: {\n\t\ttest: value => value == \"local\"\n\t}\n}));\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Formats = {};\n\nvar base = _.Base = $.Class({\n\tabstract: true,\n\tconstructor: function(backend) {\n\t\tthis.backend = backend;\n\t},\n\tproxy: {\n\t\t\"mavo\": \"backend\"\n\t},\n\n\t// So that child classes can only override the static methods if they don't\n\t// need access to any instance variables.\n\tparse: function(content) {\n\t\treturn this.constructor.parse(content, this);\n\t},\n\tstringify: function(data) {\n\t\treturn this.constructor.stringify(data, this);\n\t},\n\n\tstatic: {\n\t\tparse: serialized => Promise.resolve(serialized),\n\t\tstringify: data => Promise.resolve(data),\n\t\textensions: [],\n\t\tdependencies: [],\n\t\tready: function() {\n\t\t\treturn Promise.all(this.dependencies.map(d => $.include(d.test(), d.url)));\n\t\t}\n\t}\n});\n\nvar json = _.JSON = $.Class({\n\textends: _.Base,\n\tstatic: {\n\t\tparse: serialized => Promise.resolve(serialized? JSON.parse(serialized) : null),\n\t\tstringify: data => Promise.resolve(Mavo.toJSON(data)),\n\t\textensions: [\".json\", \".jsonld\"]\n\t}\n});\n\nvar text = _.Text = $.Class({\n\textends: _.Base,\n\tconstructor: function(backend) {\n\t\tthis.property = this.mavo.root.getNames(\"Primitive\")[0];\n\t},\n\n\tstatic: {\n\t\textensions: [\".txt\"],\n\t\tparse: (serialized, me) => Promise.resolve({[me? me.property : \"content\"]: serialized}),\n\t\tstringify: (data, me) => Promise.resolve(data[me? me.property : \"content\"])\n\t}\n});\n\nvar csv = _.CSV = $.Class({\n\textends: _.Base,\n\tconstructor: function(backend) {\n\t\tthis.property = this.mavo.root.getNames(\"Collection\")[0];\n\t\tthis.options = $.extend({}, _.CSV.defaultOptions);\n\t},\n\n\tstatic: {\n\t\textensions: [\".csv\", \".tsv\"],\n\t\tdefaultOptions: {\n\t\t\theader: true,\n\t\t\tdynamicTyping: true,\n\t\t\tskipEmptyLines: true\n\t\t},\n\t\tdependencies: [{\n\t\t\ttest: () => self.Papa,\n\t\t\turl: \"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse.min.js\"\n\t\t}],\n\t\tready: base.ready,\n\t\tparse: (serialized, me) => csv.ready().then(() => {\n\t\t\tvar data = Papa.parse(serialized, csv.defaultOptions);\n\t\t\tvar property = me? me.property : \"content\";\n\n\t\t\tif (me) {\n\t\t\t\t// Get delimiter & linebreak for serialization\n\t\t\t\tme.options.delimiter = data.meta.delimiter;\n\t\t\t\tme.options.linebreak = data.meta.linebreak;\n\t\t\t}\n\n\t\t\tif (data.meta.aborted) {\n\t\t\t\tthrow data.meta.errors.pop();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\t[property]: data.data\n\t\t\t};\n\t\t}),\n\n\t\tstringify: (data, me) => csv.ready().then(() => {\n\t\t\tvar property = me? me.property : \"content\";\n\t\t\tvar options = me? me.options : csv.defaultOptions;\n\t\t\treturn Papa.unparse(data[property], options);\n\t\t})\n\t}\n});\n\nObject.defineProperty(_, \"create\", {\n\tvalue: function(format, backend) {\n\t\tif (format && typeof format === \"object\") {\n\t\t\treturn format;\n\t\t}\n\n\t\tif (typeof format === \"string\") {\n\t\t\t// Search by id\n\t\t\tformat = format.toLowerCase();\n\n\t\t\tfor (var id in _) {\n\t\t\t\tvar Format = _[id];\n\n\t\t\t\tif (id.toLowerCase() == format) {\n\t\t\t\t\treturn new Format(backend);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!format) {\n\t\t\tvar url = backend.url? backend.url.pathname : backend.source;\n\t\t\tvar extension = Mavo.match(url, /\\.\\w+$/) || \".json\";\n\t\t\tvar Format = _.JSON;\n\n\t\t\tfor (var id in _) {\n\t\t\t\tif (_[id].extensions.indexOf(extension) > -1) {\n\t\t\t\t\t// Do not return match, as we may find another match later\n\t\t\t\t\t// and last match wins\n\t\t\t\t\tFormat = _[id];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn new Format(backend);\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Node = $.Class({\n\tabstract: true,\n\tconstructor: function (element, mavo, options = {}) {\n\t\tif (!element || !mavo) {\n\t\t\tthrow new Error(\"Mavo.Node constructor requires an element argument and a mavo object\");\n\t\t}\n\n\t\tvar env = {context: this, options};\n\n\t\t// Set these first, for debug reasons\n\t\tthis.uid = ++_.maxId;\n\t\tthis.nodeType = this.nodeType;\n\t\tthis.property = null;\n\t\tthis.element = element;\n\n\t\t$.extend(this, env.options);\n\n\t\t_.all.set(element, [...(_.all.get(this.element) || []), this]);\n\n\t\tthis.mavo = mavo;\n\t\tthis.group = this.parentGroup = env.options.group;\n\n\t\tthis.template = env.options.template;\n\n\t\tthis.alias = this.element.getAttribute(\"mv-alias\");\n\n\t\tif (this.template) {\n\t\t\tthis.template.copies.push(this);\n\t\t}\n\t\telse {\n\t\t\t// First (or only) of its kind\n\t\t\tthis.copies = [];\n\t\t}\n\n\t\tif (!this.fromTemplate(\"property\", \"type\")) {\n\t\t\tthis.property = _.getProperty(element);\n\t\t\tthis.type = Mavo.Group.normalize(element);\n\t\t\tthis.storage = this.element.getAttribute(\"mv-storage\");\n\t\t}\n\n\t\tthis.modes = this.element.getAttribute(\"mv-mode\");\n\n\t\tMavo.hooks.run(\"node-init-start\", env);\n\n\t\tthis.mode = Mavo.getStyle(this.element, \"--mv-mode\") || \"read\";\n\n\t\tthis.collection = env.options.collection;\n\n\t\tif (this.collection) {\n\t\t\t// This is a collection item\n\t\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t\t}\n\n\t\t// Must run before collections have a marker which messes up paths\n\t\tvar template = this.template;\n\n\t\tif (template && template.expressions) {\n\t\t\t// We know which expressions we have, don't traverse again\n\t\t\tthis.expressions = template.expressions.map(et => new Mavo.DOMExpression({\n\t\t\t\ttemplate: et,\n\t\t\t\titem: this,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\n\t\tif (this instanceof Mavo.Group || this.collection) {\n\t\t\t// Handle mv-value\n\t\t\t// TODO integrate with the code in Primitive that decides whether this is a computed property\n\t\t\tvar et = Mavo.DOMExpression.search(this.element).filter(et => et.originalAttribute == \"mv-value\")[0];\n\n\t\t\tif (et) {\n\t\t\t\tet.mavoNode = this;\n\t\t\t\tthis.expressionText = et;\n\t\t\t\tthis.storage = this.storage || \"none\";\n\t\t\t\tthis.modes = \"read\";\n\n\t\t\t\tif (this.collection) {\n\t\t\t\t\tthis.collection.expressions = [...(this.collection.expressions || []), et];\n\t\t\t\t\tet.mavoNode = this.collection;\n\t\t\t\t\tthis.collection.storage = this.collection.storage || \"none\";\n\t\t\t\t\tthis.collection.modes = \"read\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tMavo.hooks.run(\"node-init-end\", env);\n\t},\n\n\tget editing() {\n\t\treturn this.mode == \"edit\";\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tget name() {\n\t\treturn Mavo.Functions.readable(this.property || this.type).toLowerCase();\n\t},\n\n\tget saved() {\n\t\treturn this.storage !== \"none\";\n\t},\n\n\tget parent() {\n\t\treturn this.collection || this.parentGroup;\n\t},\n\n\t/**\n\t * Runs after the constructor is done (including the constructor of the inheriting class), synchronously\n\t */\n\tpostInit: function() {\n\t\tif (this.modes == \"edit\") {\n\t\t\tthis.edit();\n\t\t}\n\t},\n\n\tdestroy: function() {\n\t\tif (this.template) {\n\t\t\tMavo.delete(this.template.copies, this);\n\t\t}\n\n\t\tif (this.expressions) {\n\t\t\tthis.expressions.forEach(expression => expression.destroy());\n\t\t}\n\n\t\tif (this.itembar) {\n\t\t\tthis.itembar.destroy();\n\t\t}\n\t},\n\n\tgetData: function(o = {}) {\n\t\tif (this.isDataNull(o)) {\n\t\t\treturn o.forceObjects? Mavo.objectify(null) : null;\n\t\t}\n\t},\n\n\tisDataNull: function(o) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tresult: this.deleted || !this.saved && !o.live\n\t\t};\n\n\t\tMavo.hooks.run(\"unit-isdatanull\", env);\n\n\t\treturn env.result;\n\t},\n\n\t/**\n\t * Execute a callback on every node of the Mavo tree\n\t * If callback returns (strict) false, walk stops.\n\t * @param callback {Function}\n\t * @param path {Array} Initial path. Mostly used internally.\n\t * @param o {Object} Options:\n\t * \t\t\t- descentReturn {Boolean} If callback returns false, just don't descend\n\t * @return false if was stopped via a false return value, true otherwise\n\t */\n\twalk: function(callback, path = [], o = {}) {\n\t\tvar walker = (obj, path) => {\n\t\t\tvar ret = callback(obj, path);\n\n\t\t\tif (ret !== false) {\n\t\t\t\tfor (let i in obj.children) {\n\t\t\t\t\tlet node = obj.children[i];\n\n\t\t\t\t\tif (node instanceof Mavo.Node) {\n\t\t\t\t\t\tvar ret = walker.call(node, node, [...path, i]);\n\n\t\t\t\t\t\tif (ret === false && !o.descentReturn) {\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret !== false;\n\t\t};\n\n\t\treturn walker(this, path);\n\t},\n\n\twalkUp: function(callback) {\n\t\tvar group = this;\n\n\t\twhile (group = group.parentGroup) {\n\t\t\tvar ret = callback(group);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.mode = \"edit\";\n\n\t\tif (this.mode != \"edit\") {\n\t\t\treturn false;\n\t\t}\n\n\t\t$.fire(this.element, \"mv-edit\", {\n\t\t\tmavo: this.mavo,\n\t\t\tnode: this\n\t\t});\n\n\t\tMavo.hooks.run(\"node-edit-end\", this);\n\t},\n\n\tdone: function() {\n\t\tthis.mode = Mavo.getStyle(this.element.parentNode, \"--mv-mode\") || \"read\";\n\n\t\tif (this.mode != \"read\") {\n\t\t\treturn false;\n\t\t}\n\n\t\t$.unbind(this.element, \".mavo:edit\");\n\n\t\t$.fire(this.element, \"mv-done\", {\n\t\t\tmavo: this.mavo,\n\t\t\tnode: this\n\t\t});\n\n\t\tthis.propagate(\"done\");\n\n\t\tMavo.hooks.run(\"node-done-end\", this);\n\t},\n\n\tpropagate: function(callback) {\n\t\tfor (let i in this.children) {\n\t\t\tlet node = this.children[i];\n\n\t\t\tif (node instanceof Mavo.Node) {\n\t\t\t\tif (typeof callback === \"function\") {\n\t\t\t\t\tcallback.call(node, node);\n\t\t\t\t}\n\t\t\t\telse if (callback in node) {\n\t\t\t\t\tnode[callback]();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\", \"destroy\"],\n\n\ttoJSON: Mavo.prototype.toJSON,\n\n\tfromTemplate: function(...properties) {\n\t\tif (this.template) {\n\t\t\tproperties.forEach(property => this[property] = this.template[property]);\n\t\t}\n\n\t\treturn !!this.template;\n\t},\n\n\trender: function(data) {\n\t\tthis.oldData = this.data;\n\t\tthis.data = data;\n\n\t\tdata = Mavo.subset(data, this.inPath);\n\n\t\tvar env = {context: this, data};\n\n\t\tMavo.hooks.run(\"node-render-start\", env);\n\n\t\tif (this.nodeType != \"Collection\" && Array.isArray(data)) {\n\t\t\t// We are rendering an array on a singleton, what to do?\n\t\t\tvar properties;\n\n\t\t\tif (this.isRoot && (properties = this.getNames(\"Collection\")).length === 1) {\n\t\t\t\t// If it's root with only one collection property, render on that property\n\t\t\t\tenv.data = {\n\t\t\t\t\t[properties[0]]: env.data\n\t\t\t\t};\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Otherwise, render first item\n\t\t\t\tthis.inPath.push(\"0\");\n\t\t\t\tenv.data = env.data[0];\n\t\t\t}\n\t\t}\n\n\t\tif (this.editing) {\n\t\t\tthis.done();\n\t\t\tthis.dataRender(env.data);\n\t\t\tthis.edit();\n\t\t}\n\t\telse {\n\t\t\tthis.dataRender(env.data);\n\t\t}\n\n\t\tthis.save();\n\n\t\tMavo.hooks.run(\"node-render-end\", env);\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\t$.fire(o.element || this.element, \"mv-change\", $.extend({\n\t\t\tproperty: this.property,\n\t\t\taction,\n\t\t\tmavo: this.mavo,\n\t\t\tnode: this\n\t\t}, o));\n\t},\n\n\ttoString: function() {\n\t\treturn `#${this.uid}: ${this.nodeType} (${this.property})`;\n\t},\n\n\tgetClosestCollection: function() {\n\t\tvar closestItem = this.closestItem;\n\n\t\treturn closestItem? closestItem.collection : null;\n\t},\n\n\tgetClosestItem: function() {\n\t\tif (this.collection && this.collection.mutable) {\n\t\t\treturn this;\n\t\t}\n\n\t\treturn this.parentGroup? this.parentGroup.closestItem : null;\n\t},\n\n\t/**\n\t * Check if this unit is either deleted or inside a deleted group\n\t */\n\tisDeleted: function() {\n\t\tvar ret = this.deleted;\n\n\t\tif (this.deleted) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n\t},\n\n\t// Resolve a property name from this node\n\tresolve: function(property, o = {}) {\n\t\t// First look in descendants\n\t\tvar ret = this.find(property, o);\n\n\t\tif (ret === undefined) {\n\t\t\t// Still not found, look in ancestors\n\t\t\tret = this.walkUp(group => {\n\t\t\t\tif (group.property == property) {\n\t\t\t\t\treturn group;\n\t\t\t\t}\n\n\t\t\t\tif (property in group.children) {\n\t\t\t\t\treturn group.children[property];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (ret === undefined) {\n\t\t\t// Still not found, look anywhere\n\t\t\tret = this.mavo.root.find(property, o);\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\trelativizeData: self.Proxy? function(data, options = {live: true}) {\n\t\treturn new Proxy(data, {\n\t\t\tget: (data, property, proxy) => {\n\t\t\t\tif (property in data) {\n\t\t\t\t\treturn data[property];\n\t\t\t\t}\n\n\t\t\t\t// Checking if property is in proxy might add it to the cache\n\t\t\t\tif (property in proxy && property in this.proxyCache) {\n\t\t\t\t\treturn this.proxyCache[property];\n\t\t\t\t}\n\t\t\t},\n\n\t\t\thas: (data, property) => {\n\t\t\t\tif (property in data || property in this.proxyCache) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t// Special values\n\t\t\t\tswitch (property) {\n\t\t\t\t\tcase \"$index\":\n\t\t\t\t\t\tthis.proxyCache[property] = this.index || 0;\n\t\t\t\t\t\treturn true; // if index is 0 it's falsy and has would return false!\n\t\t\t\t\tcase \"$next\":\n\t\t\t\t\tcase \"$previous\":\n\t\t\t\t\t\tif (this.closestCollection) {\n\t\t\t\t\t\t\tthis.proxyCache[property] = this.closestCollection.getData(options)[this.index + (property == \"$next\"? 1 : -1)];\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.proxyCache[property] = null;\n\t\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t// First look in descendants\n\t\t\t\tvar ret = this.resolve(property);\n\n\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\tret = ret.map(item => item.getData(options))\n\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t}\n\t\t\t\t\telse if (ret instanceof Mavo.Node) {\n\t\t\t\t\t\tret = ret.getData(options);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.proxyCache[property] = ret;\n\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\t// Does it reference another Mavo?\n\t\t\t\tif (property in Mavo.all && isNaN(property) && Mavo.all[property].root) {\n\t\t\t\t\treturn this.proxyCache[property] = Mavo.all[property].root.getData(options);\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\n\t\t\tset: function(data, property = \"\", value) {\n\t\t\t\tconsole.warn(`You cannot set data via expressions. Attempt to set ${property.toString()} to ${value} ignored.`);\n\t\t\t\treturn value;\n\t\t\t}\n\t\t});\n\t} : data => data,\n\n\tcreateLiveData: function(obj = {}) {\n\t\tthis.liveData = obj;\n\t\tthis.liveData[Mavo.toNode] = this;\n\t\tthis.liveData[Mavo.toProxy] = this.relativizeData(this.liveData);\n\t\treturn this.liveData;\n\t},\n\n\tpathFrom: function(node) {\n\t\tvar path = this.path;\n\t\tvar nodePath = node.path;\n\n\t\tfor (var i = 0; i<path.length && nodePath[i] == path[i]; i++) {}\n\n\t\treturn path.slice(i);\n\t},\n\n\tgetDescendant: function(path) {\n\t\treturn path.reduce((acc, cur) => acc.children[cur], this);\n\t},\n\n\t/**\n\t * Get same node in other item in same collection\n\t * E.g. for same node in the next item, use an offset of -1\n\t */\n\tgetCousin: function(offset, o = {}) {\n\t\tif (!this.closestCollection) {\n\t\t\treturn null;\n\t\t}\n\n\t\tvar collection = this.closestCollection;\n\t\tvar distance = Math.abs(offset);\n\t\tvar direction =  offset < 0? -1 : 1;\n\n\t\tif (collection.length < distance + 1) {\n\t\t\treturn null;\n\t\t}\n\n\t\tvar index = this.closestItem.index + offset;\n\n\t\tif (o.wrap) {\n\t\t\tindex = Mavo.wrap(index, collection.length);\n\t\t}\n\n\t\tfor (var i = 0; i<collection.length; i++) {\n\t\t\tvar ind = index + i * direction;\n\t\t\tind = o.wrap? Mavo.wrap(ind, collection.length) : ind;\n\n\t\t\tvar item = collection.children[ind];\n\n\t\t\tif (!item || !item.isDeleted()) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (!item || item.isDeleted() || item == this.closestItem) {\n\t\t\treturn null;\n\t\t}\n\n\t\tif (this.collection) {\n\t\t\treturn item;\n\t\t}\n\n\t\tvar relativePath = this.pathFrom(this.closestItem);\n\t\treturn item.getDescendant(relativePath);\n\t},\n\n\tcontains: function(node) {\n\t\tdo {\n\t\t\tif (node === this) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tnode = node.parent;\n\t\t}\n\t\twhile (node);\n\n\t\treturn false;\n\t},\n\n\tlazy: {\n\t\tclosestCollection: function() {\n\t\t\treturn this.getClosestCollection();\n\t\t},\n\n\t\tclosestItem: function() {\n\t\t\treturn this.getClosestItem();\n\t\t},\n\n\t\t// Are we only rendering and editing a subset of the data?\n\t\tinPath: function() {\n\t\t\tvar attribute = this.nodeType == \"Collection\"? \"mv-multiple-path\" : \"mv-path\";\n\n\t\t\treturn (this.element.getAttribute(attribute) || \"\").split(\"/\").filter(p => p.length);\n\t\t},\n\n\t\tproperties: function() {\n\t\t\tif (this.template) {\n\t\t\t\treturn this.template.properties;\n\t\t\t}\n\n\t\t\tvar ret = new Set(this.property && [this.property]);\n\n\t\t\tif (this.nodeType == \"Group\") {\n\t\t\t\tfor (var property in this.children) {\n\t\t\t\t\tret = Mavo.union(ret, this.children[property].properties);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (this.nodeType == \"Collection\") {\n\t\t\t\tret = Mavo.union(ret, this.itemTemplate.properties);\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tproxyCache: function() {\n\t\t\treturn {};\n\t\t}\n\t},\n\n\tlive: {\n\t\tstore: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-storage\", value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tif (value && (!this.saved || !this.editing)) {\n\t\t\t\tvalue = false;\n\t\t\t}\n\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\n\t\t\treturn value;\n\t\t},\n\n\t\tmode: function (value) {\n\t\t\tif (this._mode != value) {\n\t\t\t\t// Is it allowed?\n\t\t\t\tif (this.modes && value != this.modes) {\n\t\t\t\t\tvalue = this.modes;\n\t\t\t\t}\n\n\t\t\t\t// If we don't do this, setting the attribute below will\n\t\t\t\t// result in infinite recursion\n\t\t\t\tthis._mode = value;\n\n\t\t\t\tif (!(this instanceof Mavo.Collection) && [null, \"\", \"read\", \"edit\"].indexOf(this.element.getAttribute(\"mv-mode\")) > -1) {\n\t\t\t\t\t// If attribute is not one of the recognized values, leave it alone\n\t\t\t\t\tvar set = this.modes || value == \"edit\";\n\t\t\t\t\tMavo.Observer.sneak(this.mavo.modeObserver, () => {\n\t\t\t\t\t\t$.toggleAttribute(this.element, \"mv-mode\", value, set);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\t\t},\n\n\t\tmodes: function(value) {\n\t\t\tif (value && value != \"read\" && value != \"edit\") {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tthis._modes = value;\n\n\t\t\tif (value && this.mode != value) {\n\t\t\t\tthis.mode = value;\n\t\t\t}\n\t\t},\n\n\t\tdeleted: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-deleted\", value);\n\n\t\t\tif (value) {\n\t\t\t\t// Soft delete, store element contents in a fragment\n\t\t\t\t// and replace them with an undo prompt.\n\t\t\t\tthis.elementContents = document.createDocumentFragment();\n\t\t\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\t\t\tthis.elementContents.appendChild(node);\n\t\t\t\t});\n\n\t\t\t\t$.contents(this.element, [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\t\t\ttextContent: \"\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t\"Deleted \" + this.name,\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\tclassName: \"mv-undo mv-ui\",\n\t\t\t\t\t\ttextContent: \"Undo\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]);\n\n\t\t\t\tthis.element.classList.remove(\"mv-highlight\");\n\t\t\t\tthis.itembar.remove();\n\t\t\t}\n\t\t\telse if (this.deleted) {\n\t\t\t\t// Undelete\n\t\t\t\tthis.element.textContent = \"\";\n\t\t\t\tthis.element.appendChild(this.elementContents);\n\n\t\t\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t\t\t// Alternatively, we could fire datachange with a timeout.\n\t\t\t\tthis._deleted = false;\n\n\t\t\t\tthis.dataChanged(\"undelete\");\n\t\t\t\tthis.itembar.add();\n\t\t\t}\n\t\t},\n\n\t\tpath: {\n\t\t\tget: function() {\n\t\t\t\tvar path = this.parent? this.parent.path : [];\n\n\t\t\t\treturn this.property? [...path, this.property] : path;\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tmaxId: 0,\n\n\t\tall: new WeakMap(),\n\n\t\tcreate: function(element, mavo, o = {}) {\n\t\t\tif (Mavo.is(\"multiple\", element) && !o.collection) {\n\t\t\t\treturn new Mavo.Collection(element, mavo, o);\n\t\t\t}\n\n\t\t\treturn new Mavo[Mavo.is(\"group\", element)? \"Group\" : \"Primitive\"](element, mavo, o);\n\t\t},\n\n\t\t/**\n\t\t * Get & normalize property name, if exists\n\t\t */\n\t\tgetProperty: function(element) {\n\t\t\tvar property = element.getAttribute(\"property\") || element.getAttribute(\"itemprop\");\n\n\t\t\tif (!property) {\n\t\t\t\tif (element.hasAttribute(\"property\")) { // property used without a value\n\t\t\t\t\tproperty = element.name || element.id || element.classList[0];\n\t\t\t\t}\n\t\t\t\telse if (element.matches(Mavo.selectors.multiple)) {\n\t\t\t\t\t// mv-multiple used without property, generate name\n\t\t\t\t\tproperty = element.getAttribute(\"mv-multiple\") || \"collection\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (property) {\n\t\t\t\telement.setAttribute(\"property\", property);\n\t\t\t}\n\n\t\t\treturn property;\n\t\t},\n\n\t\tget: function(element, prioritizePrimitive) {\n\t\t\tvar nodes = (_.all.get(element) || []).filter(node => !(node instanceof Mavo.Collection));\n\n\t\t\tif (nodes.length < 2 || !prioritizePrimitive) {\n\t\t\t\treturn nodes[0];\n\t\t\t}\n\n\t\t\tif (nodes[0] instanceof Mavo.Group) {\n\t\t\t\treturn node[1];\n\t\t\t}\n\t\t},\n\n\t\tgetClosest: function(element, prioritizePrimitive) {\n\t\t\tvar node;\n\n\t\t\tdo {\n\t\t\t\tnode = _.get(element, prioritizePrimitive);\n\t\t\t} while (!node && (element = element.parentNode));\n\n\t\t\treturn node;\n\t\t},\n\n\t\t/**\n\t\t * Get all properties that are inside an element but not nested into other properties\n\t\t */\n\t\tchildren: function(element) {\n\t\t\tvar ret = Mavo.Node.get(element);\n\n\t\t\tif (ret) {\n\t\t\t\t// element is a Mavo node\n\t\t\t\treturn [ret];\n\t\t\t}\n\n\t\t\tret = $$(Mavo.selectors.property, element)\n\t\t\t\t.map(e => Mavo.Node.get(e))\n\t\t\t\t.filter(e => !element.contains(e.parentGroup.element)) // drop nested properties\n\t\t\t\t.map(e => e.collection || e);\n\n\t\t\treturn Mavo.Functions.unique(ret);\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Group = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Group\",\n\tconstructor: function (element, mavo, o) {\n\t\tthis.children = {};\n\n\t\tthis.group = this;\n\n\t\tMavo.hooks.run(\"group-init-start\", this);\n\n\t\t// Should this element also create a primitive?\n\t\tif (Mavo.Primitive.getValueAttribute(this.element)) {\n\t\t\tvar obj = this.children[this.property] = new Mavo.Primitive(this.element, this.mavo, {group: this});\n\t\t}\n\n\t\t// Create Mavo objects for all properties in this group (primitives or groups),\n\t\t// but not properties in descendant groups (they will be handled by their group)\n\t\tvar properties = $$(Mavo.selectors.property + \", \" + Mavo.selectors.multiple, this.element).filter(element => {\n\t\t\treturn this.element === element.parentNode.closest(Mavo.selectors.group);\n\t\t});\n\n\t\tvar propertyNames = properties.map(element => Mavo.Node.getProperty(element));\n\n\t\tproperties.forEach((element, i) => {\n\t\t\tvar property = propertyNames[i];\n\t\t\tvar template = this.template? this.template.children[property] : null;\n\t\t\tvar options = {template, group: this};\n\n\t\t\tif (this.children[property]) {\n\t\t\t\t// Already exists, must be a collection\n\t\t\t\tvar collection = this.children[property];\n\t\t\t\tcollection.add(element);\n\t\t\t\tcollection.mutable = collection.mutable || Mavo.is(\"multiple\", element);\n\t\t\t}\n\t\t\telse if (propertyNames.indexOf(property) != propertyNames.lastIndexOf(property)) {\n\t\t\t\t// There are duplicates, so this should be a collection.\n\t\t\t\tthis.children[property] = new Mavo.Collection(element, this.mavo, options);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Normal case\n\t\t\t\tthis.children[property] = Mavo.Node.create(element, this.mavo, options);\n\t\t\t}\n\t\t});\n\n\t\tthis.childrenNames = Object.keys(this.children);\n\n\t\tvar vocabElement = (this.isRoot? this.element.closest(\"[vocab]\") : null) || this.element;\n\t\tthis.vocab = vocabElement.getAttribute(\"vocab\");\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"group-init-end\", this);\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tgetNames: function(type = \"Node\") {\n\t\treturn Object.keys(this.children).filter(p => this.children[p] instanceof Mavo[type]);\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\t// Super method returned something\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = this.liveData;\n\n\t\tif (this.childrenNames.length == 1 && this.childrenNames[0] == this.property) {\n\t\t\t// {foo: {foo: 5}} should become {foo: 5}\n\t\t\tvar options = $.extend($.extend({}, env.options), {forceObjects: true});\n\t\t\tenv.data = this.children[this.property].getData(options);\n\t\t}\n\t\telse {\n\t\t\tfor (var property in this.children) {\n\t\t\t\tvar obj = this.children[property];\n\n\t\t\t\tif (obj.saved || env.options.live) {\n\t\t\t\t\tvar data = obj.getData(env.options);\n\t\t\t\t}\n\n\t\t\t\tif (env.options.live || obj.saved && Mavo.value(data) !== null) {\n\t\t\t\t\tenv.data[obj.property] = data;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdelete env.data[obj.property];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (env.options.live) {\n\t\t\tthis.proxyCache = {};\n\t\t}\n\t\telse { // Stored data again\n\t\t\t// If storing, use the rendered data too\n\t\t\tenv.data = Mavo.subset(this.data, this.inPath, env.data);\n\n\t\t\tif (!this.childrenNames.length && !this.isRoot) {\n\t\t\t\t// Avoid {} in the data\n\t\t\t\tenv.data = null;\n\t\t\t}\n\t\t\telse if (env.data && typeof env.data === \"object\") {\n\t\t\t\t// Add JSON-LD stuff\n\t\t\t\tif (this.type && this.type != _.DEFAULT_TYPE) {\n\t\t\t\t\tenv.data[\"@type\"] = this.type;\n\t\t\t\t}\n\n\t\t\t\tif (this.vocab) {\n\t\t\t\t\tenv.data[\"@context\"] = this.vocab;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn (env.options.live? env.data[Mavo.toProxy] : env.data) || env.data;\n\t},\n\n\t/**\n\t * Search entire subtree for property, return relative value\n\t * @return {Mavo.Node}\n\t */\n\tfind: function(property, o = {}) {\n\t\tif (o.exclude === this) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif (property in this.children) {\n\t\t\treturn this.children[property].find(property, o);\n\t\t}\n\n\t\tif (!this.properties.has(property)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar results = [], returnArray, ret;\n\n\t\tfor (var prop in this.children) {\n\t\t\tret = this.children[prop].find(property, o);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\tresults.push(...ret);\n\t\t\t\t\treturnArray = true;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tresults.push(ret);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn returnArray || results.length > 1? results : results[0];\n\t},\n\n\tedit: function(o = {}) {\n\t\tif (this.super.edit.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn Promise.all(Object.keys(this.children).map(prop => this.children[prop].edit(o)));\n\t},\n\n\tsave: function() {\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tpropagated: [\"save\", \"import\"],\n\n\t// Do not call directly, call this.render() instead\n\tdataRender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\t// What if data is not an object?\n\t\tif (typeof data !== \"object\") {\n\t\t\tvar wasPrimitive = true;\n\n\t\t\t// Data is a primitive, render it on this.property or failing that, any writable property\n\t\t\tif (this.property in this.children) {\n\t\t\t\tvar property = this.property;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar type = $.type(data);\n\t\t\t\tvar score = prop => (this.children[prop] instanceof Mavo.Primitive) + (this.children[prop].datatype == type);\n\n\t\t\t\tvar property = Object.keys(this.children)\n\t\t\t\t\t.filter(p => !this.children[p].expressionText)\n\t\t\t\t\t.sort((prop1, prop2) => score(prop1) - score(prop2))\n\t\t\t\t\t.reverse()[0];\n\t\t\t}\n\n\t\t\tdata = {[property]: data};\n\n\t\t\tthis.data = Mavo.subset(this.data, this.inPath, data);\n\t\t}\n\n\t\tvar copy; // to handle renaming\n\n\t\tthis.propagate(obj => {\n\t\t\tvar propertyData = data[obj.property];\n\n\t\t\tif (obj.alias && data[obj.alias] !== undefined) {\n\t\t\t\tcopy = copy || $.extend({}, data);\n\t\t\t\tpropertyData = data[obj.alias];\n\t\t\t}\n\n\t\t\tobj.render(propertyData);\n\t\t});\n\n\t\t// Rename properties. This needs to be done separately to handle swapping.\n\t\tif (copy) {\n\t\t\tthis.propagate(obj => {\n\t\t\t\tif (obj.alias) {\n\t\t\t\t\tdata[obj.property] = copy[obj.alias];\n\n\t\t\t\t\tif (!(obj.alias in this.children)) {\n\t\t\t\t\t\tdelete data[obj.alias];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (!wasPrimitive) {\n\t\t\t// Fire mv-change events for properties not in the template,\n\t\t\t// since nothing else will and they can still be referenced in expressions\n\t\t\tvar oldData = Mavo.subset(this.oldData, this.inPath);\n\n\t\t\tfor (var property in data) {\n\t\t\t\tif (!(property in this.children)) {\n\t\t\t\t\tvar value = data[property];\n\n\t\t\t\t\tif (typeof value != \"object\" && (!oldData || oldData[property] != value)) {\n\t\t\t\t\t\tthis.dataChanged(\"propertychange\", {property});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.createLiveData(data);\n\t},\n\n\tlazy: {\n\t\tliveData: function() {\n\t\t\treturn this.createLiveData();\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tDEFAULT_TYPE: \"Item\",\n\n\t\tnormalize: function(element) {\n\t\t\t// Get & normalize typeof name, if exists\n\t\t\tif (Mavo.is(\"group\", element)) {\n\t\t\t\tvar type = Mavo.getAttribute(element, \"typeof\", \"itemtype\") || _.DEFAULT_TYPE;\n\n\t\t\t\telement.setAttribute(\"typeof\", type);\n\n\t\t\t\treturn type;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Primitive\",\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"config\", \"attribute\", \"templateValue\", \"originalEditor\")) {\n\t\t\tthis.config = _.getConfig(element);\n\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = this.config.attribute;\n\t\t}\n\n\t\tthis.datatype = this.config.datatype;\n\n\t\tif (\"modes\" in this.config) {\n\t\t\t// If modes are related to element type, this overrides everything\n\t\t\t// because it means the other mode makes no sense for that element\n\t\t\tthis.modes = this.config.modes;\n\t\t\tthis.element.setAttribute(\"mv-mode\", this.config.modes);\n\t\t}\n\n\t\tMavo.hooks.run(\"primitive-init-start\", this);\n\n\t\t// Link primitive with its expressionText object\n\t\t// We need to do this before any editing UI is generated\n\t\tthis.expressionText = this.expressionText || Mavo.DOMExpression.search(this.element, this.attribute);\n\n\t\tif (this.expressionText && !this.expressionText.mavoNode) {\n\t\t\t// Computed property\n\t\t\tthis.expressionText.primitive = this;\n\t\t\tthis.storage = this.storage || \"none\";\n\t\t\tthis.modes = \"read\";\n\t\t\tthis.element.setAttribute(\"aria-live\", \"polite\");\n\t\t}\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\t // Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"mv-edit\")) {\n\t\t\tif (!this.originalEditor) {\n\t\t\t\tthis.originalEditor = $(this.element.getAttribute(\"mv-edit\"));\n\t\t\t}\n\n\t\t\tif (this.originalEditor) {\n\t\t\t\t// Update editor if original mutates\n\t\t\t\t// This means that expressions on mv-edit for individual collection items will not be picked up\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tthis.originalEditorObserver = new Mavo.Observer(this.originalEditor, \"all\", records => {\n\t\t\t\t\t\tthis.copies.concat(this).forEach(primitive => {\n\t\t\t\t\t\t\tif (primitive.defaultSource == \"editor\") {\n\t\t\t\t\t\t\t\tprimitive.default = this.originalEditor.value;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (primitive.editor) {\n\t\t\t\t\t\t\t\tprimitive.editor = this.originalEditor.cloneNode(true);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.originalEditor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\tvar editorValue = this.editorValue;\n\n\t\tif (!this.datatype && (typeof editorValue == \"number\" || typeof editorValue == \"boolean\")) {\n\t\t\tthis.datatype = typeof editorValue;\n\t\t}\n\n\t\tif (this.config.init) {\n\t\t\tthis.config.init.call(this, this.element);\n\t\t}\n\n\t\tif (this.config.changeEvents) {\n\t\t\t$.bind(this.element, this.config.changeEvents, evt => {\n\t\t\t\tif (evt.target === this.element) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tthis.templateValue = this.getValue();\n\n\t\tthis._default = this.element.getAttribute(\"mv-default\");\n\n\t\tif (this.default === null) { // no mv-default\n\t\t\tthis._default = this.modes? this.templateValue : editorValue;\n\t\t\tthis.defaultSource = this.modes? \"template\" : \"editor\";\n\t\t}\n\t\telse if (this.default === \"\") { // mv-default exists, no value, default is template value\n\t\t\tthis._default = this.templateValue;\n\t\t\tthis.defaultSource = \"template\";\n\t\t}\n\t\telse { // mv-default with value\n\t\t\tthis.defaultObserver = new Mavo.Observer(this.element, \"mv-default\", record => {\n\t\t\t\tthis.default = this.element.getAttribute(\"mv-default\");\n\t\t\t});\n\t\t\tthis.defaultSource = \"attribute\";\n\t\t}\n\n\t\tvar keepTemplateValue = !this.template // not in a collection or first item\n\t\t                        || this.template.templateValue != this.templateValue // or different template value than first item\n\t\t\t\t\t\t\t\t|| this.modes == \"edit\"; // or is always edited\n\n\t\tif (this.default === undefined && keepTemplateValue) {\n\t\t\tthis.initialValue = this.templateValue;\n\t\t}\n\t\telse {\n\t\t\tthis.initialValue = this.default;\n\t\t}\n\n\t\tif (this.initialValue === undefined) {\n\t\t\tthis.initialValue = this.emptyValue;\n\t\t}\n\n\t\tthis.setValue(this.initialValue, {silent: true});\n\n\t\tMavo.setAttributeShy(this.element, \"aria-label\", this.label);\n\n\t\tif (!this.attribute) {\n\t\t\tMavo.setAttributeShy(this.element, \"mv-attribute\", \"none\");\n\t\t}\n\n\t\tif (this.config.observer !== false) {\n\t\t\t// Observe future mutations to this property, if possible\n\t\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t\t// so we cannot depend on mutation observers for everything :(\n\t\t\tthis.observer = new Mavo.Observer(this.element, this.attribute, records => {\n\t\t\t\tif (this.observer.running && (this.attribute || !this.editing || this.config.subtree)) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t}, {subtree: this.config.subtree, childList: this.config.subtree});\n\t\t}\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"primitive-init-end\", this);\n\t},\n\n\tget editorValue() {\n\t\tvar editor = this.editor || this.originalEditor;\n\n\t\tif (editor) {\n\t\t\tif (editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(editor, {datatype: this.datatype});\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.config.setEditorValue && this.datatype !== \"boolean\") {\n\t\t\treturn this.config.setEditorValue.call(this, value);\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\n\t\t\t\t_.setValue(this.editor, value, {config: this.editorDefaults});\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tdestroy: function() {\n\t\tthis.super.destroy.call(this);\n\n\t\tthis.defaultObserver && this.defaultObserver.destroy();\n\t\tthis.observer && this.observer.destroy();\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data === undefined) {\n\t\t\tenv.data = this.value;\n\n\t\t\tif (env.data === \"\") {\n\t\t\t\tenv.data = null;\n\t\t\t}\n\t\t}\n\n\t\tif (env.options.live) {\n\t\t\tif (this.collection || o.forceObjects) {\n\t\t\t\tenv.data = Mavo.objectify(env.data, {\n\t\t\t\t\t[Mavo.toNode]: this\n\t\t\t\t});\n\n\t\t\t\tenv.data[Mavo.toProxy] = this.relativizeData(env.data);\n\n\t\t\t\tif (this.collection) {\n\t\t\t\t\t// Turn primitive collection items into objects, so we can have $index etc, and their property\n\t\t\t\t\t// name etc resolve relative to them, not their parent group\n\t\t\t\t\tenv.data[this.property] = env.data;\n\t\t\t\t}\n\n\t\t\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\t\t\tthis.proxyCache = {};\n\n\t\t\t\treturn env.data[Mavo.toProxy];\n\t\t\t}\n\t\t}\n\t\telse if (this.inPath.length) {\n\t\t\tenv.data = Mavo.subset(this.data, this.inPath, env.data);\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\tsneak: function(callback) {\n\t\treturn Mavo.Observer.sneak(this.observer, callback);\n\t},\n\n\tsave: function() {\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor && this.originalEditor) {\n\t\t\tthis.editor = this.originalEditor.cloneNode(true);\n\t\t}\n\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = this.config.editor;\n\n\t\t\tif (!editor || this.datatype == \"boolean\") {\n\t\t\t\teditor = Mavo.Elements.defaultConfig[this.datatype || \"string\"].editor;\n\t\t\t}\n\n\t\t\tthis.editor = $.create($.type(editor) === \"function\"? editor.call(this) : editor);\n\t\t\tthis.editorValue = this.value;\n\t\t}\n\n\t\t$.bind(this.editor, {\n\t\t\t\"input change\": evt => {\n\t\t\t\tthis.value = this.editorValue;\n\t\t\t},\n\t\t\t\"mv-change\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tvar multiline = this.editor.matches(\"textarea\");\n\n\t\tif (!multiline) {\n\t\t\tthis.editor.addEventListener(\"focus\", evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t});\n\t\t}\n\n\t\t// Enter should go to the next item or insert a new one\n\t\tif (!this.popup && this.closestCollection && this.editor.matches(Mavo.selectors.textInput)) {\n\t\t\tthis.editor.addEventListener(\"keydown\", evt => {\n\t\t\t\tif (evt.keyCode == 13 && this.closestCollection.editing && (evt.shiftKey || !multiline)) { // Enter\n\t\t\t\t\tvar copy = this.getCousin(1);\n\n\t\t\t\t\tif (!copy) {\n\t\t\t\t\t\t// It's the last item, insert new if top-down\n\t\t\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar next = this.closestCollection.add();\n\t\t\t\t\t\tthis.closestCollection.editItem(next, {immediately: true});\n\t\t\t\t\t}\n\n\t\t\t\t\tcopy = this.getCousin(1);\n\t\t\t\t\tcopy.edit({immediately: true}).then(() => copy.editor.focus());\n\n\t\t\t\t\tif (multiline) {\n\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (evt.keyCode == 8 && (this.empty && this.collection || evt[Mavo.superKey])) {\n\t\t\t\t\t// Backspace on empty primitive or Cmd/Ctrl + Backspace should delete item\n\t\t\t\t\tthis.closestCollection.delete(this.closestItem);\n\n\t\t\t\t\t// Focus on sibling\n\t\t\t\t\tvar sibling = this.getCousin(1) || this.getCousin(-1);\n\n\t\t\t\t\tif (sibling) {\n\t\t\t\t\t\tsibling.edit({immediately: true}).then(() => sibling.editor.focus());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\t// Copy any mv-edit-* attributes from the element to the editor\n\t\tvar dataInput = /^mv-edit-/i;\n\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t}\n\t\t}, this);\n\n\t\tif (this.attribute || this.config.popup) {\n\t\t\tthis.popup = new Mavo.UI.Popup(this);\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function (o = {}) {\n\t\tif (this.super.edit.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Make element focusable, so it can actually receive focus\n\t\tif (this.element.tabIndex === -1) {\n\t\t\tMavo.revocably.setAttribute(this.element, \"tabindex\", \"0\");\n\t\t}\n\n\t\t// Prevent default actions while editing\n\t\t// e.g. following links etc\n\t\tif (!this.modes) {\n\t\t\t$.bind(this.element, \"click.mavo:edit\", evt => evt.preventDefault());\n\t\t}\n\n\t\tthis.preEdit = Mavo.defer(resolve => {\n\t\t\tif (o.immediately) {\n\t\t\t\treturn resolve();\n\t\t\t}\n\n\t\t\tvar timer;\n\n\t\t\tvar events = \"click focus dragover dragenter\".split(\" \").map(e => e + \".mavo:preedit\").join(\" \");\n\t\t\t$.bind(this.element, events, resolve);\n\t\t}).then(() => $.unbind(this.element, \".mavo:preedit\"));\n\n\t\tif (this.config.edit) {\n\t\t\tthis.config.edit.call(this);\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.preEdit.then(() => {\n\t\t\tthis.sneak(() => {\n\t\t\t\t// Actual edit\n\t\t\t\tif (this.initEdit) {\n\t\t\t\t\tthis.initEdit();\n\t\t\t\t}\n\n\t\t\t\tif (this.popup) {\n\t\t\t\t\tthis.popup.prepare();\n\t\t\t\t\tthis.popup.show();\n\t\t\t\t}\n\n\t\t\t\tif (!this.attribute && !this.popup) {\n\t\t\t\t\tif (this.editor.parentNode != this.element) {\n\t\t\t\t\t\tthis.editorValue = this.value;\n\t\t\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.collection) {\n\t\t\t\t\t\tif (document.activeElement === this.element) {\n\t\t\t\t\t\t\tthis.editor.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tMavo.revocably.restoreAttribute(this.element, \"tabindex\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}, // edit\n\n\tdone: function () {\n\t\tif (this.super.done.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (\"preEdit\" in this) {\n\t\t\t$.unbind(this.element, \".mavo:preedit .mavo:edit\");\n\t\t}\n\n\t\tthis.sneak(() => {\n\t\t\tif (this.config.done) {\n\t\t\t\tthis.config.done.call(this);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.close();\n\t\t\t}\n\t\t\telse if (!this.attribute && this.editor) {\n\t\t\t\t$.remove(this.editor);\n\n\t\t\t\t_.setValue(this.element, this.editorValue, {\n\t\t\t\t\tconfig: this.config,\n\t\t\t\t\tattribute: this.attribute,\n\t\t\t\t\tdatatype: this.datatype,\n\t\t\t\t\tmap: this.originalEditor || this.editor\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tif (!this.collection) {\n\t\t\tMavo.revocably.restoreAttribute(this.element, \"tabindex\");\n\t\t}\n\t},\n\n\tdataRender: function(data) {\n\t\tif (data && typeof data === \"object\") {\n\t\t\tif (Symbol.toPrimitive in data) {\n\t\t\t\tdata = data[Symbol.toPrimitive]();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Candidate properties to get a value from\n\t\t\t\tvar properties = Object.keys(data), property;\n\n\t\t\t\tif (properties.length === 1) {\n\t\t\t\t\tproperty = properties[0];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tfor (let p of [this.property, \"value\", \"content\"]) {\n\t\t\t\t\t\tif (p in data) {\n\t\t\t\t\t\t\tproperty = p;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (property) {\n\t\t\t\t\tdata = data[property];\n\t\t\t\t\tthis.inPath.push(property);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\t// New property has been added to the schema and nobody has saved since\n\t\t\tif (!this.modes) {\n\t\t\t\tthis.value = this.closestCollection? this.default : this.templateValue;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.value = data;\n\t\t}\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tif (this.property == property && o.exclude !== this) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, {\n\t\t\tconfig: this.config,\n\t\t\tattribute: this.attribute,\n\t\t\tdatatype: this.datatype\n\t\t});\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.Functions.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t},\n\n\t\teditorDefaults: function() {\n\t\t\treturn this.editor && _.getConfig(this.editor);\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.sneak(() => {\n\t\t\t// Convert nulls and undefineds to empty string\n\t\t\tvalue = value || value === 0 || value === false? value : \"\";\n\n\t\t\tvar oldDatatype = this.datatype;\n\n\t\t\t// If there's no datatype, adopt that of the value\n\t\t\tif (!this.datatype && (typeof value == \"number\" || typeof value == \"boolean\")) {\n\t\t\t\tthis.datatype = typeof value;\n\t\t\t}\n\n\t\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\t\tif (!o.force && value == this._value && oldDatatype == this.datatype) {\n\t\t\t\t// Do nothing if value didn't actually change, unless forced to\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (this.editor && document.activeElement != this.editor) {\n\t\t\t\t// If external forces are changing the value (i.e. not the editor)\n\t\t\t\t// and an editor is present, set its value to match\n\t\t\t\tthis.editorValue = value;\n\t\t\t}\n\n\t\t\tif (this.popup || !this.editor || this.editor !== document.activeElement) { // Prevent loops\n\t\t\t\tif (this.config.setValue) {\n\t\t\t\t\tthis.config.setValue.call(this, this.element, value);\n\t\t\t\t}\n\t\t\t\telse if (!o.dataOnly) {\n\t\t\t\t\t_.setValue(this.element, value, {\n\t\t\t\t\t\tconfig: this.config,\n\t\t\t\t\t\tattribute: this.attribute,\n\t\t\t\t\t\tdatatype: this.datatype,\n\t\t\t\t\t\tmap: this.originalEditor || this.editor\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.empty = !value && value !== 0;\n\n\t\t\tthis._value = value;\n\n\t\t\tif (!o.silent) {\n\t\t\t\tif (this.saved) {\n\t\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t\t}\n\n\t\t\t\tthis.dataChanged(\"propertychange\", {value});\n\t\t\t}\n\t\t});\n\n\t\treturn value;\n\t},\n\n\tdataChanged: function(action = \"propertychange\", o) {\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tlive: {\n\t\tdefault: function (value) {\n\t\t\tif (this.value == this._default) {\n\t\t\t\tthis.value = value;\n\t\t\t}\n\t\t},\n\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tdatatype: function (value) {\n\t\t\tif (value !== this._datatype) {\n\t\t\t\tif (value == \"boolean\" && !this.attribute) {\n\t\t\t\t\tthis.attribute = Mavo.Elements.defaultConfig.boolean.attribute;\n\t\t\t\t}\n\n\t\t\t\t$.toggleAttribute(this.element, \"datatype\", value, value && value !== \"string\");\n\t\t\t}\n\t\t},\n\n\t\tempty: function (value) {\n\t\t\tvar hide = value && // is empty\n\t\t\t           !this.modes && // and supports both modes\n\t\t\t           !(this.attribute && $(Mavo.selectors.property, this.element)); // and has no property inside\n\n\t\t\tthis.element.classList.toggle(\"mv-empty\", !!hide);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetValueAttribute: function (element, config = Mavo.Elements.search(element)) {\n\t\t\tvar ret = element.getAttribute(\"mv-attribute\") || config.attribute;\n\n\t\t\tif (!ret || ret === \"null\" || ret === \"none\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, {config, attribute, datatype} = {}) {\n\t\t\tif (!config) {\n\t\t\t\tconfig = _.getConfig(element, attribute);\n\t\t\t}\n\n\t\t\tattribute = config.attribute;\n\t\t\tdatatype = config.datatype;\n\n\t\t\tif (config.getValue && attribute == config.attribute) {\n\t\t\t\treturn config.getValue(element);\n\t\t\t}\n\n\t\t\tvar ret;\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tgetConfig: function(element, attribute, datatype) {\n\t\t\tif (attribute === undefined) {\n\t\t\t\tattribute = element.getAttribute(\"mv-attribute\") || undefined;\n\t\t\t}\n\n\t\t\tif (attribute == \"null\" || attribute == \"none\") {\n\t\t\t\tattribute = null;\n\t\t\t}\n\n\t\t\tif (!datatype && attribute == _.getValueAttribute(element)) {\n\t\t\t\tdatatype = element.getAttribute(\"datatype\") || undefined;\n\t\t\t}\n\n\t\t\tvar config = Mavo.Elements.search(element, attribute, datatype);\n\n\t\t\tif (config.attribute === undefined) {\n\t\t\t\tconfig.attribute = attribute || null;\n\t\t\t}\n\n\t\t\tif (config.datatype === undefined) {\n\t\t\t\tconfig.datatype = datatype;\n\t\t\t}\n\n\t\t\treturn config;\n\t\t},\n\n\t\tsetValue: function (element, value, o = {}) {\n\t\t\tif (element.nodeType === 1) {\n\t\t\t\tif (!o.config) {\n\t\t\t\t\to.config = _.getConfig(element, o.attribute);\n\t\t\t\t}\n\n\t\t\t\to.attribute = o.attribute !== undefined? o.attribute : o.config.attribute;\n\t\t\t\to.datatype = o.datatype !== undefined? o.datatype : o.config.datatype;\n\n\t\t\t\tif (o.config.setValue && o.attribute == o.config.attribute) {\n\t\t\t\t\treturn o.config.setValue(element, value, o.attribute);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (o.attribute) {\n\t\t\t\tif (o.attribute in element && _.useProperty(element, o.attribute) && element[o.attribute] !== value) {\n\t\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvar previousValue = element[o.attribute];\n\t\t\t\t\t\tvar newValue = element[o.attribute] = value;\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {}\n\n\t\t\t\t\tif (previousValue != newValue && o.config.changeEvents) {\n\t\t\t\t\t\to.config.changeEvents.split(/\\s+/).forEach(type => $.fire(element, type));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\t\tif (o.datatype == \"boolean\") {\n\t\t\t\t\tif (value != element.hasAttribute(o.attribute)) {\n\t\t\t\t\t\t$.toggleAttribute(element, o.attribute, value, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (element.getAttribute(o.attribute) != value) {  // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(o.attribute, value);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar presentational = _.format(value, o);\n\n\t\t\t\tif (presentational !== value) {\n\t\t\t\t\telement.textContent = presentational;\n\n\t\t\t\t\tif (element.setAttribute) {\n\t\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\telement.textContent = value;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tformat: (value, o = {}) => {\n\t\t\tif (o.map && /^select$/i.test(o.map.nodeName)) {\n\t\t\t\tfor (var i=0, option; option = o.map.options[i]; i++) {\n\t\t\t\t\tif (option.value == value) {\n\t\t\t\t\t\treturn option.textContent;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (($.type(value) === \"number\" || o.datatype == \"number\")) {\n\t\t\t\tvar skipNumberFormatting = o.attribute || o.element && o.element.matches(\"style, pre\");\n\n\t\t\t\tif (!skipNumberFormatting) {\n\t\t\t\t\treturn _.formatNumber(value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (Array.isArray(value)) {\n\t\t\t\treturn value.map(_.format).join(\", \");\n\t\t\t}\n\n\t\t\tif ($.type(value) === \"object\") {\n\t\t\t\t// Oops, we have an object. Print something more useful than [object Object]\n\t\t\t\treturn Mavo.toJSON(value);\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(Mavo.locale, {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-\" : \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.UI.Popup = $.Class({\n\tconstructor: function(primitive) {\n\t\tthis.primitive = primitive;\n\n\t\t// Need to be defined here so that this is what expected\n\t\tthis.position = evt => {\n\t\t\tvar bounds = this.primitive.element.getBoundingClientRect();\n\t\t\tvar x = bounds.left;\n\t\t\tvar y = bounds.bottom;\n\t\t\tvar pointDown = false;\n\n\t\t\tif (this.element.offsetHeight) {\n\t\t\t\t// Is in the DOM, check if it fits\n\t\t\t\tthis.height = this.element.getBoundingClientRect().height || this.height;\n\t\t\t}\n\n\t\t\tif (this.height + y + 20 > innerHeight) {\n\t\t\t\t// Normal positioning means the popup would be cut off or too close to the edge, adjust\n\n\t\t\t\t// Perhaps placing it above is better\n\t\t\t\tif (bounds.top - this.height > 20) {\n\t\t\t\t\tvar pointDown = true;\n\t\t\t\t\ty = bounds.top - this.height - 20;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Nah, just raise it a bit\n\t\t\t\t\ty = innerHeight - this.height - 20;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.element.classList.toggle(\"mv-point-down\", pointDown);\n\n\t\t\t$.style(this.element, { top:  `${y}px`, left: `${x}px` });\n\t\t};\n\n\t\tthis.element = $.create(\"div\", {\n\t\t\tclassName: \"mv-popup\",\n\t\t\thidden: true,\n\t\t\tcontents: {\n\t\t\t\ttag: \"fieldset\",\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"legend\",\n\t\t\t\t\t\ttextContent: this.primitive.label + \":\"\n\t\t\t\t\t},\n\t\t\t\t\tthis.editor\n\t\t\t\t]\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\tkeyup: evt => {\n\t\t\t\t\tif (evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\t\tif (this.element.contains(document.activeElement)) {\n\t\t\t\t\t\t\tthis.primitive.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\tthis.hide();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\ttransitionend: this.position\n\t\t\t}\n\t\t});\n\n\t\t// No point in having a dropdown in a popup\n\t\tif (this.editor.matches(\"select\")) {\n\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t}\n\t},\n\n\tshow: function() {\n\t\t$.unbind([this.primitive.element, this.element], \".mavo:showpopup\");\n\n\t\tthis.shown = true;\n\n\t\tthis.hideCallback = evt => {\n\t\t\tif (!this.element.contains(evt.target) && !this.primitive.element.contains(evt.target)) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t};\n\n\t\tthis.element.style.transition = \"none\";\n\t\tthis.element.removeAttribute(\"hidden\");\n\n\t\tthis.position();\n\n\t\tthis.element.setAttribute(\"hidden\", \"\");\n\t\tthis.element.style.transition = \"\";\n\n\t\tdocument.body.appendChild(this.element);\n\n\t\tsetTimeout(() => {\n\t\t\tthis.element.removeAttribute(\"hidden\");\n\t\t}, 100); // trigger transition. rAF or timeouts < 100 don't seem to, oddly.\n\n\t\t$.bind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.addEventListener(\"scroll\", this.position, {passive: true});\n\t},\n\n\thide: function() {\n\t\t$.unbind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.removeEventListener(\"scroll\", this.position, {passive: true});\n\t\tthis.element.setAttribute(\"hidden\", \"\"); // trigger transition\n\t\tthis.shown = false;\n\n\t\tsetTimeout(() => {\n\t\t\t$.remove(this.element);\n\t\t}, parseFloat(getComputedStyle(this.element).transitionDuration) * 1000 || 400); // TODO transition-duration could override this\n\t},\n\n\tprepare: function() {\n\t\t$.bind(this.primitive.element, {\n\t\t\t\"click.mavo:edit\": evt => {\n\t\t\t\tthis.show();\n\t\t\t},\n\t\t\t\"keyup.mavo:edit\": evt => {\n\t\t\t\tif ([13, 113].indexOf(evt.keyCode) > -1) { // Enter or F2\n\t\t\t\t\tthis.show();\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclose: function() {\n\t\tthis.hide();\n\t\t$.unbind(this.primitive.element, \".mavo:edit .mavo:preedit .mavo:showpopup\");\n\t},\n\n\tproxy: {\n\t\t\"editor\": \"primitive\"\n\t}\n});\n\n})(Bliss, Bliss.$);\n","/**\n * Configuration for different types of elements. Options:\n * - attribute {String}\n * - useProperty {Boolean}\n * - datatype {\"number\"|\"boolean\"|\"string\"} Default is \"string\"\n * - modes\n * - editor {Object|Function}\n * - setEditorValue temporary\n * - edit\n * - done\n * - observe\n * - default: If there is no attribute, can we use that rule to pick one?\n * @\n */\n(function($, $$) {\n\nvar _ = Mavo.Elements = {};\n\nObject.defineProperties(_, {\n\t\"register\": {\n\t\tvalue: function(id, config) {\n\t\t\tif (typeof arguments[0] === \"object\") {\n\t\t\t\t// Multiple definitions\n\t\t\t\tfor (let s in arguments[0]) {\n\t\t\t\t\t_.register(s, arguments[0][s]);\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (config.extend) {\n\t\t\t\tvar base = _[config.extend];\n\n\t\t\t\tconfig = $.extend($.extend({}, base), config);\n\t\t\t}\n\n\t\t\tif (id.indexOf(\"@\") > -1) {\n\t\t\t\tvar parts = id.split(\"@\");\n\n\t\t\t\tconfig.selector = config.selector || parts[0] || \"*\";\n\n\t\t\t\tif (config.attribute === undefined) {\n\t\t\t\t\tconfig.attribute = parts[1];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconfig.selector = config.selector || id;\n\t\t\tconfig.id = id;\n\n\t\t\tif (Array.isArray(config.attribute)) {\n\t\t\t\tconfig.attribute.forEach(attribute => {\n\t\t\t\t\tvar o = $.extend({}, config);\n\t\t\t\t\to.attribute = attribute;\n\n\t\t\t\t\t_[`${id}@${attribute}`] = o;\n\t\t\t\t});\n\t\t\t}\n\t\t\telse {\n\t\t\t\t_[id] = config;\n\t\t\t}\n\n\t\t\treturn _;\n\t\t}\n\t},\n\t\"search\": {\n\t\tvalue: function(element, attribute, datatype) {\n\t\t\tvar matches = _.matches(element, attribute, datatype);\n\n\t\t\tvar lastMatch = matches[matches.length - 1];\n\n\t\t\tif (lastMatch) {\n\t\t\t\treturn lastMatch;\n\t\t\t}\n\n\t\t\tvar config = $.extend({}, _.defaultConfig[datatype || \"string\"]);\n\t\t\tconfig.attribute = attribute === undefined? config.attribute : attribute;\n\n\t\t\treturn config;\n\t\t}\n\t},\n\t\"matches\": {\n\t\tvalue: function(element, attribute, datatype) {\n\t\t\tvar matches = [];\n\n\t\t\tselectorloop: for (var id in _) {\n\t\t\t\tvar o = _[id];\n\n\t\t\t\t// Passes attribute test?\n\t\t\t\tvar attributeMatches = attribute === undefined && o.default || attribute === o.attribute;\n\n\t\t\t\tif (!attributeMatches) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Passes datatype test?\n\t\t\t\tif (datatype !== undefined && datatype !== \"string\" && datatype !== o.datatype) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Passes selector test?\n\t\t\t\tvar selector = o.selector || id;\n\n\t\t\t\tif (!element.matches(selector)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Passes arbitrary test?\n\t\t\t\tif (o.test && !o.test(element, attribute, datatype)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// All tests have passed\n\t\t\t\tmatches.push(o);\n\t\t\t}\n\n\t\t\treturn matches;\n\t\t}\n\t},\n\n\tisSVG: {\n\t\tvalue: e => e.namespaceURI == \"http://www.w3.org/2000/svg\"\n\t},\n\n\tdefaultConfig: {\n\t\tvalue: {\n\t\t\t\"string\":  {\n\t\t\t\teditor: { tag: \"input\" }\n\t\t\t},\n\t\t\t\"number\":  {\n\t\t\t\teditor: { tag: \"input\", type: \"number\" }\n\t\t\t},\n\t\t\t\"boolean\": {\n\t\t\t\tattribute: \"content\",\n\t\t\t\teditor: { tag: \"input\", type: \"checkbox\" }\n\t\t\t}\n\t\t}\n\t}\n});\n\n_.register({\n\t\"@hidden\": {\n\t\tdatatype: \"boolean\"\n\t},\n\n\t\"@y\": {\n\t\ttest: _.isSVG,\n\t\tdatatype: \"number\"\n\t},\n\n\t\"@x\": {\n\t\tdefault: true,\n\t\ttest: _.isSVG,\n\t\tdatatype: \"number\"\n\t},\n\n\t\"media\": {\n\t\tdefault: true,\n\t\tselector: \"img, video, audio\",\n\t\tattribute: \"src\",\n\t\teditor: function() {\n\t\t\tvar mainInput = $.create(\"input\", {\n\t\t\t\t\"type\": \"url\",\n\t\t\t\t\"placeholder\": \"http://example.com/image.png\",\n\t\t\t\t\"className\": \"mv-output\",\n\t\t\t\t\"aria-label\": \"URL to image\"\n\t\t\t});\n\n\t\t\tif (this.mavo.uploadBackend && self.FileReader) {\n\t\t\t\tvar popup;\n\t\t\t\tvar type = this.element.nodeName.toLowerCase();\n\t\t\t\ttype = type == \"img\"? \"image\" : type;\n\t\t\t\tvar path = this.element.getAttribute(\"mv-uploads\") || type + \"s\";\n\n\t\t\t\tvar upload = (file, name = file.name) => {\n\t\t\t\t\tif (!file || file.type.indexOf(type + \"/\") !== 0) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tempURL = URL.createObjectURL(file);\n\n\t\t\t\t\tthis.sneak(() => this.element.src = tempURL);\n\n\t\t\t\t\tthis.mavo.upload(file, path + \"/\" + name).then(url => {\n\t\t\t\t\t\t// Backend claims image is uploaded, we should load it from remote to make sure everything went well\n\t\t\t\t\t\tvar attempts = 0;\n\t\t\t\t\t\tvar load = Mavo.rr(() => Mavo.timeout(1000 + attempts * 500).then(() => {\n\t\t\t\t\t\t\tattempts++;\n\t\t\t\t\t\t\tthis.element.src = url;\n\t\t\t\t\t\t}));\n\t\t\t\t\t\tvar cleanup = () => {\n\t\t\t\t\t\t\tURL.revokeObjectURL(tempURL);\n\t\t\t\t\t\t\tthis.element.removeEventListener(\"load\", onload);\n\t\t\t\t\t\t\tthis.element.removeEventListener(\"error\", onload);\n\t\t\t\t\t\t};\n\t\t\t\t\t\tvar onload = evt => {\n\t\t\t\t\t\t\tif (this.element.src != tempURL) {\n\t\t\t\t\t\t\t\t// Actual uploaded image has loaded, yay!\n\t\t\t\t\t\t\t\tthis.element.src = url;\n\t\t\t\t\t\t\t\tcleanup();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t\tvar onerror = evt => {\n\t\t\t\t\t\t\t// Oops, failed. Put back temp URL and try again\n\t\t\t\t\t\t\tif (attempts <= 10) {\n\t\t\t\t\t\t\t\tthis.sneak(() => this.element.src = tempURL);\n\t\t\t\t\t\t\t\tload();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t// 11 + 0.5*10*11/2 = 38.5 seconds later, giving up\n\t\t\t\t\t\t\t\tthis.mavo.error(this.mavo._(\"cannot-load-uploaded-file\") + \" \" + url);\n\t\t\t\t\t\t\t\tcleanup();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tmainInput.value = url;\n\t\t\t\t\t\tthis.element.addEventListener(\"load\", onload);\n\t\t\t\t\t\tthis.element.addEventListener(\"error\", onerror);\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\tvar uploadEvents = {\n\t\t\t\t\t\"paste\": evt => {\n\t\t\t\t\t\tvar item = evt.clipboardData.items[0];\n\n\t\t\t\t\t\tif (item.kind == \"file\" && item.type.indexOf(type + \"/\") === 0) {\n\t\t\t\t\t\t\t// Is a file of the correct type, upload!\n\t\t\t\t\t\t\tvar defaultName = `pasted-${type}-${Date.now()}.${item.type.slice(6)}`; // image, video, audio are all 5 chars\n\t\t\t\t\t\t\tvar name = prompt(this.mavo._(\"filename\"), defaultName);\n\n\t\t\t\t\t\t\tif (name === \"\") {\n\t\t\t\t\t\t\t\tname = defaultName;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (name !== null) {\n\t\t\t\t\t\t\t\tupload(item.getAsFile(), name);\n\t\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t\"drag dragstart dragend dragover dragenter dragleave drop\": evt => {\n\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t},\n\t\t\t\t\t\"dragover dragenter\": evt => {\n\t\t\t\t\t\tpopup.classList.add(\"mv-dragover\");\n\t\t\t\t\t\tthis.element.classList.add(\"mv-dragover\");\n\t\t\t\t\t},\n\t\t\t\t\t\"dragleave dragend drop\": evt => {\n\t\t\t\t\t\tpopup.classList.remove(\"mv-dragover\");\n\t\t\t\t\t\tthis.element.classList.remove(\"mv-dragover\");\n\t\t\t\t\t},\n\t\t\t\t\t\"drop\": evt => {\n\t\t\t\t\t\tupload(evt.dataTransfer.files[0]);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\t$.bind(this.element, uploadEvents);\n\n\t\t\t\treturn popup = $.create({\n\t\t\t\t\tclassName: \"mv-upload-popup\",\n\t\t\t\t\tcontents: [\n\t\t\t\t\t\tmainInput, {\n\t\t\t\t\t\t\ttag: \"input\",\n\t\t\t\t\t\t\ttype: \"file\",\n\t\t\t\t\t\t\t\"aria-label\": \"Upload image\",\n\t\t\t\t\t\t\taccept: type + \"/*\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tchange: evt => {\n\t\t\t\t\t\t\t\t\tvar file = evt.target.files[0];\n\n\t\t\t\t\t\t\t\t\tif (!file) {\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tupload(file);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\tclassName: \"mv-tip\",\n\t\t\t\t\t\t\tinnerHTML: \"<strong>Tip:</strong> You can also drag & drop or paste!\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\tevents: uploadEvents\n\t\t\t\t});\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn mainInput;\n\t\t\t}\n\t\t}\n\t},\n\n\t\"video, audio\": {\n\t\tattribute: [\"autoplay\", \"buffered\", \"loop\"],\n\t\tdatatype: \"boolean\"\n\t},\n\n\t\"details\": {\n\t\tattribute: \"open\",\n\t\tdatatype: \"boolean\"\n\t},\n\n\t\"a, link\": {\n\t\tdefault: true,\n\t\tattribute: \"href\"\n\t},\n\n\t\"input, select, button, textarea\": {\n\t\tattribute: \"disabled\",\n\t\tdatatype: \"boolean\"\n\t},\n\n\t\"formControl\": {\n\t\tselector: \"input\",\n\t\tdefault: true,\n\t\tattribute: \"value\",\n\t\tmodes: \"edit\",\n\t\tchangeEvents: \"input change\",\n\t\tedit: () => {},\n\t\tdone: () => {},\n\t\tinit: function() {\n\t\t\tthis.editor = this.element;\n\t\t}\n\t},\n\n\t\"select\": {\n\t\textend: \"formControl\",\n\t\tselector: \"select\",\n\t\tsubtree: true\n\t},\n\n\t\"textarea\": {\n\t\textend: \"formControl\",\n\t\tselector: \"textarea\",\n\t\tattribute: null,\n\t\tgetValue: element => element.value,\n\t\tsetValue: (element, value) => element.value = value\n\t},\n\n\t\"formNumber\": {\n\t\textend: \"formControl\",\n\t\tselector: \"input[type=range], input[type=number]\",\n\t\tdatatype: \"number\",\n\t\tsetValue: function(element, value) {\n\t\t\telement.value = value;\n\t\t\telement.setAttribute(\"value\", value);\n\n\t\t\tvar attribute = value > element.value? \"max\" : \"min\";\n\n\t\t\tif (!isNaN(value) && element.value != value && !Mavo.data(element, \"boundObserver\")) {\n\t\t\t\t// Value out of bounds, maybe race condition? See #295\n\t\t\t\t// Observe min/max attrs until user interaction or data change\n\t\t\t\tvar observer = new Mavo.Observer(element, attribute, r => {\n\t\t\t\t\telement.value = value;\n\t\t\t\t});\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t$.bind(element, \"input mv-change\", function handler() {\n\t\t\t\t\t\tobserver.destroy();\n\t\t\t\t\t\tMavo.data(element, \"boundObserver\", undefined);\n\t\t\t\t\t\t$.unbind(element, \"input mv-change\", handler);\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t\t// Prevent creating same observer twice\n\t\t\t\tMavo.data(element, \"boundObserver\", observer);\n\t\t\t}\n\t\t}\n\t},\n\n\t\"checkbox\": {\n\t\textend: \"formControl\",\n\t\tselector: \"input[type=checkbox]\",\n\t\tattribute: \"checked\",\n\t\tdatatype: \"boolean\",\n\t\tchangeEvents: \"click\"\n\t},\n\n\t\"radio\": {\n\t\textend: \"formControl\",\n\t\tselector: \"input[type=radio]\",\n\t\tattribute: \"checked\",\n\t\tmodes: \"edit\",\n\t\tgetValue: element => {\n\t\t\tif (element.form) {\n\t\t\t\treturn element.form[element.name].value;\n\t\t\t}\n\n\t\t\tvar checked = $(`input[type=radio][name=\"${element.name}\"]:checked`);\n\t\t\treturn checked && checked.value;\n\t\t},\n\t\tsetValue: (element, value) => {\n\t\t\tif (element.form) {\n\t\t\t\telement.form[element.name].value = value;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar toCheck = $(`input[type=radio][name=\"${element.name}\"][value=\"${value}\"]`);\n\t\t\t$.properties(toCheck, {checked: true});\n\t\t},\n\t\tinit: function(element) {\n\t\t\tthis.mavo.element.addEventListener(\"change\", evt => {\n\t\t\t\tif (evt.target.name == element.name) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t\"counter\": {\n\t\textend: \"formControl\",\n\t\tselector: \"button, .counter\",\n\t\tattribute: \"mv-clicked\",\n\t\tdatatype: \"number\",\n\t\tinit: function(element) {\n\t\t\tif (this.attribute === \"mv-clicked\") {\n\t\t\t\telement.setAttribute(\"mv-clicked\", \"0\");\n\n\t\t\t\telement.addEventListener(\"click\", evt => {\n\t\t\t\t\tlet clicked = +element.getAttribute(\"mv-clicked\") || 0;\n\t\t\t\t\tthis.value = ++clicked;\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\t\"meter, progress\": {\n\t\tdefault: true,\n\t\tattribute: \"value\",\n\t\tdatatype: \"number\",\n\t\tedit: function() {\n\t\t\tvar min = +this.element.getAttribute(\"min\") || 0;\n\t\t\tvar max = +this.element.getAttribute(\"max\") || 1;\n\t\t\tvar range = max - min;\n\t\t\tvar step = +this.element.getAttribute(\"mv-edit-step\") || (range > 1? 1 : range/100);\n\n\t\t\t$.bind(this.element, \"mousemove.mavo:edit\", evt => {\n\t\t\t\t// Change property as mouse moves\n\t\t\t\tvar left = this.element.getBoundingClientRect().left;\n\t\t\t\tvar offset = Math.max(0, (evt.clientX - left) / this.element.offsetWidth);\n\t\t\t\tvar newValue = min + range * offset;\n\t\t\t\tvar mod = newValue % step;\n\n\t\t\t\tnewValue += mod > step/2? step - mod : -mod;\n\t\t\t\tnewValue = Math.max(min, Math.min(newValue, max));\n\n\t\t\t\tthis.sneak(() => this.element.setAttribute(\"value\", newValue));\n\t\t\t});\n\n\t\t\t$.bind(this.element, \"mouseleave.mavo:edit\", evt => {\n\t\t\t\t// Return to actual value\n\t\t\t\tthis.sneak(() => this.element.setAttribute(\"value\", this.value));\n\t\t\t});\n\n\t\t\t$.bind(this.element, \"click.mavo:edit\", evt => {\n\t\t\t\t// Register change\n\t\t\t\tthis.value = this.getValue();\n\t\t\t});\n\n\t\t\t$.bind(this.element, \"keydown.mavo:edit\", evt => {\n\t\t\t\t// Edit with arrow keys\n\t\t\t\tif (evt.target == this.element && (evt.keyCode == 37 || evt.keyCode == 39)) {\n\t\t\t\t\tvar increment = step * (evt.keyCode == 39? 1 : -1) * (evt.shiftKey? 10 : 1);\n\t\t\t\t\tvar newValue = this.value + increment;\n\t\t\t\t\tnewValue = Math.max(min, Math.min(newValue, max));\n\n\t\t\t\t\tthis.element.setAttribute(\"value\", newValue);\n\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tdone: function() {\n\t\t\t$.unbind(this.element, \".mavo:edit\");\n\t\t}\n\t},\n\n\t\"meta\": {\n\t\tdefault: true,\n\t\tattribute: \"content\"\n\t},\n\n\t\"block\": {\n\t\tdefault: true,\n\t\tselector: \"p, div, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address\",\n\t\teditor: function() {\n\t\t\tvar cs = getComputedStyle(this.element);\n\t\t\tvar display = cs.display;\n\t\t\tvar tag = display.indexOf(\"inline\") === 0? \"input\" : \"textarea\";\n\t\t\tvar editor = $.create(tag);\n\n\t\t\tif (tag == \"textarea\") {\n\t\t\t\t// Actually multiline\n\t\t\t\tvar width = this.element.offsetWidth;\n\n\t\t\t\tif (width) {\n\t\t\t\t\teditor.width = width;\n\t\t\t\t}\n\n\t\t\t\t// We cannot collapse whitespace because then users\n\t\t\t\t// are adding characters they dont see (#300).\n\t\t\t\teditor.style.whiteSpace = ({\n\t\t\t\t\t\"normal\": \"pre-wrap\",\n\t\t\t\t\t\"nowrap\": \"pre\"\n\t\t\t\t})[cs.whiteSpace] || \"inherit\";\n\t\t\t}\n\n\t\t\treturn editor;\n\t\t},\n\n\t\tsetEditorValue: function(value) {\n\t\t\tif (this.datatype && this.datatype != \"string\") {\n\t\t\t\tvalue = value + \"\";\n\t\t\t}\n\n\t\t\tvar cs = getComputedStyle(this.element);\n\t\t\tvalue = value || \"\";\n\n\t\t\tif ([\"normal\", \"nowrap\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse lines\n\t\t\t\tvalue = value.replace(/\\r?\\n/g, \" \");\n\t\t\t}\n\n\t\t\tif ([\"normal\", \"nowrap\", \"pre-line\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse whitespace\n\t\t\t\tvalue = value.replace(/^[ \\t]+|[ \\t]+$/gm, \"\").replace(/[ \\t]+/g, \" \");\n\t\t\t}\n\n\t\t\tthis.editor.value = value;\n\t\t\treturn true;\n\t\t}\n\t},\n\n\t\"time\": {\n\t\tattribute: \"datetime\",\n\t\tdefault: true,\n\t\tinit: function() {\n\t\t\tif (!this.fromTemplate(\"dateType\")) {\n\t\t\t\tvar dateFormat = Mavo.DOMExpression.search(this.element, null);\n\t\t\t\tvar datetime = this.element.getAttribute(\"datetime\") || \"YYYY-MM-DD\";\n\n\t\t\t\tfor (var type in this.config.dateTypes) {\n\t\t\t\t\tif (this.config.dateTypes[type].test(datetime)) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.dateType = type;\n\n\t\t\t\tif (!dateFormat) {\n\t\t\t\t\t// TODO what about mv-expressions?\n\t\t\t\t\tthis.element.textContent = this.config.defaultFormats[this.dateType](this.property);\n\t\t\t\t\tthis.mavo.expressions.extract(this.element, null);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tdateTypes: {\n\t\t\t\"month\": /^[Y\\d]{4}-[M\\d]{2}$/i,\n\t\t\t\"time\": /^[H\\d]{2}:[M\\d]{2}/i,\n\t\t\t\"datetime-local\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2} [H\\d]{2}:[Mi\\d]{2}/i,\n\t\t\t\"date\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2}$/i,\n\t\t},\n\t\tdefaultFormats: {\n\t\t\t\"date\": name => `[day(${name})] [month(${name}).shortname] [year(${name})]`,\n\t\t\t\"month\": name => `[month(${name}).name] [year(${name})]`,\n\t\t\t\"time\": name => `[hour(${name}).twodigit]:[minute(${name}).twodigit]`,\n\t\t\t\"datetime-local\": function(name) {\n\t\t\t\treturn this.date(name) + \" \" + this.time(name);\n\t\t\t}\n\t\t},\n\t\teditor: function() {\n\t\t\treturn {tag: \"input\", type: this.dateType};\n\t\t}\n\t},\n\n\t\"circle@r\": {\n\t\tdefault: true,\n\t\tdatatype: \"number\"\n\t},\n\n\t\"circle\": {\n\t\tattribute: [\"cx\", \"cy\"],\n\t\tdatatype: \"number\"\n\t},\n\n\t\"text\": {\n\t\tdefault: true,\n\t\tpopup: true\n\t},\n\n\t\".mv-toggle\": {\n\t\tdefault: true,\n\t\tattribute: \"aria-checked\",\n\t\tdatatype: \"boolean\",\n\t\tedit: function() {\n\t\t\tMavo.revocably.setAttribute(this.element, \"role\", \"checkbox\");\n\n\t\t\t$.bind(this.element, \"click.mavo:edit keyup.mavo:edit keydown.mavo:edit\", evt => {\n\t\t\t\tif (evt.type == \"click\" || evt.key == \" \" || evt.key == \"Enter\") {\n\t\t\t\t\tif (evt.type != \"keydown\") {\n\t\t\t\t\t\tthis.value = !this.value;\n\t\t\t\t\t}\n\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tdone: function() {\n\t\t\tMavo.revocably.restoreAttribute(this.element, \"role\");\n\n\t\t\t$.unbind(this.element, \".mavo:edit\");\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"mutable\", \"templateElement\", \"accepts\", \"optional\", \"like\", \"likeNode\")) {\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\t\t\tthis.like = this.templateElement.getAttribute(\"mv-like\");\n\n\t\t\tif (this.like) {\n\t\t\t\tthis.likeNode = this.resolve(this.like, {exclude: this});\n\t\t\t\tthis.likeNode = this.likeNode || this.likeNode.template;\n\n\t\t\t\tif (!this.likeNode) {\n\t\t\t\t\tthis.like = null;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.optional = !!this.like || this.templateElement.hasAttribute(\"mv-optional\");\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.likeNode) {\n\t\t\tthis.itemTemplate = this.likeNode;\n\t\t\tvar templateElement = $.value(this.likeNode.collection, \"templateElement\") || this.likeNode.element;\n\t\t\tthis.templateElement = templateElement.cloneNode(true);\n\t\t\tthis.templateElement.setAttribute(\"property\", this.property);\n\t\t\tthis.properties = this.likeNode.properties;\n\t\t}\n\t\telse if (!this.optional || !this.template) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item, undefined, {silent: true});\n\n\t\t\tif (this.optional) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t}\n\n\t\tif (this.optional) {\n\t\t\tthis.element.remove();\n\t\t}\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.liveData\n\t\t};\n\n\t\tif (env.options.live) {\n\t\t\tthis.proxyCache = {};\n\t\t}\n\n\t\tfor (var i = 0, j = 0; item = this.children[i]; i++) {\n\t\t\tif (!item.deleted || env.options.live) {\n\t\t\t\tvar itemData = item.getData(env.options);\n\n\t\t\t\tif (env.options.live || Mavo.value(itemData) !== null) {\n\t\t\t\t\tenv.data[j] = itemData;\n\t\t\t\t\tj++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tenv.data.length = j;\n\n\t\tif (!this.mutable) {\n\t\t\t// If immutable, drop nulls\n\t\t\tMavo.filter(env.data, item => Mavo.value(item) !== null);\n\n\t\t\tif (env.options.live && env.data.length === 1) {\n\t\t\t\t// If immutable with only 1 item, return the item\n\t\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\t\tenv.data = env.data[0];\n\t\t\t}\n\t\t\telse if (this.data && !env.options.live) {\n\t\t\t\tvar rendered = Mavo.subset(this.data, this.inPath);\n\t\t\t\tenv.data = env.data.concat(rendered.slice(env.data.length));\n\t\t\t}\n\t\t}\n\n\t\tif (!env.options.live) {\n\t\t\tenv.data = Mavo.subset(this.data, this.inPath, env.data);\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn (env.options.live? env.data[Mavo.toProxy] : env.data) || env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar template = this.itemTemplate || (this.template? this.template.itemTemplate : null);\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate,\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\tif (!this.itemTemplate) {\n\t\t\tthis.itemTemplate = template || item;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar rel = this.children[index]? this.children[index].element : this.marker;\n\t\t\t$[this.bottomUp? \"after\" : \"before\"](item.element, rel);\n\n\t\t\tif (index === undefined) {\n\t\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.length;\n\t\t}\n\n\t\tvar env = {context: this, item};\n\n\t\tenv.previousIndex = item.index;\n\n\t\t// Update internal data model\n\t\tenv.changed = this.splice({\n\t\t\tremove: env.item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: env.item\n\t\t});\n\n\t\tif (env.item.itembar) {\n\t\t\tenv.item.itembar.reposition();\n\t\t}\n\n\t\tif (this.mavo.expressions.active && !o.silent) {\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tenv.changed.forEach(i => {\n\t\t\t\t\ti.dataChanged(i == env.item && env.previousIndex === undefined? \"add\" : \"move\");\n\t\t\t\t\ti.unsavedChanges = true;\n\t\t\t\t});\n\n\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\n\t\t\t\tthis.mavo.expressions.update(env.item);\n\t\t\t});\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\treturn env.item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tactions.forEach(action => {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t});\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\t// FIXME this could still result in buggy behavior.\n\t\t// Think of e.g. adding items on i, then removing > 1 items on i-1.\n\t\t// The new items would get removed instead of the old ones.\n\t\t// Not a pressing issue though since we always remove 1 max when adding things too.\n\t\tactions.forEach(action => {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t});\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\titem.destroy();\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\t/**\n\t * Move existing item to a new position. Wraps around if position is out of bounds.\n\t * @offset relative position\n\t */\n\tmove: function(item, offset) {\n\t\tvar index = item.index + offset + (offset > 0);\n\n\t\tindex = Mavo.wrap(index, this.children.length + 1);\n\n\t\tthis.add(item, index);\n\n\t\tif (item instanceof Mavo.Primitive && item.itembar) {\n\t\t\titem.itembar.reposition();\n\t\t}\n\t},\n\n\teditItem: function(item, o = {}) {\n\t\tvar when = o.immediately? Promise.resolve() : Mavo.inView.when(item.element);\n\n\t\treturn when.then(() => {\n\t\t\tif (this.mutable) {\n\t\t\t\tif (!item.itembar) {\n\t\t\t\t\titem.itembar = new Mavo.UI.Itembar(item);\n\t\t\t\t}\n\n\t\t\t\titem.itembar.add();\n\t\t\t}\n\n\t\t\treturn item.edit(o);\n\t\t});\n\t},\n\n\tedit: function(o = {}) {\n\t\tif (this.super.edit.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\t\t\t\tvar rel = containerSelector? this.marker.parentNode.closest(containerSelector) : this.marker;\n\t\t\t\t$[this.bottomUp? \"before\" : \"after\"](this.addButton, rel);\n\t\t\t}\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\n\t\t// Edit items, maybe insert item bar\n\t\treturn Promise.all(this.children.map(item => this.editItem(item, o)));\n\t},\n\n\tdone: function() {\n\t\tif (this.super.done.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.itembar) {\n\t\t\t\t\titem.itembar.remove();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tthis.children.forEach(item => {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t});\n\t},\n\n\tpropagated: [\"save\"],\n\n\tdataRender: function(data) {\n\t\tif (data === undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = data === null? [] : Mavo.toArray(data).filter(i => i !== null);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\t\t}\n\t\telse {\n\t\t\t// First render on existing items\n\t\t\tfor (var i = 0; i < this.children.length; i++) {\n\t\t\t\tvar item = this.children[i];\n\n\t\t\t\tif (i < data.length) {\n\t\t\t\t\titem.render(data[i]);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\titem.dataChanged(\"delete\");\n\t\t\t\t\tthis.delete(item, true);\n\t\t\t\t\ti--;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (data.length > i) {\n\t\t\t\t// There are still remaining items\n\t\t\t\t// Using document fragments improves performance by 60%\n\t\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\t\tfor (var j = i; j < data.length; j++) {\n\t\t\t\t\tvar item = this.createItem();\n\n\t\t\t\t\titem.render(data[j]);\n\n\t\t\t\t\tthis.children.push(item);\n\t\t\t\t\titem.index = j;\n\n\t\t\t\t\tfragment.appendChild(item.element);\n\n\t\t\t\t\tvar env = {context: this, item};\n\t\t\t\t\tMavo.hooks.run(\"collection-add-end\", env);\n\t\t\t\t}\n\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t$.after(fragment, i > 0? this.children[i-1].element : this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$.before(fragment, this.marker);\n\t\t\t\t}\n\n\t\t\t\tfor (var j = i; j < this.children.length; j++) {\n\t\t\t\t\tthis.children[j].dataChanged(\"add\");\n\n\t\t\t\t\tif (this.mavo.expressions.active) {\n\t\t\t\t\t\trequestAnimationFrame(() => this.mavo.expressions.update(this.children[j]));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.createLiveData(data|| []);\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tif (o.exclude === this) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar items = this.children.filter(item => !item.deleted && !item.hidden);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.has(property)) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\n\t\t\t\tvar ref = this.templateElement.parentNode? this.templateElement : this.children[this.length - 1].element;\n\n\t\t\t\t$.after(this.marker, ref);\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.multiple) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.marker) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.multiple);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button)  // is outside the template element\n\t\t\t\t\t\t&& !Mavo.data(button, \"collection\"); // and does not belong to another collection\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: this.mavo._(\"add-item\", this)\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.editItem(this.add());\n\t\t\t});\n\n\t\t\treturn button;\n\t\t},\n\n\t\tliveData: function() {\n\t\t\treturn this.createLiveData([]);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.UI.Itembar = $.Class({\n\tconstructor: function(item) {\n\t\tthis.item = item;\n\n\t\tthis.element = $$(`.mv-item-bar:not([mv-rel]), .mv-item-bar[mv-rel=\"${this.item.property}\"]`, this.item.element).filter(el => {\n\t\t\t\t// Remove item controls meant for other collections\n\t\t\t\treturn el.closest(Mavo.selectors.multiple) == this.item.element && !Mavo.data(el, \"item\");\n\t\t\t})[0];\n\n\t\tif (!this.element && this.item.template && this.item.template.itembar) {\n\t\t\t// We can clone the buttons from the template\n\t\t\tthis.element = this.item.template.itembar.element.cloneNode(true);\n\t\t\tthis.dragHandle = $(\".mv-drag-handle\", this.element) || this.item.element;\n\t\t}\n\t\telse {\n\t\t\t// First item of this type\n\t\t\tthis.element = this.element || $.create({\n\t\t\t\tclassName: \"mv-item-bar mv-ui\"\n\t\t\t});\n\n\t\t\tvar buttons = [\n\t\t\t\t{\n\t\t\t\t\ttag: \"button\",\n\t\t\t\t\ttitle: this.mavo._(\"delete-item\", this.item),\n\t\t\t\t\tclassName: \"mv-delete\"\n\t\t\t\t}, {\n\t\t\t\t\ttag: \"button\",\n\t\t\t\t\ttitle: this.mavo._(`add-item-${this.collection.bottomUp? \"after\" : \"before\"}`, this.item),\n\t\t\t\t\tclassName: \"mv-add\"\n\t\t\t\t}\n\t\t\t];\n\n\t\t\tif (this.item instanceof Mavo.Group) {\n\t\t\t\tthis.dragHandle = $.create({\n\t\t\t\t\ttag: \"button\",\n\t\t\t\t\ttitle: this.mavo._(\"drag-to-reorder\", this.item),\n\t\t\t\t\tclassName: \"mv-drag-handle\"\n\t\t\t\t});\n\n\t\t\t\tbuttons.push(this.dragHandle);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.dragHandle = this.item.element;\n\t\t\t}\n\n\t\t\t$.set(this.element, {\n\t\t\t\t\"mv-rel\": this.item.property,\n\t\t\t\tcontents: buttons\n\t\t\t});\n\t\t}\n\n\t\tthis.element.setAttribute(\"hidden\", \"\");\n\n\t\t$.bind([this.item.element, this.element], \"focusin mouseover\", this);\n\n\t\t$.bind(this.element, {\n\t\t\tmouseenter: evt => {\n\t\t\t\tthis.item.element.classList.add(\"mv-highlight\");\n\t\t\t},\n\t\t\tmouseleave: evt => {\n\t\t\t\tthis.item.element.classList.remove(\"mv-highlight\");\n\t\t\t}\n\t\t});\n\n\t\tthis.dragHandle.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.target === this.dragHandle && this.item.editing && evt.keyCode >= 37 && evt.keyCode <= 40) {\n\t\t\t\t// Arrow keys\n\t\t\t\tthis.collection.move(this.item, evt.keyCode <= 38? -1 : 1);\n\n\t\t\t\tevt.stopPropagation();\n\t\t\t\tevt.preventDefault();\n\t\t\t\tevt.target.focus();\n\t\t\t}\n\t\t});\n\n\t\tvar selectors = {\n\t\t\tadd: this.buttonSelector(\"add\"),\n\t\t\tdelete: this.buttonSelector(\"delete\"),\n\t\t\tdrag: this.buttonSelector(\"drag\")\n\t\t};\n\n\t\tthis.element.addEventListener(\"click\", evt => {\n\t\t\tif (this.item.collection.editing) {\n\t\t\t\tif (evt.target.matches(selectors.add)) {\n\t\t\t\t\tvar newItem = this.collection.add(null, this.item.index);\n\n\t\t\t\t\tif (evt[Mavo.superKey]) {\n\t\t\t\t\t\tnewItem.render(this.item.getData());\n\t\t\t\t\t}\n\n\t\t\t\t\tMavo.scrollIntoViewIfNeeded(newItem.element);\n\n\t\t\t\t\treturn this.collection.editItem(newItem);\n\t\t\t\t}\n\t\t\t\telse if (evt.target.matches(selectors.delete)) {\n\t\t\t\t\tthis.item.collection.delete(item);\n\t\t\t\t}\n\t\t\t\telse if (evt.target.matches(selectors[\"drag-handle\"])) {\n\t\t\t\t\tevt => evt.target.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tMavo.data(this.element, \"item\", this.item);\n\t},\n\n\tdestroy: function() {\n\t\tthis.hide();\n\t},\n\n\tshow: function(sticky) {\n\t\t_.visible.forEach(instance => {\n\t\t\tif (instance != this && (!this.sticky || instance.sticky)) {\n\t\t\t\tclearTimeout(instance.hideTimeout);\n\t\t\t\tinstance.hide(sticky, _.DELAY);\n\t\t\t}\n\t\t});\n\n\t\t_.visible.add(this);\n\n\t\tif (this.element.hasAttribute(\"hidden\") || sticky && !this.sticky) {\n\t\t\tthis.element.removeAttribute(\"hidden\");\n\t\t\tthis.sticky = this.sticky || sticky;\n\t\t\t$.bind([this.item.element, this.element], \"focusout mouseleave\", this);\n\n\t\t\tif (this.adjacent) {\n\t\t\t\t// Position\n\t\t\t\t$.style(this.element, {\n\t\t\t\t\t\"--mv-item-width\": this.item.element.offsetWidth + \"px\",\n\t\t\t\t\t\"--mv-item-height\": this.item.element.offsetHeight + \"px\",\n\t\t\t\t\t\"--mv-item-left\": this.item.element.offsetLeft + \"px\",\n\t\t\t\t\t\"--mv-item-top\": this.item.element.offsetTop + \"px\"\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\thide: function(sticky, timeout = 0) {\n\t\tif (!this.sticky || sticky) {\n\t\t\tif (timeout) {\n\t\t\t\tthis.hideTimeout = setTimeout(() => this.hide(sticky), timeout);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.element.setAttribute(\"hidden\", \"\");\n\t\t\t\t$.unbind([this.item.element, this.element], \"focusout mouseleave\", this);\n\t\t\t\tthis.sticky = false;\n\t\t\t\t_.visible.delete(this);\n\t\t\t}\n\n\t\t}\n\t},\n\n\thandleEvent: function(evt) {\n\t\tvar sticky = evt.type.indexOf(\"mouse\") === -1;\n\n\t\tif (this.isWithinItem(evt.target)) {\n\t\t\tclearTimeout(this.hideTimeout);\n\n\t\t\tif ([\"mouseleave\", \"focusout\", \"blur\"].indexOf(evt.type) > -1) {\n\t\t\t\tif (!this.isWithinItem(evt.relatedTarget)) {\n\t\t\t\t\tthis.hide(sticky, _.DELAY);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.show(sticky);\n\t\t\t\tevt.stopPropagation();\n\t\t\t}\n\t\t}\n\t},\n\n\tisWithinItem: function(element) {\n\t\tif (!element) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvar itemBar = element.closest(\".mv-item-bar\");\n\t\treturn itemBar? itemBar === this.element : element.closest(Mavo.selectors.item) === this.item.element;\n\t},\n\n\tadd: function() {\n\t\tif (!this.element.parentNode) {\n\t\t\tif (!Mavo.revocably.add(this.element)) {\n\t\t\t\tif (this.item instanceof Mavo.Primitive && !this.item.attribute) {\n\t\t\t\t\tthis.adjacent = true;\n\t\t\t\t\t$.after(this.element, this.item.element);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.item.element.appendChild(this.element);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.dragHandle == this.item.element) {\n\t\t\tthis.item.element.classList.add(\"mv-drag-handle\");\n\t\t}\n\t},\n\n\tremove: function() {\n\t\tMavo.revocably.remove(this.element);\n\n\t\tif (this.dragHandle == this.item.element) {\n\t\t\tthis.item.element.classList.remove(\"mv-drag-handle\");\n\t\t}\n\t},\n\n\treposition: function() {\n\t\tif (this.item instanceof Mavo.Primitive) {\n\t\t\t// This is only needed for lists of primitives, because the item element\n\t\t\t// does not contain the minibar. In lists of groups, this can be harmful\n\t\t\t// because it will remove custom positioning\n\t\t\tthis.element.remove();\n\t\t\tthis.add();\n\t\t}\n\t},\n\n\tbuttonSelector: function(type) {\n\t\treturn `.mv-${type}[mv-rel=\"${this.item.property}\"], [mv-rel=\"${this.item.property}\"] > .mv-${type}`;\n\t},\n\n\tlive: {\n\t\tsticky: function(v) {\n\t\t\tthis.element.classList.toggle(\"mv-sticky\", v);\n\t\t},\n\n\t\tadjacent: function(v) {\n\t\t\tthis.element.classList.toggle(\"mv-adjacent\", v);\n\t\t}\n\t},\n\n\tproxy: {\n\t\tcollection: \"item\",\n\t\tmavo: \"item\"\n\t},\n\n\tstatic: {\n\t\tDELAY: 100,\n\t\tvisible: new Set()\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nMavo.attributes.push(\"mv-expressions\");\n\nvar _ = Mavo.Expression = $.Class({\n\tconstructor: function(expression) {\n\t\tthis.expression = expression;\n\t},\n\n\teval: function(data) {\n\t\tMavo.hooks.run(\"expression-eval-beforeeval\", this);\n\n\t\ttry {\n\t\t\tif (!this.function) {\n\t\t\t\tthis.function = Mavo.Script.compile(this.expression);\n\t\t\t}\n\n\t\t\treturn this.function(data);\n\t\t}\n\t\tcatch (exception) {\n\t\t\tconsole.info(\"%cExpression error!\", \"color: red; font-weight: bold\", `${exception.message} in expression ${this.expression}`, `\nNot an expression? Use mv-expressions=\"none\" to disable expressions on an element and its descendants.`);\n\n\t\t\tMavo.hooks.run(\"expression-eval-error\", {context: this, exception});\n\n\t\t\treturn exception;\n\t\t}\n\t},\n\n\ttoString() {\n\t\treturn this.expression;\n\t},\n\n\tchangedBy: function(evt) {\n\t\treturn _.changedBy(this.identifiers, evt);\n\t},\n\n\tlive: {\n\t\texpression: function(value) {\n\t\t\tthis.function = null;\n\t\t\tthis.identifiers = value.match(/[$a-z][$\\w]*/ig) || [];\n\t\t}\n\t},\n\n\tstatic: {\n\t\tchangedBy: function(identifiers, evt) {\n\t\t\tif (!evt) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (!identifiers) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (identifiers.indexOf(evt.property) > -1) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (Mavo.Functions.intersects(evt.properties, identifiers)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (evt.action == \"propertychange\") {\n\t\t\t\treturn Mavo.Functions.intersects(identifiers, evt.node.path);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (Mavo.Functions.intersects([\"$index\", \"$previous\", \"$next\"], identifiers)) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tvar collection = evt.node.collection || evt.node;\n\n\t\t\t\tif (Mavo.Functions.intersects(collection.properties, identifiers)) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t}\n});\n\n_.Syntax = $.Class({\n\tconstructor: function(start, end) {\n\t\tthis.start = start;\n\t\tthis.end = end;\n\t\tthis.regex = RegExp(`${Mavo.escapeRegExp(start)}([\\\\S\\\\s]+?)${Mavo.escapeRegExp(end)}`, \"gi\");\n\t},\n\n\ttest: function(str) {\n\t\tthis.regex.lastIndex = 0;\n\n\t\treturn this.regex.test(str);\n\t},\n\n\ttokenize: function(str) {\n\t\tvar match, ret = [], lastIndex = 0;\n\n\t\tthis.regex.lastIndex = 0;\n\n\t\twhile ((match = this.regex.exec(str)) !== null) {\n\t\t\t// Literal before the expression\n\t\t\tif (match.index > lastIndex) {\n\t\t\t\tret.push(str.substring(lastIndex, match.index));\n\t\t\t}\n\n\t\t\tlastIndex = this.regex.lastIndex;\n\n\t\t\tret.push(new Mavo.Expression(match[1]));\n\t\t}\n\n\t\t// Literal at the end\n\t\tif (lastIndex < str.length) {\n\t\t\tret.push(str.substring(lastIndex));\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tstatic: {\n\t\tcreate: function(element) {\n\t\t\tif (element) {\n\t\t\t\tvar syntax = element.getAttribute(\"mv-expressions\");\n\n\t\t\t\tif (syntax) {\n\t\t\t\t\tsyntax = syntax.trim();\n\t\t\t\t\treturn /\\s/.test(syntax)? new _.Syntax(...syntax.split(/\\s+/)) : _.Syntax.ESCAPE;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tESCAPE: -1\n\t}\n});\n\n_.Syntax.default = new _.Syntax(\"[\", \"]\");\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.DOMExpression = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.mavo = o.mavo;\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"item\", \"path\", \"syntax\", \"fallback\", \"attribute\", \"originalAttribute\", \"expression\", \"parsed\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = Mavo.elementPath(this.item.element, this.path);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"domexpression-init-start\", this);\n\n\t\tif (this.attribute == \"mv-value\") {\n\t\t\tthis.originalAttribute = \"mv-value\";\n\t\t\tthis.attribute = Mavo.Primitive.getValueAttribute(this.element);\n\t\t\tthis.fallback = this.fallback || Mavo.Primitive.getValue(this.element, {attribute: this.attribute});\n\t\t\tvar expression = this.element.getAttribute(\"mv-value\");\n\t\t\tthis.element.removeAttribute(\"mv-value\");\n\t\t\tthis.parsed = [new Mavo.Expression(expression)];\n\t\t\tthis.expression = this.syntax.start + expression + this.syntax.end;\n\t\t}\n\n\t\tif (this.node.nodeType === 3 && this.element === this.node) {\n\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\tthis.node = this.element;\n\t\t\t\tthis.element.normalize();\n\t\t\t}\n\t\t}\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.attribute) {\n\t\t\t\t// Some web components (e.g. AFrame) hijack getAttribute()\n\t\t\t\tvar value = Element.prototype.getAttribute.call(this.node, this.attribute);\n\n\t\t\t\tthis.expression = (value || \"\").trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tthis.oldValue = this.value = this.parsed.map(x => x instanceof Mavo.Expression? x.expression : x);\n\n\t\tthis.item = Mavo.Node.get(this.element.closest(Mavo.selectors.item));\n\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tif (!this.template && !this.item) {\n\t\t\t\t// Only collection items and groups can have their own expressions arrays\n\t\t\t\tthis.item = Mavo.Node.getClosest(this.element);\n\n\t\t\t\tif (this.item.nodeType === \"Primitive\" && !this.item.collection) {\n\t\t\t\t\tthis.item = this.item.parent;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.originalAttribute == \"mv-value\" && this.mavoNode && this.mavoNode == this.item.collection) {\n\t\t\t\tMavo.delete(this.item.expressions, this);\n\t\t\t}\n\n\t\t\tMavo.hooks.run(\"domexpression-init-treebuilt\", this);\n\t\t});\n\n\t\tMavo.hooks.run(\"domexpression-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tdestroy: function() {\n\t\t_.special.delete(this);\n\t},\n\n\tchangedBy: function(evt) {\n\t\tif (this.originalAttribute == \"mv-value\" && this.mavoNode && !(this.mavoNode instanceof Mavo.Primitive)) {\n\t\t\t// Just prevent the same node from triggering changes, everything else is game\n\t\t\treturn !evt || !this.mavoNode.contains(evt.node);\n\t\t}\n\n\t\tif (!this.identifiers) {\n\t\t\tthis.identifiers = Mavo.flatten(this.parsed.map(x => x.identifiers || []));\n\n\t\t\t// Any identifiers that need additional updating?\n\t\t\t_.special.add(this);\n\t\t}\n\n\t\treturn Mavo.Expression.changedBy(this.identifiers, evt);\n\t},\n\n\tupdate: function(data = this.data, event) {\n\t\tvar env = {context: this, event};\n\t\tvar parentEnv = env;\n\n\t\tthis.data = data;\n\n\t\tMavo.hooks.run(\"domexpression-update-start\", env);\n\n\t\tthis.oldValue = this.value;\n\t\tvar changed = false;\n\n\t\tenv.value = this.value = this.parsed.map((expr, i) => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\t\t\t\tif (expr.changedBy(parentEnv.event)) {\n\t\t\t\t\tvar env = {context: this, expr, parentEnv};\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = Mavo.value(env.expr.eval(data));\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-aftereval\", env);\n\n\t\t\t\t\tchanged = true;\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : this.syntax.start + env.expr.expression + this.syntax.end;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Dont print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn this.oldValue[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!changed) {\n\t\t\t// If nothing changed, no need to do anything\n\t\t\treturn;\n\t\t}\n\n\t\tif (env.value.length === 1) {\n\t\t\tenv.value = env.value[0];\n\t\t}\n\t\telse {\n\t\t\tenv.value = env.value.map(v => Mavo.Primitive.format(v, {\n\t\t\t\tattribute: this.attribute,\n\t\t\t\telement: this.element\n\t\t\t})).join(\"\");\n\t\t}\n\n\t\tthis.output(env.value);\n\n\t\tMavo.hooks.run(\"domexpression-update-end\", env);\n\t},\n\n\toutput: function(value) {\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = value;\n\t\t}\n\t\telse if (this.mavoNode) {\n\t\t\tthis.mavoNode.render(value);\n\t\t}\n\t\telse {\n\t\t\tMavo.Primitive.setValue(this.node, value, {attribute: this.attribute});\n\t\t}\n\t},\n\n\tlive: {\n\t\titem: function(item) {\n\t\t\tif (item && this._item != item) {\n\t\t\t\tif (this._item) {\n\t\t\t\t\t// Previous item, delete from its expressions\n\t\t\t\t\tMavo.delete(this._item.expressions, this);\n\t\t\t\t}\n\n\t\t\t\titem.expressions = item.expressions || [];\n\t\t\t\titem.expressions.push(this);\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.DOMExpression object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching DOMExpression objects.\n\t\t *         If two arguments, the matching DOMExpression object or null\n\t\t */\n\t\tsearch: function (element, attribute) {\n\t\t\tif (element === null) {\n\t\t\t\treturn element;\n\t\t\t}\n\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t},\n\n\t\tspecial: {\n\t\t\tadd: function(domexpression, name) {\n\t\t\t\tif (name) {\n\t\t\t\t\tvar o = this.vars[name];\n\n\t\t\t\t\tif (o && domexpression.identifiers.indexOf(name) > -1) {\n\t\t\t\t\t\to.all = o.all || new Set();\n\t\t\t\t\t\to.all.add(domexpression);\n\n\t\t\t\t\t\tif (o.all.size === 1) {\n\t\t\t\t\t\t\to.observe();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (!o.all.size) {\n\t\t\t\t\t\t\to.unobserve();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// All names\n\t\t\t\t\tfor (var name in this.vars) {\n\t\t\t\t\t\tthis.add(domexpression, name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tdelete: function(domexpression, name) {\n\t\t\t\tif (name) {\n\t\t\t\t\tvar o = this.vars[name];\n\n\t\t\t\t\to.all = o.all || new Set();\n\t\t\t\t\to.all.delete(domexpression);\n\n\t\t\t\t\tif (!o.all.size) {\n\t\t\t\t\t\to.unobserve();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// All names\n\t\t\t\t\tfor (var name in this.vars) {\n\t\t\t\t\t\tthis.delete(domexpression, name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tupdate: function() {\n\t\t\t\tif (this.update) {\n\t\t\t\t\tthis.update(...arguments);\n\t\t\t\t}\n\n\t\t\t\tthis.all.forEach(domexpression => domexpression.update());\n\t\t\t},\n\n\t\t\tevent: function(name, {type, update, target = document} = {}) {\n\t\t\t\tthis.vars[name] = {\n\t\t\t\t\tobserve: function() {\n\t\t\t\t\t\tthis.callback = this.callback || _.special.update.bind(this);\n\t\t\t\t\t\ttarget.addEventListener(type, this.callback);\n\t\t\t\t\t},\n\t\t\t\t\tunobserve: function() {\n\t\t\t\t\t\ttarget.removeEventListener(type, this.callback);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tif (update) {\n\t\t\t\t\tthis.vars[name].update = function(evt) {\n\t\t\t\t\t\tMavo.Functions[name] = update(evt);\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tvars: {\n\t\t\t\t\"$now\": {\n\t\t\t\t\tobserve: function() {\n\t\t\t\t\t\tvar callback = () => {\n\t\t\t\t\t\t\t_.special.update.call(this);\n\t\t\t\t\t\t\tthis.timer = requestAnimationFrame(callback);\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tthis.timer = requestAnimationFrame(callback);\n\t\t\t\t\t},\n\t\t\t\t\tunobserve: function() {\n\t\t\t\t\t\tcancelAnimationFrame(this.timer);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n});\n\n_.special.event(\"$mouse\", {\n\ttype: \"mousemove\",\n\tupdate: function(evt) {\n\t\treturn {x: evt.clientX, y: evt.clientY};\n\t}\n});\n\n_.special.event(\"$hash\", {\n\ttype: \"hashchange\",\n\ttarget: window\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(mavo) {\n\t\tthis.mavo = mavo;\n\t\tthis.active = true;\n\n\t\tthis.expressions = [];\n\n\t\tvar syntax = Mavo.Expression.Syntax.create(this.mavo.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\tthis.traverse(this.mavo.element, undefined, syntax);\n\n\t\tthis.scheduled = {};\n\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tthis.expressions = [];\n\n\t\t\t// Watch changes and update value\n\t\t\tdocument.documentElement.addEventListener(\"mv-change\", evt => {\n\t\t\t\tif (!this.active) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar scheduled = this.scheduled[evt.action] = this.scheduled[evt.action] || new Set();\n\n\t\t\t\tif (evt.node.template) {\n\t\t\t\t\t// Throttle events in collections and events from other Mavos\n\t\t\t\t\tif (!scheduled.has(evt.node.template)) {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tscheduled.delete(evt.node.template);\n\t\t\t\t\t\t\tthis.update(evt);\n\t\t\t\t\t\t}, _.THROTTLE);\n\n\t\t\t\t\t\tscheduled.add(evt.node.template);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\trequestAnimationFrame(() => this.update(evt));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.update();\n\t\t});\n\t},\n\n\tupdate: function(evt) {\n\t\tif (!this.active) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar root, rootObject;\n\n\t\tif (evt instanceof Mavo.Node) {\n\t\t\trootObject = evt;\n\t\t\tevt = null;\n\t\t}\n\t\telse if (evt instanceof Element) {\n\t\t\troot = evt.closest(Mavo.selectors.item);\n\t\t\trootObject = Mavo.Node.get(root);\n\t\t\tevt = null;\n\t\t}\n\t\telse {\n\t\t\trootObject = this.mavo.root;\n\t\t}\n\n\t\tvar allData = rootObject.getData({live: true});\n\n\t\trootObject.walk((obj, path) => {\n\t\t\tif (obj.expressions && obj.expressions.length && !obj.isDeleted()) {\n\t\t\t\tvar data = $.value(allData, ...path);\n\n\t\t\t\tobj.expressions.forEach(et => {\n\t\t\t\t\tif (et.changedBy(evt)) {\n\t\t\t\t\t\tet.update(data, evt);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\textract: function(node, attribute, path, syntax = Mavo.Expression.Syntax.default) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif (attribute && _.directives.indexOf(attribute.name) > -1 ||\n\t\t    syntax !== Mavo.Expression.Syntax.ESCAPE && syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tif (path === undefined) {\n\t\t\t\tpath = Mavo.elementPath(node.closest(Mavo.selectors.item), node);\n\t\t\t}\n\n\t\t\tthis.expressions.push(new Mavo.DOMExpression({\n\t\t\t\tnode, syntax, path,\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = [], syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\telse {\n\t\t\tnode.normalize();\n\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (Mavo.is(\"item\", node)) {\n\t\t\t\tpath = [];\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\n\t\t\tvar index = -1, offset = 0;\n\n\t\t\tif (!node.matches(\"script:not([mv-expressions])\")) {\n\t\t\t\t$$(node.childNodes).forEach(child => {\n\t\t\t\t\tif (child.nodeType == 1) {\n\t\t\t\t\t\toffset = 0;\n\t\t\t\t\t\tindex++;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\toffset++;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (child.nodeType == 1 || child.nodeType == 3) {\n\t\t\t\t\t\tvar segment = offset > 0? `${index}.${offset}` : index;\n\t\t\t\t\t\tthis.traverse(child, [...path || [], segment], syntax);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: [\n\t\t\t\"mv-value\"\n\t\t],\n\n\t\tTHROTTLE: 50,\n\n\t\tdirective: function(name, o) {\n\t\t\t_.directives.push(name);\n\t\t\tMavo.attributes.push(name);\n\t\t\tMavo.Plugins.register(name, o);\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","// mv-if plugin\n(function($, $$) {\n\nMavo.Expressions.directive(\"mv-if\", {\n\textend: {\n\t\t\"Primitive\": {\n\t\t\tlive: {\n\t\t\t\t\"hidden\": function(value) {\n\t\t\t\t\tif (this._hidden !== value) {\n\t\t\t\t\t\tthis._hidden = value;\n\t\t\t\t\t\tthis.dataChanged();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t\"DOMExpression\": {\n\t\t\tlazy: {\n\t\t\t\t\"childProperties\": function() {\n\t\t\t\t\tvar properties = $$(Mavo.selectors.property, this.element)\n\t\t\t\t\t\t\t\t\t.filter(el => el.closest(\"[mv-if]\") == this.element)\n\t\t\t\t\t\t\t\t\t.map(el => Mavo.Node.get(el));\n\n\t\t\t\t\t// When the element is detached, datachange events from properties\n\t\t\t\t\t// do not propagate up to the group so expressions do not recalculate.\n\t\t\t\t\t// We must do this manually.\n\t\t\t\t\tthis.element.addEventListener(\"mv-change\", evt => {\n\t\t\t\t\t\t// Cannot redispatch synchronously [why??]\n\t\t\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t\t\tif (!this.element.parentNode) { // out of the DOM?\n\t\t\t\t\t\t\tthis.item.element.dispatchEvent(evt);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\treturn properties;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\thooks: {\n\t\t\"domexpression-init-start\": function() {\n\t\t\tif (this.attribute != \"mv-if\") {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.expression = this.element.getAttribute(\"mv-if\");\n\t\t\tthis.parsed = [new Mavo.Expression(this.expression)];\n\t\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\n\t\t\tthis.parentIf = this.element.parentNode && Mavo.DOMExpression.search(this.element.parentNode.closest(\"[mv-if]\"), \"mv-if\");\n\n\t\t\tif (this.parentIf) {\n\t\t\t\tthis.parentIf.childIfs = (this.parentIf.childIfs || new Set()).add(this);\n\t\t\t}\n\t\t},\n\t\t\"domexpression-update-end\": function() {\n\t\t\tif (this.attribute != \"mv-if\") {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar value = this.value[0];\n\t\t\tvar oldValue = this.oldValue[0];\n\n\t\t\t// Only apply this after the tree is built, otherwise any properties inside the if will go missing!\n\t\t\tthis.item.mavo.treeBuilt.then(() => {\n\t\t\t\tif (this.parentIf) {\n\t\t\t\t\tvar parentValue = this.parentIf.value[0];\n\t\t\t\t\tthis.value[0] = value = value && parentValue;\n\t\t\t\t}\n\n\t\t\t\tif (parentValue !== false) { // If parent if was false, it wouldn't matter whether this is in the DOM or not\n\t\t\t\t\tif (value) {\n\t\t\t\t\t\t// Is removed from the DOM and needs to get back\n\t\t\t\t\t\tMavo.revocably.add(this.element);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.element.parentNode) {\n\t\t\t\t\t\t// Is in the DOM and needs to be removed\n\t\t\t\t\t\tMavo.revocably.remove(this.element, \"mv-if\");\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (value !== oldValue) {\n\t\t\t\t\t// Mark any properties inside as hidden or not\n\t\t\t\t\tif (this.childProperties) {\n\t\t\t\t\t\tthis.childProperties.forEach(property => property.hidden = !value);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.childIfs) {\n\t\t\t\t\t\tthis.childIfs.forEach(childIf => childIf.update());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t\"unit-isdatanull\": function(env) {\n\t\t\tenv.result = env.result || (this.hidden && env.options.live);\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","/**\n * Functions available inside Mavo expressions\n */\n\n(function($, val) {\n\nvar _ = Mavo.Functions = {\n\toperators: {\n\t\t\"=\": \"eq\"\n\t},\n\n\t/**\n\t * Get a property of an object. Used by the . operator to prevent TypeErrors\n\t */\n\tget: function(obj, property, meta = {}) {\n\t\tproperty = meta.property = val(property);\n\t\tvar canonicalProperty = Mavo.getCanonicalProperty(obj, property);\n\n\t\tif (canonicalProperty !== undefined) {\n\t\t\tmeta.property = canonicalProperty;\n\t\t\tvar ret = obj[canonicalProperty];\n\n\t\t\tif (typeof ret === \"function\" && ret.name.indexOf(\"bound\") !== 0) {\n\t\t\t\treturn ret.bind(obj);\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (Array.isArray(obj) && property && isNaN(property)) {\n\t\t\t// Array and non-numerical property\n\t\t\tvar eqIndex = property.indexOf(\"=\");\n\n\t\t\tif (eqIndex > -1) {\n\t\t\t\t// Property query\n\t\t\t\tmeta.query = {\n\t\t\t\t\tproperty: property.slice(0, eqIndex),\n\t\t\t\t\tvalue: property.slice(eqIndex + 1)\n\t\t\t\t};\n\n\t\t\t\tmeta.property = [];\n\n\t\t\t\tret = obj.filter((e, i) => {\n\t\t\t\t\tvar passes = _.get(e, meta.query.property) == meta.query.value;\n\n\t\t\t\t\tif (passes) {\n\t\t\t\t\t\tmeta.property.push(i);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn passes;\n\t\t\t\t});\n\n\t\t\t\tif (meta.query.property == \"id\") {\n\t\t\t\t\tmeta.property = meta.property[0];\n\t\t\t\t\tret = ret[0];\n\t\t\t\t}\n\n\t\t\t\tif (ret === undefined) {\n\t\t\t\t\tmeta.property = obj.length;\n\t\t\t\t}\n\t\t\t\telse if (ret.length === 0) {\n\t\t\t\t\tmeta.property = [obj.length];\n\t\t\t\t}\n\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Not a property query, get from objects inside\n\t\t\t\t// TODO meta.property = ??\n\t\t\t\treturn obj.map(e => _.get(e, property));\n\t\t\t}\n\t\t}\n\n\t\t// Not found :(\n\t\treturn null;\n\t},\n\n\turl: (id, url = location) => {\n\t\tif (id === undefined) {\n\t\t\treturn location.href;\n\t\t}\n\n\t\tif (id) {\n\t\t\tid = str(id).replace(/[^\\w-:]/g);\n\n\t\t\tvar ret = url.search.match(RegExp(`[?&]${id}(?:=(.+?))?(?=$|&)`))\n\t\t\t       || url.pathname.match(RegExp(`(?:^|\\\\/)${id}\\\\/([^\\\\/]*)`));\n\t\t}\n\n\t\treturn ret === null || !id? null : decodeURIComponent(ret[1]) || \"\";\n\t},\n\n\t// TODO return first/last non-null?\n\tfirst: arr => arr && arr[0] || \"\",\n\tlast: arr => arr && arr[arr.length - 1] || \"\",\n\n\tunique: function(arr) {\n\t\tif (!Array.isArray(arr)) {\n\t\t\treturn arr;\n\t\t}\n\n\t\treturn [...new Set(arr.map(val))];\n\t},\n\n\t/**\n\t * Do two arrays or sets have a non-empty intersection?\n\t * @return {Boolean}\n\t */\n\tintersects: function(arr1, arr2) {\n\t\tif (arr1 && arr2) {\n\t\t\tvar set2 = new Set(arr2.map? arr2.map(val): arr2);\n\t\t\tarr1 = arr1.map? arr1.map(val) : [...arr1];\n\n\t\t\treturn !arr1.every(el => !set2.has(el));\n\t\t}\n\t},\n\n\t/*********************\n\t * Number functions\n\t *********************/\n\n\t/**\n\t * Aggregate sum\n\t */\n\tsum: function(array) {\n\t\treturn $u.numbers(array, arguments).reduce((prev, current) => {\n\t\t\treturn +prev + (+current || 0);\n\t\t}, 0);\n\t},\n\n\t/**\n\t * Average of an array of numbers\n\t */\n\taverage: function(array) {\n\t\tarray = $u.numbers(array, arguments);\n\n\t\treturn array.length && _.sum(array) / array.length;\n\t},\n\n\t/**\n\t * Min of an array of numbers\n\t */\n\tmin: function(array) {\n\t\treturn Math.min(...$u.numbers(array, arguments));\n\t},\n\n\t/**\n\t * Max of an array of numbers\n\t */\n\tmax: function(array) {\n\t\treturn Math.max(...$u.numbers(array, arguments));\n\t},\n\n\tcount: function(array) {\n\t\treturn Mavo.toArray(array).filter(a => !empty(a)).length;\n\t},\n\n\treverse: function(array) {\n\t\treturn Mavo.toArray(array).slice().reverse();\n\t},\n\n\tround: function(num, decimals) {\n\t\tif (not(num) || not(decimals) || !isFinite(num)) {\n\t\t\treturn Math.round(num);\n\t\t}\n\n\t\treturn +num.toLocaleString(\"en-US\", {\n\t\t\tuseGrouping: false,\n\t\t\tmaximumFractionDigits: decimals\n\t\t});\n\t},\n\n\tordinal: function(num) {\n\t\tif (empty(num)) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\tif (ord < 10 || ord > 20) {\n\t\t\tvar ord = [\"th\", \"st\", \"nd\", \"th\"][num % 10];\n\t\t}\n\n\t\treturn ord || \"th\";\n\t},\n\n\tiff: function(condition, iftrue=condition, iffalse=\"\") {\n\t\tif (Array.isArray(condition)) {\n\t\t\treturn condition.map((c, i) => {\n\t\t\t\tvar ret = val(c)? iftrue : iffalse;\n\n\t\t\t\treturn Array.isArray(ret)? ret[Math.min(i, ret.length - 1)] : ret;\n\t\t\t});\n\t\t}\n\n\t\treturn val(condition)? iftrue : iffalse;\n\t},\n\n\t/*********************\n\t * String functions\n\t *********************/\n\n\t/**\n\t * Replace all occurences of a string with another string\n\t */\n\treplace: function(haystack, needle, replacement = \"\", iterations = 1) {\n\t\tif (Array.isArray(haystack)) {\n\t\t\treturn haystack.map(item => _.replace(item, needle, replacement));\n\t\t}\n\n\t\t// Simple string replacement\n\t\tvar needleRegex = RegExp(Mavo.escapeRegExp(needle), \"g\");\n\t\tvar ret = haystack, prev;\n\t\tvar counter = 0;\n\n\t\twhile (ret != prev && (counter++ < iterations)) {\n\t\t\tprev = ret;\n\t\t\tret = ret.replace(needleRegex, replacement);\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tlen: text => str(text).length,\n\n\t/**\n\t * Case insensitive search\n\t */\n\tsearch: (haystack, needle) => haystack && needle? str(haystack).toLowerCase().indexOf((needle + \"\").toLowerCase()) : -1,\n\n\tstarts: (haystack, needle) => _.search(str(haystack), str(needle)) === 0,\n\tends: function(haystack, needle) {\n\t\t[haystack, needle] = [str(haystack), str(needle)];\n\n\t\tvar i = _.search(haystack, needle);\n\t\treturn  i > -1 && i === haystack.length - needle.length;\n\t},\n\n\tjoin: function(array, glue) {\n\t\treturn Mavo.toArray(array).join(str(glue));\n\t},\n\n\tidify: function(readable) {\n\t\treturn str(readable)\n\t\t\t.normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\") // Convert accented letters to ASCII\n\t\t\t.replace(/[^\\w\\s-]/g, \"\") // Remove remaining non-ASCII characters\n\t\t\t.trim().replace(/\\s+/g, \"-\") // Convert whitespace to hyphens\n\t\t\t.toLowerCase();\n\t},\n\n\t// Convert an identifier to readable text that can be used as a label\n\treadable: function (identifier) {\n\t\t// Is it camelCase?\n\t\treturn str(identifier)\n\t\t\t\t.replace(/([a-z])([A-Z])(?=[a-z])/g, ($0, $1, $2) => $1 + \" \" + $2.toLowerCase()) // camelCase?\n\t\t\t\t.replace(/([a-z0-9])[_\\/-](?=[a-z0-9])/g, \"$1 \") // Hyphen-separated / Underscore_separated?\n\t\t\t\t.replace(/^[a-z]/, $0 => $0.toUpperCase()); // Capitalize\n\t},\n\n\tuppercase: text => str(text).toUpperCase(),\n\tlowercase: text => str(text).toLowerCase(),\n\n\tfrom: (haystack, needle) => _.between(haystack, needle),\n\tfromlast: (haystack, needle) => _.between(haystack, needle, \"\", true),\n\tto: (haystack, needle) => _.between(haystack, \"\", needle),\n\ttofirst: (haystack, needle) => _.between(haystack, \"\", needle, true),\n\n\tbetween: (haystack, from, to, tight) => {\n\t\t[haystack, from, to] = [str(haystack), str(from), str(to)];\n\n\t\tvar i1 = from? haystack[tight? \"lastIndexOf\" : \"indexOf\"](from) : -1;\n\t\tvar i2 = haystack[tight? \"indexOf\" : \"lastIndexOf\"](to);\n\n\t\tif (from && i1 === -1 || i2 === -1) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\treturn haystack.slice(i1 + 1, i2 === -1 || !to? haystack.length : i2);\n\t},\n\n\tfilename: url => Mavo.match(new URL(str(url), Mavo.base).pathname, /[^/]+?$/),\n\n\tjson: data => Mavo.safeToJSON(data),\n\n\t/*********************\n\t * Date functions\n\t *********************/\n\n\tget $now() {\n\t\treturn new Date();\n\t},\n\n\t$startup: new Date(), // Like $now, but doesn't update\n\n\tget $today() {\n\t\treturn _.date(new Date());\n\t},\n\n\tyear: getDateComponent(\"year\"),\n\tmonth: getDateComponent(\"month\"),\n\tday: getDateComponent(\"day\"),\n\tweekday: getDateComponent(\"weekday\"),\n\thour: getDateComponent(\"hour\"),\n\tminute: getDateComponent(\"minute\"),\n\tsecond: getDateComponent(\"second\"),\n\tms: getDateComponent(\"ms\"),\n\n\tdate: date => {\n\t\tdate = $u.date(date);\n\n\t\treturn date? `${_.year(date)}-${_.month(date).twodigit}-${_.day(date).twodigit}` : \"\";\n\t},\n\ttime: date => {\n\t\tdate = $u.date(date);\n\n\t\treturn date? `${_.hour(date).twodigit}:${_.minute(date).twodigit}:${_.second(date).twodigit}` : \"\";\n\t},\n\n\tminutes: seconds => Math.floor(Math.abs(seconds) / 60) || 0,\n\thours: seconds => Math.floor(Math.abs(seconds) / 3600) || 0,\n\tdays: seconds => Math.floor(Math.abs(seconds) / 86400) || 0,\n\tweeks: seconds => Math.floor(Math.abs(seconds) / 604800) || 0,\n\tmonths: seconds => Math.floor(Math.abs(seconds) / (30.4368 * 86400)) || 0,\n\tyears: seconds => Math.floor(Math.abs(seconds) / (30.4368 * 86400 * 12)) || 0,\n\n\tlocalTimezone: -(new Date()).getTimezoneOffset(),\n\n\t// Log to the console and return\n\tlog: (...args) => {\n\t\tconsole.log(...args.map(val));\n\t\treturn args[0];\n\t},\n\n\t// Other special variables (some updated via events)\n\t$mouse: {x: 0, y: 0},\n\n\tget $hash() {\n\t\treturn location.hash.slice(1);\n\t},\n\n\t// \"Private\" helpers\n\tutil: {\n\t\tnumbers: function(array, args) {\n\t\t\tarray = Array.isArray(array)? array : (args? $$(args) : [array]);\n\n\t\t\treturn array.filter(number => !isNaN(number) && val(number) !== \"\" && val(number) !== null).map(n => +n);\n\t\t},\n\n\t\tfixDateString: function(date) {\n\t\t\tdate = date.trim();\n\n\t\t\tvar hasDate = /^\\d{4}-\\d{2}(-\\d{2})?/.test(date);\n\t\t\tvar hasTime = date.indexOf(\":\") > -1;\n\n\t\t\tif (!hasDate && !hasTime) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// Fix up time format\n\t\t\tif (!hasDate) {\n\t\t\t\t// No date, add todays\n\t\t\t\tdate = _.$today + \" \" + date;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Only year-month, add day\n\t\t\t\tdate = date.replace(/^(\\d{4}-\\d{2})(?!-\\d{2})/, \"$1-01\");\n\t\t\t}\n\n\t\t\tif (!hasTime) {\n\t\t\t\t// Add a time if one doesn't exist\n\t\t\t\tdate += \"T00:00:00\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Make sure time starts with T, due to Safari bug\n\t\t\t\tdate = date.replace(/\\-(\\d{2})\\s+(?=\\d{2}:)/, \"-$1T\");\n\t\t\t}\n\n\t\t\t// Remove all whitespace\n\t\t\tdate = date.replace(/\\s+/g, \"\");\n\n\t\t\treturn date;\n\t\t},\n\n\t\tdate: function(date) {\n\t\t\tdate = val(date);\n\n\t\t\tif (!date) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif ($.type(date) === \"string\") {\n\t\t\t\tdate = $u.fixDateString(date);\n\n\t\t\t\tif (date === null) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tvar timezone = Mavo.match(date, /[+-]\\d{2}:?\\d{2}|Z$/);\n\n\t\t\t\tif (timezone) {\n\t\t\t\t\t// parse as ISO format\n\t\t\t\t\tdate = new Date(date);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// construct date in local timezone\n\t\t\t\t\tvar fields = date.match(/\\d+/g);\n\t\t\t\t\tdate = new Date(\n\t\t\t\t\t\t// year, month, date,\n\t\t\t\t\t\tfields[0], (fields[1] || 1) - 1, fields[2] || 1,\n\t\t\t\t\t\t// hours, minutes, seconds, milliseconds,\n\t\t\t\t\t\tfields[3] || 0, fields[4] || 0, fields[5] || 0, fields[6] || 0\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdate = new Date(date);\n\t\t\t}\n\n\t\t\tif (isNaN(date)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn date;\n\t\t}\n\t}\n};\n\nvar $u = _.util;\n\n// Make function names case insensitive\n_._Trap = self.Proxy? new Proxy(_, {\n\tget: (functions, property) => {\n\t\tvar ret;\n\n\t\tvar canonicalProperty = Mavo.getCanonicalProperty(functions, property)\n\t\t                     || Mavo.getCanonicalProperty(Math, property);\n\n\t\tif (canonicalProperty) {\n\t\t\tret = functions[canonicalProperty];\n\n\t\t\tif (ret === undefined) {\n\t\t\t\tret = Math[canonicalProperty];\n\t\t\t}\n\t\t}\n\n\t\tif (ret !== undefined) {\n\t\t\tif (typeof ret === \"function\") {\n\t\t\t\t// For when function names are used as unquoted strings, see #160\n\t\t\t\tret.toString = () => property;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t}\n\n\t\t// Still not found? Maybe it's a global\n\t\tif (property in self) {\n\t\t\treturn self[property];\n\t\t}\n\n\t\t// Prevent undefined at all costs\n\t\treturn property;\n\t},\n\n\t// Super ugly hack, but otherwise data is not\n\t// the local variable it should be, but the string \"data\"\n\t// so all property lookups fail.\n\thas: (functions, property) => property != \"data\"\n}) : _;\n\n/**\n * Private helper methods\n */\n\n// Convert argument to string\nfunction str(str = \"\") {\n\tstr = val(str);\n\treturn !str && str !== 0? \"\" : str + \"\";\n}\n\nfunction empty(v) {\n\tv = Mavo.value(v);\n\treturn v === null || v === false || v === \"\";\n}\n\nfunction not(v) {\n\treturn !val(v);\n}\n\nfunction toLocaleString(date, options) {\n\tvar ret = date.toLocaleString(Mavo.locale, options);\n\n\tret = ret.replace(/\\u200e/g, \"\"); // Stupid Edge bug\n\n\treturn ret;\n}\n\nvar numeric = {\n\tyear: d => d.getFullYear(),\n\tmonth: d => d.getMonth() + 1,\n\tday: d => d.getDate(),\n\tweekday: d => d.getDay() || 7,\n\thour: d => d.getHours(),\n\tminute: d => d.getMinutes(),\n\tsecond: d => d.getSeconds(),\n\tms: d => d.getMilliseconds()\n};\n\nfunction getDateComponent(component) {\n\treturn function(date) {\n\t\tdate = $u.date(date);\n\n\t\tif (!date) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\tvar ret = numeric[component](date);\n\n\t\t// We don't want years to be formatted like 2,017!\n\t\tret = new self[component == \"year\"? \"String\" : \"Number\"](ret);\n\n\t\tif (component == \"month\" || component == \"weekday\") {\n\t\t\tret.name = toLocaleString(date, {[component]: \"long\"});\n\t\t\tret.shortname = toLocaleString(date, {[component]: \"short\"});\n\t\t}\n\n\t\tif (component != \"weekday\") {\n\t\t\tret.twodigit = (ret % 100 < 10? \"0\" : \"\") + ret % 100;\n\t\t}\n\n\t\treturn ret;\n\t};\n}\n\n})(Bliss, Mavo.value);\n","(function($, val, $u) {\n\nvar _ = Mavo.Script = {\n\taddUnaryOperator: function(name, o) {\n\t\tif (o.symbol) {\n\t\t\t// Build map of symbols to function names for easy rewriting\n\t\t\tMavo.toArray(o.symbol).forEach(symbol => {\n\t\t\t\tMavo.Script.unarySymbols[symbol] = name;\n\t\t\t\tjsep.addUnaryOp(symbol);\n\t\t\t});\n\t\t}\n\n\t\treturn Mavo.Functions[name] = operand => Array.isArray(operand)? operand.map(val).map(o.scalar) : o.scalar(val(operand));\n\t},\n\n\t/**\n\t * Extend a scalar operator to arrays, or arrays and scalars\n\t * The operation between arrays is applied element-wise.\n\t * The operation operation between a scalar and an array will result in\n\t * the operation being applied between the scalar and every array element.\n\t */\n\taddBinaryOperator: function(name, o) {\n\t\tif (o.symbol) {\n\t\t\t// Build map of symbols to function names for easy rewriting\n\t\t\tMavo.toArray(o.symbol).forEach(symbol => {\n\t\t\t\tMavo.Script.symbols[symbol] = name;\n\n\t\t\t\tif (o.precedence) {\n\t\t\t\t\tjsep.addBinaryOp(symbol, o.precedence);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\to.identity = o.identity === undefined? 0 : o.identity;\n\n\t\treturn Mavo.Functions[name] = o.code || function(...operands) {\n\t\t\tif (operands.length === 1) {\n\t\t\t\tif (Array.isArray(operands[0])) {\n\t\t\t\t\t// Operand is an array of operands, expand it out\n\t\t\t\t\toperands = [...operands[0]];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!o.raw) {\n\t\t\t\toperands = operands.map(val);\n\t\t\t}\n\n\t\t\tvar prev = o.logical? o.identity : operands[0], result;\n\n\t\t\tfor (let i = 1; i < operands.length; i++) {\n\t\t\t\tlet a = o.logical? operands[i - 1] : prev;\n\t\t\t\tlet b = operands[i];\n\n\t\t\t\tif (Array.isArray(b)) {\n\t\t\t\t\tif (typeof o.identity == \"number\") {\n\t\t\t\t\t\tb = $u.numbers(b);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (Array.isArray(a)) {\n\t\t\t\t\t\tresult = [\n\t\t\t\t\t\t\t...b.map((n, i) => o.scalar(a[i] === undefined? o.identity : a[i], n)),\n\t\t\t\t\t\t\t...a.slice(b.length)\n\t\t\t\t\t\t];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tresult = b.map(n => o.scalar(a, n));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (Array.isArray(a)) {\n\t\t\t\t\tresult = a.map(n => o.scalar(n, b));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tresult = o.scalar(a, b);\n\t\t\t\t}\n\n\t\t\t\tif (o.reduce) {\n\t\t\t\t\tprev = o.reduce(prev, result, a, b);\n\t\t\t\t}\n\t\t\t\telse if (o.logical) {\n\t\t\t\t\tprev = prev && result;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tprev = result;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn prev;\n\t\t};\n\t},\n\n\t/**\n\t * Mapping of operator symbols to function name.\n\t * Populated via addOperator() and addLogicalOperator()\n\t */\n\tsymbols: {},\n\tunarySymbols: {},\n\n\tgetOperatorName: (op, unary) => Mavo.Script[unary? \"unarySymbols\" : \"symbols\"][op] || op,\n\n\t/**\n\t * Operations for elements and scalars.\n\t * Operations between arrays happen element-wise.\n\t * Operations between a scalar and an array will result in the operation being performed between the scalar and every array element.\n\t * Ordered by precedence (higher to lower)\n\t * @param scalar {Function} The operation between two scalars\n\t * @param identity The operations identity element. Defaults to 0.\n\t */\n\toperators: {\n\t\t\"not\": {\n\t\t\tsymbol: \"!\",\n\t\t\tscalar: a => !a\n\t\t},\n\t\t\"multiply\": {\n\t\t\tscalar: (a, b) => a * b,\n\t\t\tidentity: 1,\n\t\t\tsymbol: \"*\"\n\t\t},\n\t\t\"divide\": {\n\t\t\tscalar: (a, b) => a / b,\n\t\t\tidentity: 1,\n\t\t\tsymbol: \"/\"\n\t\t},\n\t\t\"add\": {\n\t\t\tscalar: (a, b) => +a + +b,\n\t\t\tsymbol: \"+\"\n\t\t},\n\t\t\"plus\": {\n\t\t\tscalar: a => +a,\n\t\t\tsymbol: \"+\"\n\t\t},\n\t\t\"subtract\": {\n\t\t\tscalar: (a, b) => {\n\t\t\t\tif (isNaN(a) || isNaN(b)) {\n\t\t\t\t\t// Handle dates\n\t\t\t\t\tvar dateA = $u.date(a), dateB = $u.date(b);\n\n\t\t\t\t\tif (dateA && dateB) {\n\t\t\t\t\t\treturn (dateA - dateB)/1000;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn a - b;\n\t\t\t},\n\t\t\tsymbol: \"-\"\n\t\t},\n\t\t\"minus\": {\n\t\t\tscalar: a => -a,\n\t\t\tsymbol: \"-\"\n\t\t},\n\t\t\"mod\": {\n\t\t\tscalar: (a, b) => {\n\t\t\t\tvar ret = a % b;\n\t\t\t\tret += ret < 0? b : 0;\n\t\t\t\treturn ret;\n\t\t\t},\n\t\t\tsymbol: \"mod\",\n\t\t\tprecedence: 6\n\t\t},\n\t\t\"lte\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a <= b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \"<=\"\n\t\t},\n\t\t\"lt\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a < b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \"<\"\n\t\t},\n\t\t\"gte\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a >= b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \">=\"\n\t\t},\n\t\t\"gt\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a > b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \">\"\n\t\t},\n\t\t\"eq\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => a == b,\n\t\t\tsymbol: [\"=\", \"==\"],\n\t\t\tidentity: true,\n\t\t\tprecedence: 6\n\t\t},\n\t\t\"neq\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => a != b,\n\t\t\tsymbol: [\"!=\"],\n\t\t\tidentity: true\n\t\t},\n\t\t\"and\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => !!a && !!b,\n\t\t\tidentity: true,\n\t\t\tsymbol: [\"&&\", \"and\"],\n\t\t\tprecedence: 2\n\t\t},\n\t\t\"or\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => a || b,\n\t\t\treduce: (p, r) => p || r,\n\t\t\tidentity: false,\n\t\t\tsymbol: [\"||\", \"or\"],\n\t\t\tprecedence: 2\n\t\t},\n\t\t\"concatenate\": {\n\t\t\tsymbol: \"&\",\n\t\t\tidentity: \"\",\n\t\t\tscalar: (a, b) => \"\" + (a || \"\") + (b || \"\"),\n\t\t\tprecedence: 10\n\t\t},\n\t\t// Filter is listed here because it's an easy way to handle multiple\n\t\t// array filters without having to code it\n\t\t\"filter\": {\n\t\t\tscalar: (a, b) => val(b)? a : null,\n\t\t\traw: true\n\t\t}\n\t},\n\n\tgetNumericalOperands: function(a, b) {\n\t\tif (isNaN(a) || isNaN(b)) {\n\t\t\t// Try comparing as dates\n\t\t\tvar da = $u.date(a), db = $u.date(b);\n\n\t\t\tif (da && db) {\n\t\t\t\t// Both valid dates\n\t\t\t\treturn [da, db];\n\t\t\t}\n\t\t}\n\n\t\treturn [a, b];\n\t},\n\n\t/**\n\t * These serializers transform the AST into JS\n\t */\n\tserializers: {\n\t\t\"BinaryExpression\": node => `${_.serialize(node.left)} ${node.operator} ${_.serialize(node.right)}`,\n\t\t\"UnaryExpression\": node => `${node.operator}${_.serialize(node.argument)}`,\n\t\t\"CallExpression\": node => `${_.serialize(node.callee)}(${node.arguments.map(_.serialize).join(\", \")})`,\n\t\t\"ConditionalExpression\": node => `${_.serialize(node.test)}? ${_.serialize(node.consequent)} : ${_.serialize(node.alternate)}`,\n\t\t\"MemberExpression\": node => {\n\t\t\tvar property = node.computed? _.serialize(node.property) : `\"${node.property.name}\"`;\n\t\t\treturn `get(${_.serialize(node.object)}, ${property})`;\n\t\t},\n\t\t\"ArrayExpression\": node => `[${node.elements.map(_.serialize).join(\", \")}]`,\n\t\t\"Literal\": node => node.raw,\n\t\t\"Identifier\": node => node.name,\n\t\t\"ThisExpression\": node => \"this\",\n\t\t\"Compound\": node => node.body.map(_.serialize).join(\" \")\n\t},\n\n\t/**\n\t * These are run before the serializers and transform the expression to support MavoScript\n\t */\n\ttransformations: {\n\t\t\"BinaryExpression\": node => {\n\t\t\tlet name = Mavo.Script.getOperatorName(node.operator);\n\n\t\t\t// Flatten same operator calls\n\t\t\tvar nodeLeft = node;\n\t\t\tvar args = [];\n\n\t\t\tdo {\n\t\t\t\targs.unshift(nodeLeft.right);\n\t\t\t\tnodeLeft = nodeLeft.left;\n\t\t\t} while (Mavo.Script.getOperatorName(nodeLeft.operator) === name);\n\n\t\t\targs.unshift(nodeLeft);\n\n\t\t\tif (args.length > 1) {\n\t\t\t\treturn `${name}(${args.map(_.serialize).join(\", \")})`;\n\t\t\t}\n\t\t},\n\t\t\"UnaryExpression\": node => {\n\t\t\tvar name = Mavo.Script.getOperatorName(node.operator, true);\n\n\t\t\tif (name) {\n\t\t\t\treturn `${name}(${_.serialize(node.argument)})`;\n\t\t\t}\n\t\t},\n\t\t\"CallExpression\": node => {\n\t\t\tif (node.callee.type == \"Identifier\") {\n\t\t\t\tif (node.callee.name == \"if\") {\n\t\t\t\t\tnode.callee.name = \"iff\";\n\t\t\t\t}\n\n\t\t\t\tnode.callee.name = \"Mavo.Functions._Trap.\" + node.callee.name;\n\t\t\t}\n\t\t}\n\t},\n\n\tserialize: node => {\n\t\tvar ret = _.transformations[node.type] && _.transformations[node.type](node);\n\n\t\tif (ret !== undefined) {\n\t\t\treturn ret;\n\t\t}\n\n\t\treturn _.serializers[node.type](node);\n\t},\n\n\trewrite: function(code) {\n\t\ttry {\n\t\t\treturn _.serialize(_.parse(code));\n\t\t}\n\t\tcatch (e) {\n\t\t\t// Parsing as MavoScript failed, falling back to plain JS\n\t\t\treturn code;\n\t\t}\n\t},\n\n\tcompile: function(code) {\n\t\tcode = _.rewrite(code);\n\n\t\treturn new Function(\"data\", `with(Mavo.Functions._Trap)\n\t\t\t\twith (data || {}) {\n\t\t\t\t\treturn (${code});\n\t\t\t\t}`);\n\t},\n\n\tparse: self.jsep,\n};\n\n_.serializers.LogicalExpression = _.serializers.BinaryExpression;\n_.transformations.LogicalExpression = _.transformations.BinaryExpression;\n\nfor (let name in Mavo.Script.operators) {\n\tlet details = Mavo.Script.operators[name];\n\n\tif (details.scalar.length < 2) {\n\t\tMavo.Script.addUnaryOperator(name, details);\n\t}\n\telse {\n\t\tMavo.Script.addBinaryOperator(name, details);\n\t}\n}\n\nvar aliases = {\n\taverage: \"avg\",\n\tiff: \"iff IF\",\n\tmultiply: \"mult product\",\n\tdivide: \"div\",\n\tlt: \"smaller\",\n\tgt: \"larger bigger\",\n\teq: \"equal equality\",\n\tordinal: \"th\"\n};\n\nfor (let name in aliases) {\n\taliases[name].split(/\\s+/g).forEach(alias => Mavo.Functions[alias] = Mavo.Functions[name]);\n}\n\n})(Bliss, Mavo.value, Mavo.Functions.util);\n","(function($, $$) {\n\nvar _ = Mavo.Backend.register($.Class({\n\textends: Mavo.Backend,\n\tid: \"Dropbox\",\n\tconstructor: function() {\n\t\tthis.permissions.on([\"login\", \"read\"]);\n\n\t\tthis.key = this.mavo.element.getAttribute(\"mv-dropbox-key\") || \"2mx6061p054bpbp\";\n\n\t\tthis.login(true);\n\t},\n\n\tupdate: function(url, o) {\n\t\tthis.super.update.call(this, url, o);\n\n\t\tthis.url = _.fixShareURL(this.url);\n\t},\n\n\tupload: function(file, path) {\n\t\tpath = this.path.replace(/[^/]+$/, \"\") + path;\n\n\t\treturn this.put(file, path).then(fileInfo => this.getURL(path));\n\t},\n\n\tgetURL: function(path) {\n\t\treturn this.request(\"sharing/create_shared_link_with_settings\", {path}, \"POST\")\n\t\t\t.then(shareInfo => _.fixShareURL(shareInfo.url));\n\t},\n\n\t/**\n\t * Saves a file to the backend.\n\t * @param {Object} file - An object with name & data keys\n\t * @return {Promise} A promise that resolves when the file is saved.\n\t */\n\tput: function(serialized, path = this.path, o = {}) {\n\t\treturn this.request(\"https://content.dropboxapi.com/2/files/upload\", serialized, \"POST\", {\n\t\t\theaders: {\n\t\t\t\t\"Dropbox-API-Arg\": JSON.stringify({\n\t\t\t\t\tpath,\n\t\t\t\t\tmode: \"overwrite\"\n\t\t\t\t}),\n\t\t\t\t\"Content-Type\": \"application/octet-stream\"\n\t\t\t}\n\t\t});\n\t},\n\n\toAuthParams: () => `&redirect_uri=${encodeURIComponent(\"https://auth.mavo.io\")}&response_type=code`,\n\n\tgetUser: function() {\n\t\tif (this.user) {\n\t\t\treturn Promise.resolve(this.user);\n\t\t}\n\n\t\treturn this.request(\"users/get_current_account\", \"null\", \"POST\")\n\t\t\t.then(info => {\n\t\t\t\tthis.user = {\n\t\t\t\t\tusername: info.email,\n\t\t\t\t\tname: info.name.display_name,\n\t\t\t\t\tavatar: info.profile_photo_url,\n\t\t\t\t\tinfo\n\t\t\t\t};\n\n\t\t\t\t$.fire(this.mavo.element, \"mv-login\", { backend: this });\n\t\t\t});\n\t},\n\n\tlogin: function(passive) {\n\t\treturn this.oAuthenticate(passive)\n\t\t\t.then(() => this.getUser())\n\t\t\t.then(u => {\n\t\t\t\tif (this.user) {\n\t\t\t\t\tthis.permissions.logout = true;\n\n\t\t\t\t\t// Check if can actually edit the file\n\t\t\t\t\tthis.request(\"sharing/get_shared_link_metadata\", {\n\t\t\t\t\t\t\"url\": this.source\n\t\t\t\t\t}, \"POST\").then(info => {\n\t\t\t\t\t\tthis.path = info.path_lower;\n\t\t\t\t\t\tthis.permissions.on([\"edit\", \"save\"]);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t},\n\n\tlogout: function() {\n\t\treturn this.oAuthLogout();\n\t},\n\n\tstatic: {\n\t\tapiDomain: \"https://api.dropboxapi.com/2/\",\n\t\toAuth: \"https://www.dropbox.com/oauth2/authorize\",\n\n\t\ttest: function(url) {\n\t\t\turl = new URL(url, Mavo.base);\n\t\t\treturn /dropbox.com/.test(url.host);\n\t\t},\n\n\t\t// Transform the dropbox shared URL into something raw and CORS-enabled\n\t\tfixShareURL: url => {\n\t\t\turl = new URL(url, Mavo.base);\n\t\t\turl.hostname = \"dl.dropboxusercontent.com\";\n\t\t\turl.search = url.search.replace(/\\bdl=0|^$/, \"raw=1\");\n\t\t\treturn url;\n\t\t}\n\t}\n}));\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Backend.register($.Class({\n\textends: Mavo.Backend,\n\tid: \"Github\",\n\tconstructor: function() {\n\t\tthis.permissions.on([\"login\", \"read\"]);\n\n\t\tthis.key = this.mavo.element.getAttribute(\"mv-github-key\") || \"7e08e016048000bc594e\";\n\n\t\t// Extract info for username, repo, branch, filepath from URL\n\t\tvar extension = this.format.constructor.extensions[0] || \".json\";\n\n\t\tthis.defaults = {\n\t\t\trepo: \"mv-data\",\n\t\t\tfilename: `${this.mavo.id}${extension}`\n\t\t};\n\n\t\tthis.info = _.parseURL(this.source, this.defaults);\n\t\t$.extend(this, this.info);\n\n\t\tthis.login(true);\n\t},\n\n\tupdate: function(url, o) {\n\t\tthis.super.update.call(this, url, o);\n\n\t\tthis.info = _.parseURL(this.source, this.defaults);\n\t\t$.extend(this, this.info);\n\t},\n\n\tget: function(url) {\n\t\tif (this.isAuthenticated() || !this.path || url) {\n\t\t\t// Authenticated or raw API call\n\t\t\tvar info = url? _.parseURL(url) : this.info;\n\n\t\t\tif (info.apiData) {\n\t\t\t\t// GraphQL\n\t\t\t\treturn this.request(info.apiCall, info.apiData, \"POST\")\n\t\t\t\t\t.then(response => {\n\t\t\t\t\t\tif (response.errors && response.errors.length) {\n\t\t\t\t\t\t\treturn Promise.reject(response.errors.map(x => x.message).join(\"\\n\"));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn response.data;\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.request(info.apiCall, null, \"GET\", {\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"Accept\": \"application/vnd.github.squirrel-girl-preview\"\n\t\t\t\t\t}\n\t\t\t\t}).then(response => Promise.resolve(info.repo? _.atob(response.content) : response));\n\t\t}\n\t\telse {\n\t\t\t// Unauthenticated, use simple GET request to avoid rate limit\n\t\t\turl = new URL(`https://raw.githubusercontent.com/${this.username}/${this.repo}/${this.branch || \"master\"}/${this.path}`);\n\t\t\turl.searchParams.set(\"timestamp\", Date.now()); // ensure fresh copy\n\n\t\t\treturn $.fetch(url.href).then(xhr => Promise.resolve(xhr.responseText), () => Promise.resolve(null));\n\t\t}\n\t},\n\n\tupload: function(file, path = this.path) {\n\t\treturn Mavo.readFile(file).then(dataURL => {\n\t\t\t\tvar base64 = dataURL.slice(5); // remove data:\n\t\t\t\tvar media = base64.match(/^\\w+\\/[\\w+]+/)[0];\n\t\t\t\tbase64 = base64.replace(RegExp(`^${media}(;base64)?,`), \"\");\n\t\t\t\tpath = this.path.replace(/[^/]+$/, \"\") + path; // make upload path relative to existing path\n\n\t\t\t\treturn this.put(base64, path, {isEncoded: true});\n\t\t\t})\n\t\t\t.then(fileInfo => this.getURL(path, fileInfo.commit.sha));\n\t},\n\n\t/**\n\t * Saves a file to the backend.\n\t * @param {String} serialized - Serialized data\n\t * @param {String} path - Optional file path\n\t * @return {Promise} A promise that resolves when the file is saved.\n\t */\n\tput: function(serialized, path = this.path, o = {}) {\n\t\tif (!path) {\n\t\t\t// Raw API calls are read-only for now\n\t\t\treturn;\n\t\t}\n\n\t\tvar repoCall = `repos/${this.username}/${this.repo}`;\n\t\tvar fileCall = `${repoCall}/contents/${path}`;\n\t\tvar commitPrefix = this.mavo.element.getAttribute(\"mv-github-commit-prefix\") || \"\";\n\n\t\t// Create repo if it doesnt exist\n\t\tvar repoInfo = this.repoInfo || this.request(\"user/repos\", {name: this.repo}, \"POST\").then(repoInfo => this.repoInfo = repoInfo);\n\n\t\tserialized = o.isEncoded? serialized : _.btoa(serialized);\n\n\t\treturn Promise.resolve(repoInfo)\n\t\t\t.then(repoInfo => {\n\t\t\t\tif (!this.canPush()) {\n\t\t\t\t\t// Does not have permission to commit, create a fork\n\t\t\t\t\treturn this.request(`${repoCall}/forks`, {name: this.repo}, \"POST\")\n\t\t\t\t\t\t.then(forkInfo => {\n\t\t\t\t\t\t\tfileCall = `repos/${forkInfo.full_name}/contents/${path}`;\n\t\t\t\t\t\t\treturn this.forkInfo = forkInfo;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(forkInfo => {\n\t\t\t\t\t\t\t// Ensure that fork is created (they take a while)\n\t\t\t\t\t\t\tvar timeout;\n\t\t\t\t\t\t\tvar test = (resolve, reject) => {\n\t\t\t\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t\t\t\t\tthis.request(`repos/${forkInfo.full_name}/commits`, {until: \"1970-01-01T00:00:00Z\"}, \"HEAD\")\n\t\t\t\t\t\t\t\t\t.then(x => {\n\t\t\t\t\t\t\t\t\t\tresolve(forkInfo);\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.catch(x => {\n\t\t\t\t\t\t\t\t\t\t// Try again after 1 second\n\t\t\t\t\t\t\t\t\t\ttimeout = setTimeout(test, 1000);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\treturn new Promise(test);\n\t\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn repoInfo;\n\t\t\t})\n\t\t\t.then(repoInfo => {\n\t\t\t\treturn this.request(fileCall, {\n\t\t\t\t\tref: this.branch\n\t\t\t\t}).then(fileInfo => this.request(fileCall, {\n\t\t\t\t\tmessage: commitPrefix + this.mavo._(\"gh-updated-file\", {name: fileInfo.name || \"file\"}),\n\t\t\t\t\tcontent: serialized,\n\t\t\t\t\tbranch: this.branch,\n\t\t\t\t\tsha: fileInfo.sha\n\t\t\t\t}, \"PUT\"), xhr => {\n\t\t\t\t\tif (xhr.status == 404) {\n\t\t\t\t\t\t// File does not exist, create it\n\t\t\t\t\t\treturn this.request(fileCall, {\n\t\t\t\t\t\t\tmessage: commitPrefix + \"Created file\",\n\t\t\t\t\t\t\tcontent: serialized,\n\t\t\t\t\t\t\tbranch: this.branch\n\t\t\t\t\t\t}, \"PUT\");\n\t\t\t\t\t}\n\n\t\t\t\t\treturn xhr;\n\t\t\t\t});\n\t\t\t})\n\t\t\t.then(fileInfo => {\n\t\t\t\tif (this.forkInfo) {\n\t\t\t\t\t// We saved in a fork, do we have a pull request?\n\t\t\t\t\tthis.request(`repos/${this.username}/${this.repo}/pulls`, {\n\t\t\t\t\t\thead: `${this.user.username}:${this.branch}`,\n\t\t\t\t\t\tbase: this.branch\n\t\t\t\t\t}).then(prs => {\n\t\t\t\t\t\tthis.pullRequest(prs[0]);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn fileInfo;\n\t\t\t});\n\t},\n\n\tpullRequest: function(existing) {\n\t\tvar previewURL = new URL(location);\n\t\tpreviewURL.searchParams.set(this.mavo.id + \"-storage\", `https://github.com/${this.forkInfo.full_name}/${this.path}`);\n\t\tvar message = this.mavo._(\"gh-edit-suggestion-saved-in-profile\", {previewURL});\n\n\t\tif (this.notice) {\n\t\t\tthis.notice.close();\n\t\t}\n\n\t\tif (existing) {\n\t\t\t// We already have a pull request, ask about closing it\n\t\t\tthis.notice = this.mavo.message(`${message}\n\t\t\t\t${this.mavo._(\"gh-edit-suggestion-notreviewed\")}\n\t\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t\t<button class=\"mv-danger\">${this.mavo._(\"gh-edit-suggestion-revoke\")}</button>\n\t\t\t\t</form>`, {\n\t\t\t\t\tclasses: \"mv-inline\",\n\t\t\t\t\tdismiss: [\"button\", \"submit\"]\n\t\t\t\t});\n\n\t\t\tthis.notice.closed.then(form => {\n\t\t\t\tif (!form) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Close PR\n\t\t\t\tthis.request(`repos/${this.username}/${this.repo}/pulls/${existing.number}`, {\n\t\t\t\t\tstate: \"closed\"\n\t\t\t\t}, \"POST\").then(prInfo => {\n\t\t\t\t\tnew Mavo.UI.Message(this.mavo, `<a href=\"${prInfo.html_url}\">${this.mavo._(\"gh-edit-suggestion-cancelled\")}</a>`, {\n\t\t\t\t\t\tdismiss: [\"button\", \"timeout\"]\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.pullRequest();\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\t// Ask about creating a PR\n\t\t\tthis.notice = this.mavo.message(`${message}\n\t\t\t\t${this.mavo._(\"gh-edit-suggestion-instructions\")}\n\t\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t\t<textarea name=\"edits\" class=\"mv-autosize\" placeholder=\"${this.mavo._(\"gh-edit-suggestion-reason-placeholder\")}\"></textarea>\n\t\t\t\t\t<button>${this.mavo._(\"gh-edit-suggestion-send\")}</button>\n\t\t\t\t</form>`, {\n\t\t\t\t\tclasses: \"mv-inline\",\n\t\t\t\t\tdismiss: [\"button\", \"submit\"]\n\t\t\t\t});\n\n\t\t\tthis.notice.closed.then(form => {\n\t\t\t\tif (!form) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// We want to send a pull request\n\t\t\t\tthis.request(`repos/${this.username}/${this.repo}/pulls`, {\n\t\t\t\t\ttitle: this.mavo._(\"gh-edit-suggestion-title\"),\n\t\t\t\t\tbody: this.mavo._(\"gh-edit-suggestion-body\", {\n\t\t\t\t\t\tdescription: form.elements.edits.value,\n\t\t\t\t\t\tpreviewURL\n\t\t\t\t\t}),\n\t\t\t\t\thead: `${this.user.username}:${this.branch}`,\n\t\t\t\t\tbase: this.branch\n\t\t\t\t}, \"POST\").then(prInfo => {\n\t\t\t\t\tnew Mavo.UI.Message(this.mavo, `<a href=\"${prInfo.html_url}\">${this.mavo._(\"gh-edit-suggestion-sent\")}</a>`, {\n\t\t\t\t\t\tdismiss: [\"button\", \"timeout\"]\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.pullRequest(prInfo);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t},\n\n\tlogin: function(passive) {\n\t\treturn this.oAuthenticate(passive)\n\t\t\t.then(() => this.getUser())\n\t\t\t.catch(xhr => {\n\t\t\t\tif (xhr.status == 401) {\n\t\t\t\t\t// Unauthorized. Access token we have is invalid, discard it\n\t\t\t\t\tthis.logout();\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(u => {\n\t\t\t\tif (this.user) {\n\t\t\t\t\tthis.permissions.on(\"logout\");\n\n\t\t\t\t\tif (this.info.path) {\n\t\t\t\t\t\tthis.permissions.on([\"edit\", \"save\"]);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.repo) {\n\t\t\t\t\t\treturn this.request(`repos/${this.username}/${this.repo}`)\n\t\t\t\t\t\t\t.then(repoInfo => {\n\t\t\t\t\t\t\t\tif (this.branch === undefined) {\n\t\t\t\t\t\t\t\t\tthis.branch = repoInfo.default_branch;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn this.repoInfo = repoInfo;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t},\n\n\tcanPush: function() {\n\t\tif (this.repoInfo) {\n\t\t\treturn this.repoInfo.permissions.push;\n\t\t}\n\n\t\t// Repo does not exist so we can't check permissions\n\t\t// Just check if authenticated user is the same as our URL username\n\t\treturn this.user && this.user.username.toLowerCase() == this.username.toLowerCase();\n\t},\n\n\toAuthParams: () => \"&scope=repo,gist\",\n\n\tlogout: function() {\n\t\treturn this.oAuthLogout().then(() => {\n\t\t\tthis.user = null;\n\t\t});\n\t},\n\n\tgetUser: function() {\n\t\tif (this.user) {\n\t\t\treturn Promise.resolve(this.user);\n\t\t}\n\n\t\treturn this.request(\"user\").then(info => {\n\t\t\tthis.user = {\n\t\t\t\tusername: info.login,\n\t\t\t\tname: info.name || info.login,\n\t\t\t\tavatar: info.avatar_url,\n\t\t\t\turl: \"https://github.com/\" + info.login,\n\t\t\t\tinfo\n\t\t\t};\n\n\t\t\t$.fire(this.mavo.element, \"mv-login\", { backend: this });\n\t\t});\n\t},\n\n\tgetURL: function(path = this.path, sha) {\n\t\tvar repoInfo = this.forkInfo || this.repoInfo;\n\t\tvar repo = repoInfo.full_name;\n\t\tpath = path.replace(/ /g, \"%20\");\n\n\t\trepoInfo.pagesInfo = repoInfo.pagesInfo || this.request(`repos/${repo}/pages`, {}, \"GET\", {\n\t\t\theaders: {\n\t\t\t\t\"Accept\": \"application/vnd.github.mister-fantastic-preview+json\"\n\t\t\t}\n\t\t});\n\n\t\treturn repoInfo.pagesInfo.then(pagesInfo => pagesInfo.html_url + path)\n\t\t\t.catch(xhr => {\n\t\t\t\t// No Github Pages, return rawgit URL\n\t\t\t\tif (sha) {\n\t\t\t\t\treturn `https://cdn.rawgit.com/${repo}/${sha}/${path}`;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn `https://rawgit.com/${repo}/${this.branch}/${path}`;\n\t\t\t\t}\n\t\t\t});\n\t},\n\n\tstatic: {\n\t\tapiDomain: \"https://api.github.com/\",\n\t\toAuth: \"https://github.com/login/oauth/authorize\",\n\n\t\ttest: function(url) {\n\t\t\turl = new URL(url, Mavo.base);\n\t\t\treturn /\\bgithub.com|raw.githubusercontent.com/.test(url.host);\n\t\t},\n\n\t\t/**\n\t\t * Parse Github URLs, return username, repo, branch, path\n\t\t */\n\t\tparseURL: function(source, defaults = {}) {\n\t\t\tvar ret = {};\n\t\t\tvar url = new URL(source, Mavo.base);\n\t\t\tvar path = url.pathname.slice(1).split(\"/\");\n\n\t\t\tret.username = path.shift();\n\t\t\tret.repo = path.shift() || defaults.repo;\n\n\t\t\tif (/raw.githubusercontent.com$/.test(url.host)) {\n\t\t\t\tret.branch = path.shift();\n\t\t\t}\n\t\t\telse if (/api.github.com$/.test(url.host)) {\n\t\t\t\t// Raw API call\n\t\t\t\tvar apiCall = url.pathname.slice(1) + url.search;\n\t\t\t\tvar data = Mavo.Functions.from(source, \"#\"); // url.* drops line breaks\n\n\t\t\t\treturn {\n\t\t\t\t\tapiCall,\n\t\t\t\t\tapiData: apiCall == \"graphql\"? {query: data} : data\n\t\t\t\t};\n\t\t\t}\n\t\t\telse if (path[0] == \"blob\") {\n\t\t\t\tpath.shift();\n\t\t\t\tret.branch = path.shift();\n\t\t\t}\n\n\t\t\tvar lastSegment = path[path.length - 1];\n\n\t\t\tif (/\\.\\w+$/.test(lastSegment)) {\n\t\t\t\tret.filename = lastSegment;\n\t\t\t\tpath.splice(path.length - 1, 1);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret.filename = defaults.filename;\n\t\t\t}\n\n\t\t\tret.filepath = path.join(\"/\") || defaults.filepath || \"\";\n\t\t\tret.path = (ret.filepath? ret.filepath + \"/\" : \"\") + ret.filename;\n\n\t\t\tret.apiCall = `repos/${ret.username}/${ret.repo}/contents/${ret.path}`;\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t// Fix atob() and btoa() so they can handle Unicode\n\t\tbtoa: str => btoa(unescape(encodeURIComponent(str))),\n\t\tatob: str => decodeURIComponent(escape(window.atob(str)))\n\t}\n}));\n\n})(Bliss, Bliss.$);\n"]}